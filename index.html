<!doctype html><html lang="en">
 <head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
  <title>URL Fragment Text Directives</title>
  <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
  <link href="https://www.w3.org/StyleSheets/TR/2021/cg-draft" rel="stylesheet">
  <meta content="Bikeshed version 82ce88815, updated Thu Sep 7 16:33:55 2023 -0700" name="generator">
  <link href="https://wicg.github.io/scroll-to-text-fragment/" rel="canonical">
<style>
  .monkeypatch {
    color: grey;
  }

  .monkeypatch .diff {
    color: var(--text);
  }
</style>
<style>/* Boilerplate: style-autolinks */
.css.css, .property.property, .descriptor.descriptor {
    color: var(--a-normal-text);
    font-size: inherit;
    font-family: inherit;
}
.css::before, .property::before, .descriptor::before {
    content: "‘";
}
.css::after, .property::after, .descriptor::after {
    content: "’";
}
.property, .descriptor {
    /* Don't wrap property and descriptor names */
    white-space: nowrap;
}
.type { /* CSS value <type> */
    font-style: italic;
}
pre .property::before, pre .property::after {
    content: "";
}
[data-link-type="property"]::before,
[data-link-type="propdesc"]::before,
[data-link-type="descriptor"]::before,
[data-link-type="value"]::before,
[data-link-type="function"]::before,
[data-link-type="at-rule"]::before,
[data-link-type="selector"]::before,
[data-link-type="maybe"]::before {
    content: "‘";
}
[data-link-type="property"]::after,
[data-link-type="propdesc"]::after,
[data-link-type="descriptor"]::after,
[data-link-type="value"]::after,
[data-link-type="function"]::after,
[data-link-type="at-rule"]::after,
[data-link-type="selector"]::after,
[data-link-type="maybe"]::after {
    content: "’";
}

[data-link-type].production::before,
[data-link-type].production::after,
.prod [data-link-type]::before,
.prod [data-link-type]::after {
    content: "";
}

[data-link-type=element],
[data-link-type=element-attr] {
    font-family: Menlo, Consolas, "DejaVu Sans Mono", monospace;
    font-size: .9em;
}
[data-link-type=element]::before { content: "<" }
[data-link-type=element]::after  { content: ">" }

[data-link-type=biblio] {
    white-space: pre;
}

@media (prefers-color-scheme: dark) {
    :root {
        --selflink-text: black;
        --selflink-bg: silver;
        --selflink-hover-text: white;
    }
}
</style>
<style>/* Boilerplate: style-colors */

/* Any --*-text not paired with a --*-bg is assumed to have a transparent bg */
:root {
    color-scheme: light dark;

    --text: black;
    --bg: white;

    --unofficial-watermark: url(https://www.w3.org/StyleSheets/TR/2016/logos/UD-watermark);

    --logo-bg: #1a5e9a;
    --logo-active-bg: #c00;
    --logo-text: white;

    --tocnav-normal-text: #707070;
    --tocnav-normal-bg: var(--bg);
    --tocnav-hover-text: var(--tocnav-normal-text);
    --tocnav-hover-bg: #f8f8f8;
    --tocnav-active-text: #c00;
    --tocnav-active-bg: var(--tocnav-normal-bg);

    --tocsidebar-text: var(--text);
    --tocsidebar-bg: #f7f8f9;
    --tocsidebar-shadow: rgba(0,0,0,.1);
    --tocsidebar-heading-text: hsla(203,20%,40%,.7);

    --toclink-text: var(--text);
    --toclink-underline: #3980b5;
    --toclink-visited-text: var(--toclink-text);
    --toclink-visited-underline: #054572;

    --heading-text: #005a9c;

    --hr-text: var(--text);

    --algo-border: #def;

    --del-text: red;
    --del-bg: transparent;
    --ins-text: #080;
    --ins-bg: transparent;

    --a-normal-text: #034575;
    --a-normal-underline: #bbb;
    --a-visited-text: var(--a-normal-text);
    --a-visited-underline: #707070;
    --a-hover-bg: rgba(75%, 75%, 75%, .25);
    --a-active-text: #c00;
    --a-active-underline: #c00;

    --blockquote-border: silver;
    --blockquote-bg: transparent;
    --blockquote-text: currentcolor;

    --issue-border: #e05252;
    --issue-bg: #fbe9e9;
    --issue-text: var(--text);
    --issueheading-text: #831616;

    --example-border: #e0cb52;
    --example-bg: #fcfaee;
    --example-text: var(--text);
    --exampleheading-text: #574b0f;

    --note-border: #52e052;
    --note-bg: #e9fbe9;
    --note-text: var(--text);
    --noteheading-text: hsl(120, 70%, 30%);
    --notesummary-underline: silver;

    --assertion-border: #aaa;
    --assertion-bg: #eee;
    --assertion-text: black;

    --advisement-border: orange;
    --advisement-bg: #fec;
    --advisement-text: var(--text);
    --advisementheading-text: #b35f00;

    --warning-border: red;
    --warning-bg: hsla(40,100%,50%,0.95);
    --warning-text: var(--text);

    --amendment-border: #330099;
    --amendment-bg: #F5F0FF;
    --amendment-text: var(--text);
    --amendmentheading-text: #220066;

    --def-border: #8ccbf2;
    --def-bg: #def;
    --def-text: var(--text);
    --defrow-border: #bbd7e9;

    --datacell-border: silver;

    --indexinfo-text: #707070;

    --indextable-hover-text: black;
    --indextable-hover-bg: #f7f8f9;

    --outdatedspec-bg: rgba(0, 0, 0, .5);
    --outdatedspec-text: black;
    --outdated-bg: maroon;
    --outdated-text: white;
    --outdated-shadow: red;

    --editedrec-bg: darkorange;
}

@media (prefers-color-scheme: dark) {
    :root {
        --text: #ddd;
        --bg: black;

        --unofficial-watermark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cg fill='%23100808' transform='translate(200 200) rotate(-45) translate(-200 -200)' stroke='%23100808' stroke-width='3'%3E%3Ctext x='50%25' y='220' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EUNOFFICIAL%3C/text%3E%3Ctext x='50%25' y='305' style='font: bold 70px sans-serif; text-anchor: middle; letter-spacing: 6px;'%3EDRAFT%3C/text%3E%3C/g%3E%3C/svg%3E");

        --logo-bg: #1a5e9a;
        --logo-active-bg: #c00;
        --logo-text: white;

        --tocnav-normal-text: #999;
        --tocnav-normal-bg: var(--bg);
        --tocnav-hover-text: var(--tocnav-normal-text);
        --tocnav-hover-bg: #080808;
        --tocnav-active-text: #f44;
        --tocnav-active-bg: var(--tocnav-normal-bg);

        --tocsidebar-text: var(--text);
        --tocsidebar-bg: #080808;
        --tocsidebar-shadow: rgba(255,255,255,.1);
        --tocsidebar-heading-text: hsla(203,20%,40%,.7);

        --toclink-text: var(--text);
        --toclink-underline: #6af;
        --toclink-visited-text: var(--toclink-text);
        --toclink-visited-underline: #054572;

        --heading-text: #8af;

        --hr-text: var(--text);

        --algo-border: #456;

        --del-text: #f44;
        --del-bg: transparent;
        --ins-text: #4a4;
        --ins-bg: transparent;

        --a-normal-text: #6af;
        --a-normal-underline: #555;
        --a-visited-text: var(--a-normal-text);
        --a-visited-underline: var(--a-normal-underline);
        --a-hover-bg: rgba(25%, 25%, 25%, .2);
        --a-active-text: #f44;
        --a-active-underline: var(--a-active-text);

        --borderedblock-bg: rgba(255, 255, 255, .05);

        --blockquote-border: silver;
        --blockquote-bg: var(--borderedblock-bg);
        --blockquote-text: currentcolor;

        --issue-border: #e05252;
        --issue-bg: var(--borderedblock-bg);
        --issue-text: var(--text);
        --issueheading-text: hsl(0deg, 70%, 70%);

        --example-border: hsl(50deg, 90%, 60%);
        --example-bg: var(--borderedblock-bg);
        --example-text: var(--text);
        --exampleheading-text: hsl(50deg, 70%, 70%);

        --note-border: hsl(120deg, 100%, 35%);
        --note-bg: var(--borderedblock-bg);
        --note-text: var(--text);
        --noteheading-text: hsl(120, 70%, 70%);
        --notesummary-underline: silver;

        --assertion-border: #444;
        --assertion-bg: var(--borderedblock-bg);
        --assertion-text: var(--text);

        --advisement-border: orange;
        --advisement-bg: #222218;
        --advisement-text: var(--text);
        --advisementheading-text: #f84;

        --warning-border: red;
        --warning-bg: hsla(40,100%,20%,0.95);
        --warning-text: var(--text);

        --amendment-border: #330099;
        --amendment-bg: #080010;
        --amendment-text: var(--text);
        --amendmentheading-text: #cc00ff;

        --def-border: #8ccbf2;
        --def-bg: #080818;
        --def-text: var(--text);
        --defrow-border: #136;

        --datacell-border: silver;

        --indexinfo-text: #aaa;

        --indextable-hover-text: var(--text);
        --indextable-hover-bg: #181818;

        --outdatedspec-bg: rgba(255, 255, 255, .5);
        --outdatedspec-text: black;
        --outdated-bg: maroon;
        --outdated-text: white;
        --outdated-shadow: red;

        --editedrec-bg: darkorange;
    }
    /* In case a transparent-bg image doesn't expect to be on a dark bg,
       which is quite common in practice... */
    img { background: white; }
}
</style>
<style>/* Boilerplate: style-counters */
body {
    counter-reset: example figure issue;
}
.issue {
    counter-increment: issue;
}
.issue:not(.no-marker)::before {
    content: "Issue " counter(issue);
}

.example {
    counter-increment: example;
}
.example:not(.no-marker)::before {
    content: "Example " counter(example);
}
.invalid.example:not(.no-marker)::before,
.illegal.example:not(.no-marker)::before {
    content: "Invalid Example" counter(example);
}

figcaption {
    counter-increment: figure;
}
figcaption:not(.no-marker)::before {
    content: "Figure " counter(figure) " ";
}
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    white-space: pre;
    display: inline-block;
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: .5em;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
}

.dfn-paneled[role="button"] { cursor: pointer; }
</style>
<style>/* Boilerplate: style-dfn-panel */
:root {
    --dfnpanel-bg: #ddd;
    --dfnpanel-text: var(--text);
}
@media (prefers-color-scheme: dark) {
    :root {
        --dfnpanel-bg: #222;
        --dfnpanel-text: var(--text);
    }
}
.dfn-panel {
    position: absolute;
    z-index: 35;
    width: 20em;
    width: 300px;
    height: auto;
    max-height: 500px;
    overflow: auto;
    padding: 0.5em 0.75em;
    font: small Helvetica Neue, sans-serif, Droid Sans Fallback;
    background: var(--dfnpanel-bg);
    color: var(--dfnpanel-text);
    border: outset 0.2em;
    white-space: normal; /* in case it's moved into a pre */
}
.dfn-panel:not(.on) { display: none; }
.dfn-panel * { margin: 0; padding: 0; text-indent: 0; }
.dfn-panel > b { display: block; }
.dfn-panel a { color: var(--dfnpanel-text); }
.dfn-panel a:not(:hover) { text-decoration: none !important; border-bottom: none !important; }
.dfn-panel > b + b { margin-top: 0.25em; }
.dfn-panel ul { padding: 0 0 0 1em; list-style: none; }
.dfn-panel li a {
    white-space: pre;
    display: inline-block;
    max-width: calc(300px - 1.5em - 1em);
    overflow: hidden;
    text-overflow: ellipsis;
}

.dfn-panel.activated {
    display: inline-block;
    position: fixed;
    left: .5em;
    bottom: 2em;
    margin: 0 auto;
    max-width: calc(100vw - 1.5em - .4em - .5em);
    max-height: 30vh;
}

.dfn-paneled[role="button"] { cursor: pointer; }
</style>
<style>/* Boilerplate: style-issues */
a[href].issue-return {
    float: right;
    float: inline-end;
    color: var(--issueheading-text);
    font-weight: bold;
    text-decoration: none;
}
</style>
<style>/* Boilerplate: style-md-lists */
/* This is a weird hack for me not yet following the commonmark spec
   regarding paragraph and lists. */
[data-md] > :first-child {
    margin-top: 0;
}
[data-md] > :last-child {
    margin-bottom: 0;
}
</style>
<style>/* Boilerplate: style-selflinks */

:root {
    --selflink-text: white;
    --selflink-bg: gray;
    --selflink-hover-text: black;
}
.heading, .issue, .note, .example, li, dt {
    position: relative;
}
a.self-link {
    position: absolute;
    top: 0;
    left: calc(-1 * (3.5rem - 26px));
    width: calc(3.5rem - 26px);
    height: 2em;
    text-align: center;
    border: none;
    transition: opacity .2s;
    opacity: .5;
}
a.self-link:hover {
    opacity: 1;
}
.heading > a.self-link {
    font-size: 83%;
}
.example > a.self-link,
.note > a.self-link,
.issue > a.self-link {
    /* These blocks are overflow:auto, so positioning outside
       doesn't work. */
    left: auto;
    right: 0;
}
li > a.self-link {
    left: calc(-1 * (3.5rem - 26px) - 2em);
}
dfn > a.self-link {
    top: auto;
    left: auto;
    opacity: 0;
    width: 1.5em;
    height: 1.5em;
    background: var(--selflink-bg);
    color: var(--selflink-text);
    font-style: normal;
    transition: opacity .2s, background-color .2s, color .2s;
}
dfn:hover > a.self-link {
    opacity: 1;
}
dfn > a.self-link:hover {
    color: var(--selflink-hover-text);
}

a.self-link::before            { content: "¶"; }
.heading > a.self-link::before { content: "§"; }
dfn > a.self-link::before      { content: "#"; }
</style>
<style>/* Boilerplate: style-syntax-highlighting */

            pre.idl.highlight {
                background: var(--borderedblock-bg, var(--def-bg));
            }
            
</style>
<style>/* Boilerplate: style-syntax-highlighting */

code.highlight { padding: .1em; border-radius: .3em; }
pre.highlight, pre > code.highlight { display: block; padding: 1em; margin: .5em 0; overflow: auto; border-radius: 0; }

.highlight:not(.idl) { background: rgba(0, 0, 0, .03); }
c-[a] { color: #990055 } /* Keyword.Declaration */
c-[b] { color: #990055 } /* Keyword.Type */
c-[c] { color: #708090 } /* Comment */
c-[d] { color: #708090 } /* Comment.Multiline */
c-[e] { color: #0077aa } /* Name.Attribute */
c-[f] { color: #669900 } /* Name.Tag */
c-[g] { color: #222222 } /* Name.Variable */
c-[k] { color: #990055 } /* Keyword */
c-[l] { color: #000000 } /* Literal */
c-[m] { color: #000000 } /* Literal.Number */
c-[n] { color: #0077aa } /* Name */
c-[o] { color: #999999 } /* Operator */
c-[p] { color: #999999 } /* Punctuation */
c-[s] { color: #a67f59 } /* Literal.String */
c-[t] { color: #a67f59 } /* Literal.String.Single */
c-[u] { color: #a67f59 } /* Literal.String.Double */
c-[cp] { color: #708090 } /* Comment.Preproc */
c-[c1] { color: #708090 } /* Comment.Single */
c-[cs] { color: #708090 } /* Comment.Special */
c-[kc] { color: #990055 } /* Keyword.Constant */
c-[kn] { color: #990055 } /* Keyword.Namespace */
c-[kp] { color: #990055 } /* Keyword.Pseudo */
c-[kr] { color: #990055 } /* Keyword.Reserved */
c-[ld] { color: #000000 } /* Literal.Date */
c-[nc] { color: #0077aa } /* Name.Class */
c-[no] { color: #0077aa } /* Name.Constant */
c-[nd] { color: #0077aa } /* Name.Decorator */
c-[ni] { color: #0077aa } /* Name.Entity */
c-[ne] { color: #0077aa } /* Name.Exception */
c-[nf] { color: #0077aa } /* Name.Function */
c-[nl] { color: #0077aa } /* Name.Label */
c-[nn] { color: #0077aa } /* Name.Namespace */
c-[py] { color: #0077aa } /* Name.Property */
c-[ow] { color: #999999 } /* Operator.Word */
c-[mb] { color: #000000 } /* Literal.Number.Bin */
c-[mf] { color: #000000 } /* Literal.Number.Float */
c-[mh] { color: #000000 } /* Literal.Number.Hex */
c-[mi] { color: #000000 } /* Literal.Number.Integer */
c-[mo] { color: #000000 } /* Literal.Number.Oct */
c-[sb] { color: #a67f59 } /* Literal.String.Backtick */
c-[sc] { color: #a67f59 } /* Literal.String.Char */
c-[sd] { color: #a67f59 } /* Literal.String.Doc */
c-[se] { color: #a67f59 } /* Literal.String.Escape */
c-[sh] { color: #a67f59 } /* Literal.String.Heredoc */
c-[si] { color: #a67f59 } /* Literal.String.Interpol */
c-[sx] { color: #a67f59 } /* Literal.String.Other */
c-[sr] { color: #a67f59 } /* Literal.String.Regex */
c-[ss] { color: #a67f59 } /* Literal.String.Symbol */
c-[vc] { color: #0077aa } /* Name.Variable.Class */
c-[vg] { color: #0077aa } /* Name.Variable.Global */
c-[vi] { color: #0077aa } /* Name.Variable.Instance */
c-[il] { color: #000000 } /* Literal.Number.Integer.Long */


@media (prefers-color-scheme: dark) {
    .highlight:not(.idl) { background: rgba(255, 255, 255, .05); }

    c-[a] { color: #d33682 } /* Keyword.Declaration */
    c-[b] { color: #d33682 } /* Keyword.Type */
    c-[c] { color: #2aa198 } /* Comment */
    c-[d] { color: #2aa198 } /* Comment.Multiline */
    c-[e] { color: #268bd2 } /* Name.Attribute */
    c-[f] { color: #b58900 } /* Name.Tag */
    c-[g] { color: #cb4b16 } /* Name.Variable */
    c-[k] { color: #d33682 } /* Keyword */
    c-[l] { color: #657b83 } /* Literal */
    c-[m] { color: #657b83 } /* Literal.Number */
    c-[n] { color: #268bd2 } /* Name */
    c-[o] { color: #657b83 } /* Operator */
    c-[p] { color: #657b83 } /* Punctuation */
    c-[s] { color: #6c71c4 } /* Literal.String */
    c-[t] { color: #6c71c4 } /* Literal.String.Single */
    c-[u] { color: #6c71c4 } /* Literal.String.Double */
    c-[ch] { color: #2aa198 } /* Comment.Hashbang */
    c-[cp] { color: #2aa198 } /* Comment.Preproc */
    c-[cpf] { color: #2aa198 } /* Comment.PreprocFile */
    c-[c1] { color: #2aa198 } /* Comment.Single */
    c-[cs] { color: #2aa198 } /* Comment.Special */
    c-[kc] { color: #d33682 } /* Keyword.Constant */
    c-[kn] { color: #d33682 } /* Keyword.Namespace */
    c-[kp] { color: #d33682 } /* Keyword.Pseudo */
    c-[kr] { color: #d33682 } /* Keyword.Reserved */
    c-[ld] { color: #657b83 } /* Literal.Date */
    c-[nc] { color: #268bd2 } /* Name.Class */
    c-[no] { color: #268bd2 } /* Name.Constant */
    c-[nd] { color: #268bd2 } /* Name.Decorator */
    c-[ni] { color: #268bd2 } /* Name.Entity */
    c-[ne] { color: #268bd2 } /* Name.Exception */
    c-[nf] { color: #268bd2 } /* Name.Function */
    c-[nl] { color: #268bd2 } /* Name.Label */
    c-[nn] { color: #268bd2 } /* Name.Namespace */
    c-[py] { color: #268bd2 } /* Name.Property */
    c-[ow] { color: #657b83 } /* Operator.Word */
    c-[mb] { color: #657b83 } /* Literal.Number.Bin */
    c-[mf] { color: #657b83 } /* Literal.Number.Float */
    c-[mh] { color: #657b83 } /* Literal.Number.Hex */
    c-[mi] { color: #657b83 } /* Literal.Number.Integer */
    c-[mo] { color: #657b83 } /* Literal.Number.Oct */
    c-[sa] { color: #6c71c4 } /* Literal.String.Affix */
    c-[sb] { color: #6c71c4 } /* Literal.String.Backtick */
    c-[sc] { color: #6c71c4 } /* Literal.String.Char */
    c-[dl] { color: #6c71c4 } /* Literal.String.Delimiter */
    c-[sd] { color: #6c71c4 } /* Literal.String.Doc */
    c-[se] { color: #6c71c4 } /* Literal.String.Escape */
    c-[sh] { color: #6c71c4 } /* Literal.String.Heredoc */
    c-[si] { color: #6c71c4 } /* Literal.String.Interpol */
    c-[sx] { color: #6c71c4 } /* Literal.String.Other */
    c-[sr] { color: #6c71c4 } /* Literal.String.Regex */
    c-[ss] { color: #6c71c4 } /* Literal.String.Symbol */
    c-[fm] { color: #268bd2 } /* Name.Function.Magic */
    c-[vc] { color: #cb4b16 } /* Name.Variable.Class */
    c-[vg] { color: #cb4b16 } /* Name.Variable.Global */
    c-[vi] { color: #cb4b16 } /* Name.Variable.Instance */
    c-[vm] { color: #cb4b16 } /* Name.Variable.Magic */
    c-[il] { color: #657b83 } /* Literal.Number.Integer.Long */
}
</style>
<style>/* Boilerplate: style-var-click-highlighting */
/*
Colors were chosen in Lab using https://nixsensor.com/free-color-converter/
D50 2deg illuminant, L in [0,100], a and b in [-128, 128]
0 = lab(85,0,85)
1 = lab(85,80,30)
2 = lab(85,-40,40)
3 = lab(85,-50,0)
4 = lab(85,5,15)
5 = lab(85,-10,-50)
6 = lab(85,35,-15)
*/
var { cursor: pointer; }
var.selected0 { background-color: #F4D200; box-shadow: 0 0 0 2px #F4D200; }
var.selected1 { background-color: #FF87A2; box-shadow: 0 0 0 2px #FF87A2; }
var.selected2 { background-color: #96E885; box-shadow: 0 0 0 2px #96E885; }
var.selected3 { background-color: #3EEED2; box-shadow: 0 0 0 2px #3EEED2; }
var.selected4 { background-color: #EACFB6; box-shadow: 0 0 0 2px #EACFB6; }
var.selected5 { background-color: #82DDFF; box-shadow: 0 0 0 2px #82DDFF; }
var.selected6 { background-color: #FFBCF2; box-shadow: 0 0 0 2px #FFBCF2; }
</style>
<style>/* Boilerplate: style-wpt */
:root {
    --wpt-border: hsl(0, 0%, 60%);
    --wpt-bg: hsl(0, 0%, 95%);
    --wpt-text: var(--text);
    --wptheading-text: hsl(0, 0%, 30%);
}
@media (prefers-color-scheme: dark) {
    :root {
        --wpt-border: hsl(0, 0%, 30%);
        --wpt-bg: var(--borderedblock-bg);
        --wpt-text: var(--text);
        --wptheading-text: hsl(0, 0%, 60%);
    }
}
.wpt-tests-block {
    list-style: none;
    border-left: .5em solid var(--wpt-border);
    background: var(--wpt-bg);
    color: var(--wpt-text);
    margin: 1em auto;
    padding: .5em;
}
.wpt-tests-block summary {
    color: var(--wptheading-text);
    font-weight: normal;
    text-transform: uppercase;
}
.wpt-tests-block summary::marker{
    color: var(--wpt-border);
}
.wpt-tests-block summary:hover::marker{
    color: var(--wpt-text);
}
/*
   The only content  of a wpt test block in its closed state is the <summary>,
   which contains the word TESTS,
   and that is absolutely positioned.
   In that closed state, wpt test blocks are styled
   to have a top margin whose height is exactly equal
   to the height of the absolutely positioned <summary>,
   and no other background/padding/margin/border.
   The wpt test block elements will therefore allow the maring
   of the previous/next block elements
   to collapse through them;
   if this combined margin would be larger than its own top margin,
   it stays as is,
   and therefore the pre-existing vertical rhythm of the document is undisturbed.
   If that combined margin would be smaller, it is grown to that size.
   This means that the wpt test block ensures
   that there's always enough vertical space to insert the summary,
   without adding more than is needed.
*/
.wpt-tests-block:not([open]){
    padding: 0;
    border: none;
    background: none;
    font-size: 0.75em;
    line-height: 1;
    position: relative;
    margin: 1em 0 0;
}
.wpt-tests-block:not([open]) summary {
    position: absolute;
    right: 0;
    bottom: 0;
}
/*
   It is possible that both the last child of a block element
   and the block element itself
   would be annotated with a <wpt> block each.
   If the block element has a padding or a border,
   that's fine, but otherwise
   the bottom margin of the block and of its last child would collapse
   and both <wpt> elements would overlap, being both placed there.
   To avoid that, add 1px of padding to the <wpt> element annotating the last child
   to prevent the bottom margin of the block and of its last child from collapsing
   (and as much negative margin,
   as wel only want to prevent margin collapsing,
   but are not trying to actually take more space).
*/
.wpt-tests-block:not([open]):last-child {
    padding-bottom: 1px;
    margin-bottom: -1px;
}
/*
   Exception to the previous rule:
   don't do that in non-last list items,
   because it's not necessary,
   and would therefore consume more space than strictly needed.
   Lists must have list items as children, not <wpt> elements,
   so a <wpt> element cannot be a sibling of a list item,
   and the collision that the previous rule avoids cannot happen.
*/
li:not(:last-child) > .wpt-tests-block:not([open]):last-child,
dd:not(:last-child) > .wpt-tests-block:not([open]):last-child {
    padding-bottom: 0;
    margin-bottom: 0;
}
.wpt-tests-block:not([open]):not(:hover){
    opacity: 0.5;
}
.wpt-tests-list {
    list-style: none;
    display: grid;
    margin: 0;
    padding: 0;
    grid-template-columns: 1fr max-content auto auto;
    grid-column-gap: .5em;
}
.wpt-tests-block hr:last-child {
    display: none;
}
.wpt-test {
    display: contents;
}
.wpt-test > a {
    text-decoration: underline;
    border: none;
}
.wpt-test > .wpt-name { grid-column: 1; }
.wpt-test > .wpt-results { grid-column: 2; }
.wpt-test > .wpt-live { grid-column: 3; }
.wpt-test > .wpt-source { grid-column: 4; }

.wpt-test > .wpt-results {
    display: flex;
    gap: .1em;
}
.wpt-test .wpt-result {
    display: inline-block;
    height: 1em;
    width: 1em;
    border-radius: 50%;
    position: relative;
}
</style>
 <body class="h-entry">
  <div class="head">
   <p data-fill-with="logo"><a class="logo" href="https://www.w3.org/"> <img alt="W3C" height="48" src="https://www.w3.org/StyleSheets/TR/2021/logos/W3C" width="72"> </a> </p>
   <h1 class="p-name no-ref" id="title">URL Fragment Text Directives</h1>
   <p id="w3c-state"><a href="https://www.w3.org/standards/types#CG-DRAFT">Draft Community Group Report</a>, <time class="dt-updated" datetime="2023-11-22">22 November 2023</time></p>
   <div data-fill-with="spec-metadata">
    <dl>
     <dt>This version:
     <dd><a class="u-url" href="https://wicg.github.io/scroll-to-text-fragment/">https://wicg.github.io/scroll-to-text-fragment/</a>
     <dt>Issue Tracking:
     <dd><a href="https://github.com/wicg/scroll-to-text-fragment/issues/">GitHub</a>
     <dd><a href="#issues-index">Inline In Spec</a>
     <dt class="editor">Editors:
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:nburris@chromium.org">Nick Burris</a> (<a class="p-org org" href="https://www.google.com">Google</a>)
     <dd class="editor p-author h-card vcard"><a class="p-name fn u-email email" href="mailto:bokan@chromium.org">David Bokan</a> (<a class="p-org org" href="https://www.google.com">Google</a>)
     <dt>Test Suite:
     <dd class="wpt-overview"><a href="https://wpt.fyi/results/scroll-to-text-fragment/">https://wpt.fyi/results/scroll-to-text-fragment/</a>
    </dl>
   </div>
   <div data-fill-with="warning"></div>
   <p class="copyright" data-fill-with="copyright"><a href="https://www.w3.org/policies/#copyright">Copyright</a> © 2023 the Contributors to the URL Fragment Text Directives Specification, published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a> under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>.
A human-readable <a href="http://www.w3.org/community/about/agreements/cla-deed/">summary</a> is available. </p>
   <hr title="Separator for header">
  </div>
  <div class="p-summary" data-fill-with="abstract">
   <h2 class="no-num no-toc no-ref heading settled" id="abstract"><span class="content">Abstract</span></h2>
   <p>Text directives add support for specifying a text snippet in the URL

    fragment. When navigating to a URL with such a fragment, the user agent
    can quickly emphasise and/or bring it to the user’s attention.</p>
  </div>
  <div data-fill-with="at-risk"></div>
  <h2 class="no-num no-toc no-ref heading settled" id="status"><span class="content">Status of this document</span></h2>
  <div data-fill-with="status">
   <p> This specification was published by the <a href="https://www.w3.org/community/wicg/">Web Platform Incubator Community Group</a>.
  It is not a W3C Standard nor is it on the W3C Standards Track.

  Please note that under the <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a> there is a limited opt-out and other conditions apply.

  Learn more about <a href="http://www.w3.org/community/">W3C Community and Business Groups</a>. </p>
   <p></p>
  </div>
  <div data-fill-with="at-risk"></div>
  <nav data-fill-with="table-of-contents" id="toc">
   <h2 class="no-num no-toc no-ref" id="contents">Table of Contents</h2>
   <ol class="toc" role="directory">
    <li><a href="#infrastructure"><span class="secno">1</span> <span class="content">Infrastructure</span></a>
    <li>
     <a href="#introduction"><span class="secno">2</span> <span class="content">Introduction</span></a>
     <ol class="toc">
      <li>
       <a href="#use-cases"><span class="secno">2.1</span> <span class="content">Use cases</span></a>
       <ol class="toc">
        <li><a href="#web-text-references"><span class="secno">2.1.1</span> <span class="content">Web text references</span></a>
        <li><a href="#user-sharing"><span class="secno">2.1.2</span> <span class="content">User sharing</span></a>
       </ol>
     </ol>
    <li>
     <a href="#description"><span class="secno">3</span> <span class="content">Description</span></a>
     <ol class="toc">
      <li><a href="#indication"><span class="secno">3.1</span> <span class="content">Indication</span></a>
      <li>
       <a href="#syntax"><span class="secno">3.2</span> <span class="content">Syntax</span></a>
       <ol class="toc">
        <li><a href="#context-terms"><span class="secno">3.2.1</span> <span class="content">Context Terms</span></a>
        <li><a href="#bidi-considerations"><span class="secno">3.2.2</span> <span class="content">BiDi Considerations</span></a>
       </ol>
      <li>
       <a href="#the-fragment-directive"><span class="secno">3.3</span> <span class="content">The Fragment Directive</span></a>
       <ol class="toc">
        <li><a href="#extracting-the-fragment-directive"><span class="secno">3.3.1</span> <span class="content">Extracting the fragment directive</span></a>
        <li><a href="#applying-directives-to-a-document"><span class="secno">3.3.2</span> <span class="content">Applying directives to a document</span></a>
        <li><a href="#parsing-the-fragment-directive"><span class="secno">3.3.3</span> <span class="content">Parsing the fragment directive</span></a>
        <li><a href="#fragment-directive-grammar"><span class="secno">3.3.4</span> <span class="content">Fragment directive grammar</span></a>
       </ol>
      <li>
       <a href="#text-directives"><span class="secno">3.4</span> <span class="content">Text Directives</span></a>
       <ol class="toc">
        <li><a href="#invoking-text-directives"><span class="secno">3.4.1</span> <span class="content">Invoking Text Directives</span></a>
       </ol>
      <li>
       <a href="#security-and-privacy"><span class="secno">3.5</span> <span class="content">Security and Privacy</span></a>
       <ol class="toc">
        <li><a href="#motivation"><span class="secno">3.5.1</span> <span class="content">Motivation</span></a>
        <li><a href="#scroll-on-navigation"><span class="secno">3.5.2</span> <span class="content">Scroll On Navigation</span></a>
        <li><a href="#search-timing"><span class="secno">3.5.3</span> <span class="content">Search Timing</span></a>
        <li><a href="#restricting-the-text-fragment"><span class="secno">3.5.4</span> <span class="content">Restricting the Text Fragment</span></a>
        <li><a href="#restricting-scroll-on-load"><span class="secno">3.5.5</span> <span class="content">Restricting Scroll on Load</span></a>
       </ol>
      <li>
       <a href="#navigating-to-text-fragment"><span class="secno">3.6</span> <span class="content">Navigating to a Text Fragment</span></a>
       <ol class="toc">
        <li><a href="#finding-ranges-in-a-document"><span class="secno">3.6.1</span> <span class="content">Finding Ranges in a Document</span></a>
        <li><a href="#word-boundaries"><span class="secno">3.6.2</span> <span class="content">Word Boundaries</span></a>
       </ol>
      <li>
       <a href="#indicating-the-text-match"><span class="secno">3.7</span> <span class="content">Indicating The Text Match</span></a>
       <ol class="toc">
        <li>
         <a href="#urls-in-ua-features"><span class="secno">3.7.1</span> <span class="content">URLs in UA features</span></a>
         <ol class="toc">
          <li><a href="#urls-in-location-bar"><span class="secno">3.7.1.1</span> <span class="content">Location Bar</span></a>
          <li><a href="#urls-in-bookmarks"><span class="secno">3.7.1.2</span> <span class="content">Bookmarks</span></a>
          <li><a href="#urls-in-sharing"><span class="secno">3.7.1.3</span> <span class="content">Sharing</span></a>
         </ol>
       </ol>
      <li><a href="#document-policy-integration"><span class="secno">3.8</span> <span class="content">Document Policy Integration</span></a>
      <li><a href="#feature-detectability"><span class="secno">3.9</span> <span class="content">Feature Detectability</span></a>
     </ol>
    <li>
     <a href="#generating-text-fragment-directives"><span class="secno">4</span> <span class="content">Generating Text Fragment Directives</span></a>
     <ol class="toc">
      <li><a href="#prefer-exact-matching-to-range-based"><span class="secno">4.1</span> <span class="content">Prefer Exact Matching To Range-based</span></a>
      <li><a href="#use-context-only-when-necessary"><span class="secno">4.2</span> <span class="content">Use Context Only When Necessary</span></a>
      <li><a href="#determine-if-fragment-id-is-needed"><span class="secno">4.3</span> <span class="content">Determine If Fragment Id Is Needed</span></a>
     </ol>
    <li>
     <a href="#w3c-conformance"><span class="secno"></span> <span class="content">Conformance</span></a>
     <ol class="toc">
      <li><a href="#w3c-conventions"><span class="secno"></span> <span class="content">Document conventions</span></a>
     </ol>
    <li>
     <a href="#index"><span class="secno"></span> <span class="content">Index</span></a>
     <ol class="toc">
      <li><a href="#index-defined-here"><span class="secno"></span> <span class="content">Terms defined by this specification</span></a>
      <li><a href="#index-defined-elsewhere"><span class="secno"></span> <span class="content">Terms defined by reference</span></a>
     </ol>
    <li>
     <a href="#references"><span class="secno"></span> <span class="content">References</span></a>
     <ol class="toc">
      <li><a href="#normative"><span class="secno"></span> <span class="content">Normative References</span></a>
      <li><a href="#informative"><span class="secno"></span> <span class="content">Informative References</span></a>
     </ol>
    <li><a href="#idl-index"><span class="secno"></span> <span class="content">IDL Index</span></a>
    <li><a href="#issues-index"><span class="secno"></span> <span class="content">Issues Index</span></a>
   </ol>
  </nav>
  <main>
   <h2 class="heading settled" data-level="1" id="infrastructure"><span class="secno">1. </span><span class="content">Infrastructure</span><a class="self-link" href="#infrastructure"></a></h2>
   <p>This specification depends on the Infra Standard. <a data-link-type="biblio" href="#biblio-infra" title="Infra Standard">[INFRA]</a> </p>
   <h2 class="heading settled" data-level="2" id="introduction"><span class="secno">2. </span><span class="content">Introduction</span><a class="self-link" href="#introduction"></a></h2>
   <div class="note" role="note">This section is non-normative</div>
   <h3 class="heading settled" data-level="2.1" id="use-cases"><span class="secno">2.1. </span><span class="content">Use cases</span><a class="self-link" href="#use-cases"></a></h3>
   <h4 class="heading settled" data-level="2.1.1" id="web-text-references"><span class="secno">2.1.1. </span><span class="content">Web text references</span><a class="self-link" href="#web-text-references"></a></h4>
    The core use case for text fragments is to allow URLs to serve as an exact text
reference across the web. For example, Wikipedia references could link to the
exact text they are quoting from a page. Similarly, search engines can serve
URLs that direct the user to the answer they are looking for in the page rather
than linking to the top of the page. 
   <h4 class="heading settled" data-level="2.1.2" id="user-sharing"><span class="secno">2.1.2. </span><span class="content">User sharing</span><a class="self-link" href="#user-sharing"></a></h4>
    With text fragments, browsers may implement an option to 'Copy URL to here'
when the user opens the context menu on a text selection. The browser can then
generate a URL with the text selection appropriately specified, and the
recipient of the URL will have the specified text conveniently indicated.
Without text fragments, if a user wants to share a passage of text from a page,
they would likely just copy and paste the passage, in which case the receiver
loses the context of the page. 
   <h2 class="heading settled" data-level="3" id="description"><span class="secno">3. </span><span class="content">Description</span><a class="self-link" href="#description"></a></h2>
   <h3 class="heading settled" data-level="3.1" id="indication"><span class="secno">3.1. </span><span class="content">Indication</span><a class="self-link" href="#indication"></a></h3>
   <div class="note" role="note">This section is non-normative</div>
   <p>This specification intentionally doesn’t define what actions a user agent takes
to "indicate" a text match. There are different experiences and trade-offs a
user agent could make. Some examples of possible actions:</p>
   <ul>
    <li data-md>
     <p>Providing visual emphasis or highlight of the text passage</p>
    <li data-md>
     <p>Automatically scrolling the passage into view when the page is navigated</p>
    <li data-md>
     <p>Activating a UA’s find-in-page feature on the text passage</p>
    <li data-md>
     <p>Providing a "Click to scroll to text passage" notification</p>
    <li data-md>
     <p>Providing a notification when the text passage isn’t found in the page</p>
   </ul>
   <div class="note" role="note"> The choice of action can have implications for user security and privacy.  See
the <a href="#security-and-privacy">§ 3.5 Security and Privacy</a> section for details. </div>
   <h3 class="heading settled" data-level="3.2" id="syntax"><span class="secno">3.2. </span><span class="content">Syntax</span><a class="self-link" href="#syntax"></a></h3>
   <div class="note" role="note">This section is non-normative</div>
   <p>A <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive">text directive</a> is specified in the <a data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive">fragment directive</a> (see <a href="#the-fragment-directive">§ 3.3 The Fragment Directive</a>) with the following format:</p>
<pre>#:~:text=[prefix-,]start[,end][,-suffix]
          context  |--match--|  context
</pre>
   <p><em>(Square brackets indicate an optional parameter)</em></p>
   <p>The text parameters are percent-decoded before matching. Dash (-), ampersand
(&amp;), and comma (,) characters in text parameters are percent-encoded to avoid
being interpreted as part of the text directive syntax.</p>
   <p>The only required parameter is <code>start</code>. If only <code>start</code> is specified, the
first instance of this exact text string is the target text.</p>
   <div class="example" id="example-4e85550d"><a class="self-link" href="#example-4e85550d"></a> <code>#:~:text=an%20example%20text%20fragment</code> indicates that the
exact text "an example text fragment" is the target text. </div>
   <p>If the <code>end</code> parameter is also specified, then the text directive refers to a
range of text in the page. The target text range is the text range starting at
the first instance of <code>start</code>, until the first instance of <code>end</code> that
appears after <code>start</code>. This is equivalent to specifying the entire text range
in the <code>start</code> parameter, but allows the URL to avoid being bloated with a
long text directive.</p>
   <div class="example" id="example-7df2027e"><a class="self-link" href="#example-7df2027e"></a> <code>#:~:text=an%20example,text%20fragment</code> indicates that the first
instance of "an example" until the following first instance of "text fragment"
is the target text. </div>
   <h4 class="heading settled" data-level="3.2.1" id="context-terms"><span class="secno">3.2.1. </span><span class="content">Context Terms</span><a class="self-link" href="#context-terms"></a></h4>
   <div class="note" role="note">This section is non-normative</div>
   <p>The other two optional parameters are context terms. They are specified by the
dash (-) character succeeding the prefix and preceding the suffix, to
differentiate them from the <code>start</code> and <code>end</code> parameters, as any
combination of optional parameters can be specified.</p>
   <p>Context terms are used to disambiguate the target text fragment. The context
terms can specify the text immediately before (prefix) and immediately after
(suffix) the text fragment, allowing for whitespace.</p>
   <div class="note" role="note"> While a match succeeds only if the context terms surround the target text
fragment, any amount of whitespace is allowed between context terms and the text
fragment. This allows context terms to cross element boundaries, for example if
the target text fragment is at the beginning of a paragraph and needs
disambiguation by the previous element’s text as a prefix. </div>
   <p>The context terms are not part of the targeted text fragment and are not
visually indicated.</p>
   <div class="example" id="example-5c87b699"><a class="self-link" href="#example-5c87b699"></a> <code>#:~:text=this%20is-,an%20example,-text%20fragment</code> would match
to "an example" in "this is an example text fragment", but not match to "an
example" in "here is an example text". </div>
   <h4 class="heading settled" data-level="3.2.2" id="bidi-considerations"><span class="secno">3.2.2. </span><span class="content">BiDi Considerations</span><a class="self-link" href="#bidi-considerations"></a></h4>
   <div class="note" role="note">This section is non-normative</div>
   <div class="note" role="note"> See <a href="https://www.w3.org/International/articles/inline-bidi-markup/uba-basics.en">Unicode
  Bidirectional Algorithm basics</a> for a good overview of how Bidirectional
  text works. </div>
   <p>Since URL strings are ASCII encoded, they provide no built-in support for
bi-directional text. However, the content that we wish to target on a page can
be LTR (left-to-right), RTL (right-to-left) or both (Bidirectional/BiDi). This
section provides an intuitive description the behavior implicitly described by
the normative sections further in this spec.</p>
   <p>The characters of each term in the text fragment are in <em>logical order</em>,
that is, the order in which a native reader would read them in (and also the
order in which characters are stored in memory).</p>
   <p>Similarly, the <code>prefix</code> and <code>start</code> terms identify
text coming before another term in logical order, while <code>suffix</code> and <code>end</code> follow other terms in logical order.</p>
   <p class="note" role="note"><span class="marker">Note:</span> user agents can visually render URLs in a manner friendlier to a native
reader, for example, by converting the displayed string to Unicode. However, the
string representation of a URL remains plain ASCII characters.</p>
   <div class="example" id="example-b17c0d6b">
    <a class="self-link" href="#example-b17c0d6b"></a> Suppose we want to select the text <code lang="ar">مِصر‎</code> (Egypt, in Arabic),
  that’s preceeded by <code lang="ar">البحرين‎</code> (Bahrain, in Arabic). We would
  first percent encode each term: 
    <p><code lang="ar">مِصر‎</code> becomes "%D9%85%D8%B5%D8%B1" (Note: UTF-8 character
  [0xD9,0x85] is the first (right-most) character of the Arabic word.)</p>
    <p><code lang="ar">البحرين‎</code> becomes "%D8%A7%D9%84%D8%A8%D8%AD%D8%B1%D9%8A%D9%86"</p>
    <p>The text fragment would then become:</p>
    <p><code> :~:text=%D8%A7%D9%84%D8%A8%D8%AD%D8%B1%D9%8A%D9%86-,%D9%85%D8%B5%D8%B1 </code></p>
    <p>When displayed in a browser’s address bar, the browser can visually render the
  text in its natural RTL direction, appearing to the user:</p>
    <p><code> :~:text=<span lang="ar">البحرين</span>-,<span lang="ar">مِصر</span> </code></p>
   </div>
   <h3 class="heading settled" data-level="3.3" id="the-fragment-directive"><span class="secno">3.3. </span><span class="content">The Fragment Directive</span><a class="self-link" href="#the-fragment-directive"></a></h3>
   <p>To avoid compatibility issues with usage of existing URL fragments, this spec
introduces the concept of a <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="fragment-directive">fragment directive</dfn>. It is the portion of
the URL <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-fragment" id="ref-for-concept-url-fragment">fragment</a> that follows the <a data-link-type="dfn" href="#fragment-directive-delimiter" id="ref-for-fragment-directive-delimiter">fragment directive delimiter</a> and
may be null if the delimiter does not appear in the fragment.</p>
   <p>The <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="fragment-directive-delimiter">fragment directive delimiter</dfn> is the string ":~:", that is the
three consecutive code points U+003A (:), U+007E (~), U+003A (:).</p>
   <div class="note" role="note"> The <a data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive①">fragment directive</a> is part of the URL fragment. This means it
  always appears after a U+0023 (#) code point in a URL. </div>
   <div class="example" id="example-6998d91f"><a class="self-link" href="#example-6998d91f"></a> To add a <a data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive②">fragment directive</a> to a URL like https://example.com, a fragment
  is first appended to the URL: https://example.com#:~:text=foo. </div>
   <p>The fragment directive is parsed and processed into individual <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="directives">directives</dfn>, which are instructions to the user agent to perform some
action. Multiple directives may appear in the fragment directive.</p>
   <div class="note" role="note"> The only directive introduced in this spec is the text directive but others
  could be added in the future. </div>
   <div class="example" id="example-9acce0ff">
    <a class="self-link" href="#example-9acce0ff"></a> <code>https://example.com#:~:text=foo&amp;text=bar&amp;unknownDirective</code> 
    <p>Contains 2 text directives and one unknown directive.</p>
   </div>
   <p>To prevent impacting page operation, it is stripped from script-accessible APIs to prevent
interaction with author script. This also ensures future directives can be added without web
compatibility risk.</p>
   <h4 class="heading settled" data-level="3.3.1" id="extracting-the-fragment-directive"><span class="secno">3.3.1. </span><span class="content">Extracting the fragment directive</span><a class="self-link" href="#extracting-the-fragment-directive"></a></h4>
   <p>This section describes the mechanism by which the fragment directive is hidden
from script and how it fits into <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-and-session-history"><cite>HTML</cite> § 7.4 Navigation and session history</a>.</p>
   <div class="note" role="note">
     The summarized changes in this section: 
    <ul>
     <li data-md>
      <p>Session history entries now include a new "directive state" item</p>
     <li data-md>
      <p>All new entries are created with a directive state with an empty value. If the new URL includes
  a fragment directive it will be written to the state’s value (otherwise it remains null).</p>
     <li data-md>
      <p>Any time a URL potentially including a fragment directive is written to a session history entry,
  extract the fragment directive from the URL and store it in a directive state item of the
  entry. There are four such points where a URL can potentially include a directive:</p>
      <ul>
       <li data-md>
        <p>In the "navigate" steps for typical cross-document navigations</p>
       <li data-md>
        <p>In the "navigate to a fragment" steps for fragment based same-document navigations</p>
       <li data-md>
        <p>In the "URL and history update steps" for synchronous updates such as
  pushState/replaceState.</p>
       <li data-md>
        <p>In the "create navigation params by fetching" steps for URLs coming from a redirect.</p>
      </ul>
     <li data-md>
      <p>Same-document navigations that change only the fragment, and the new URL doesn’t specify a
  directive, will create an entry whose directive state refers to the previous entry’s directive
  state.</p>
    </ul>
   </div>
   <p>In <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#session-history-infrastructure"><cite>HTML</cite> § 7.4.1 Session history</a>, define <a data-link-type="dfn" href="#directive-state" id="ref-for-directive-state">directive state</a>:</p>
   <blockquote>
    <p><strong>Monkeypatching <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#session-history-infrastructure"><cite>HTML</cite> § 7.4.1 Session history</a>:</strong></p>
    <p><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="directive-state">directive state</dfn> holds the value of the <a data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive③">fragment directive</a> at the time the session
  history entry was created and is used to invoke directives, such as text highlighting, whenever
  the entry is traversed. It has:</p>
    <ul>
     <li data-md>
      <p><dfn class="dfn-paneled" data-dfn-for="directive state" data-dfn-type="dfn" data-noexport id="directive-state-value">value</dfn>, the <a data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive④">fragment directive</a> <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ascii-string" id="ref-for-ascii-string">ASCII string</a> or null,
  initially null.</p>
    </ul>
    <p>A <a data-link-type="dfn" href="#directive-state" id="ref-for-directive-state①">directive state</a> may be shared by multiple session history entries.</p>
    <div class="note" role="note">
     <p>The fragment directive is removed from the URL before the URL is set to the session
      history entry. It is instead stored in the directive state. This prevents it from being
      visible to script APIs so that a directive can be specified without interfering with a
      page’s operation.</p>
     <p>The fragment directive is stored in the directive state object, rather than a raw string,
      since the same directive state can be shared across multiple contiguous session history
      entries. On a traversal, the directive is only processed (i.e. search text and highlight) if
      the directive state has changed between two entries.</p>
    </div>
   </blockquote>
   <p>To the definition of <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#session-history-entry">session history entry</a>, add:</p>
   <blockquote>
    <p><strong>Monkeypatching <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#session-history-entries"><cite>HTML</cite> § 7.4.1.1 Session history entries</a>:</strong></p>
    <div class="monkeypatch">
     A session history entry is a struct with the following items: 
     <ul>
      <li data-md>
       <p>...</p>
      <li data-md>
       <p>persisted user state, which is implementation-defined, initially null</p>
      <li data-md>
       <p><span class="diff"><dfn class="dfn-paneled" data-dfn-for="she" data-dfn-type="dfn" data-noexport id="she-directive-state">directive state</dfn>, a <a data-link-type="dfn" href="#directive-state" id="ref-for-directive-state②">directive state</a>,
initially a new <a data-link-type="dfn" href="#directive-state" id="ref-for-directive-state③">directive state</a></span></p>
     </ul>
    </div>
   </blockquote>
   <p>Add a helper algorithm for removing and returning a fragment directive string from a <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url" id="ref-for-concept-url">URL</a>:</p>
   <blockquote>
    <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a>:</strong></p>
    <div class="note" role="note"> This algorithm makes a URL’s fragment end at the <a data-link-type="dfn" href="#fragment-directive-delimiter" id="ref-for-fragment-directive-delimiter①">fragment directive
    delimiter</a>. The returned <a data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive⑤">fragment directive</a> includes all characters that follow the
    delimiter but does not include the delimiter. </div>
    <div class="issue" id="issue-f4a5d96b"><a class="self-link" href="#issue-f4a5d96b"></a> TODO: If a URL’s fragment ends with ':~:' (i.e. empty directive), this will return null which
    is treated as the URL not specifying an explicit directive (and avoids clobbering an existing
    one. But maybe in this case we should return the empty string? That way a page can explicitly
    clear directives/highlights by navigating/pushState to '#:~:'. </div>
    <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="remove-the-fragment-directive">remove the fragment directive</dfn> from a <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url" id="ref-for-concept-url①">URL</a> <var>url</var>, run these steps:</p>
    <ol>
     <li data-md>
      <p>Let <var>raw fragment</var> be equal to <var>url</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-fragment" id="ref-for-concept-url-fragment①">fragment</a>.</p>
     <li data-md>
      <p>Let <var>fragment directive</var> be null.</p>
     <li data-md>
      <p>If <var>raw fragment</var> is non-null and contains the <a data-link-type="dfn" href="#fragment-directive-delimiter" id="ref-for-fragment-directive-delimiter②">fragment directive delimiter</a> as a
  substring:</p>
      <ol>
       <li data-md>
        <p>Let <var>position</var> be the <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string-position-variable" id="ref-for-string-position-variable">position variable</a> pointing to the first code
  point of the first instance, if one exists, of the <a data-link-type="dfn" href="#fragment-directive-delimiter" id="ref-for-fragment-directive-delimiter③">fragment directive delimiter</a> in <var>raw fragment</var>, or past the end of <var>raw fragment</var> otherwise.</p>
       <li data-md>
        <p>Let <var>new fragment</var> be the <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#code-point-substring-by-positions" id="ref-for-code-point-substring-by-positions">code point substring by positions</a> of <var>raw fragment</var> from
  the start of <var>raw fragment</var> to <var>position</var>.</p>
       <li data-md>
        <p>Advance <var>position</var> by the <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string-code-point-length" id="ref-for-string-code-point-length">code point length</a> of the <a data-link-type="dfn" href="#fragment-directive-delimiter" id="ref-for-fragment-directive-delimiter④">fragment directive
  delimiter</a>.</p>
       <li data-md>
        <p>If <var>position</var> does not point past the end of <var>raw fragment</var>:</p>
        <ol>
         <li data-md>
          <p>Set <var>fragment directive</var> to the <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#code-point-substring-to-the-end-of-the-string" id="ref-for-code-point-substring-to-the-end-of-the-string">code point substring to the end of the string</a> <var>raw fragment</var> starting from <var>position</var></p>
        </ol>
       <li data-md>
        <p>Set <var>url</var>’s <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url-fragment" id="ref-for-concept-url-fragment②">fragment</a> to <var>new fragment</var>.</p>
      </ol>
     <li data-md>
      <p>Return <var>fragment directive</var>.</p>
    </ol>
    <div class="example" id="example-775c8cc2"><a class="self-link" href="#example-775c8cc2"></a> <code>https://example.org/#test:~:text=foo</code> will be parsed such that
     the fragment is the string "test" and the <a data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive⑥">fragment directive</a> is the string
     "text=foo". </div>
   </blockquote>
   <p>The next four monkeypatches modify the creation of a session history entry, where the URL might
contain a fragment directive, to remove the fragment directive and store it in the <a data-link-type="dfn" href="#directive-state" id="ref-for-directive-state④">directive
state</a>.</p>
   <p>In the definition of <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate" id="ref-for-navigate">navigate</a>:</p>
   <blockquote>
    <p><strong>Monkeypatching <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#beginning-navigation"><cite>HTML</cite> § 7.4.2.2 Beginning navigation</a>:</strong></p>
    <div class="monkeypatch">
     To navigate a navigable navigable to a URL <var>url</var>...: 
     <ol>
      <li data-md>
       <p>...</p>
      <li value="14">Set navigable’s ongoing navigation to navigationId.
      <li data-md>
       <p>If url’s scheme is "javascript", then...</p>
      <li data-md>
       <p>In parallel, run these steps:</p>
       <ol>
        <li data-md>
         <p>...</p>
        <li value="5">If url is about:blank, then set documentState’s origin to documentState’s initiator origin.
        <li data-md>
         <p>Otherwise, if url is about:srcdoc, then set documentState’s origin to navigable’s parent’s active document’s origin.</p>
        <li data-md>
         <strike>Let historyEntry be a new session history entry, with its URL set to url and
its document state set to documentState.</strike>
        <li value="7"><span class="diff">Let <var>fragment directive</var> be the result of running <a data-link-type="dfn" href="#remove-the-fragment-directive" id="ref-for-remove-the-fragment-directive">remove the
fragment directive</a> on <var>url</var>.</span>
        <li data-md>
         <p><span class="diff">Let <var>directive state</var> be a new <a data-link-type="dfn" href="#directive-state" id="ref-for-directive-state⑤">directive
state</a> with <a data-link-type="dfn" href="#directive-state-value" id="ref-for-directive-state-value">value</a> set to <var>fragment directive</var>.</span></p>
        <li data-md>
         <p><span class="diff">Let historyEntry be a new session history entry, with its URL
set to <var>url</var>, its document state set to documentState, and its <a data-link-type="dfn" href="#she-directive-state" id="ref-for-she-directive-state">directive state</a> set to <var>directive state</var>.</span></p>
        <li data-md>
         <p>Let navigationParams be null.</p>
        <li data-md>
         <p>...</p>
       </ol>
     </ol>
    </div>
   </blockquote>
   <p>In the definition of <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate-fragid">navigate to a fragment</a>:</p>
   <blockquote>
    <p><strong>Monkeypatching <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-fragid"><cite>HTML</cite> § 7.4.2.3.3 Fragment navigations</a>:</strong></p>
    <div class="monkeypatch">
     To navigate to a fragment given navigable <var>navigable</var>, ...: 
     <ol>
      <li data-md>
       <p><span class="diff">Let <var>directive state</var> be navigable’s active session history
entry’s <a data-link-type="dfn" href="#she-directive-state" id="ref-for-she-directive-state①">directive state</a>.</span></p>
      <li data-md>
       <p><span class="diff">Let <var>fragment directive</var> be the result of running <a data-link-type="dfn" href="#remove-the-fragment-directive" id="ref-for-remove-the-fragment-directive①">remove the fragment directive</a> on <var>url</var>.</span></p>
      <li data-md>
       <p><span class="diff">If <var>fragment directive</var> is not null:</span></p>
       <div class="note" role="note">Otherwise, when only the fragment has changed and it did not specify
a directive, the active entry’s directive state is reused. This prevents a fragment
change from clobbering highlights.</div>
       <ol>
        <li data-md>
         <p><span class="diff">Let <var>directive state</var> be a new <a data-link-type="dfn" href="#directive-state" id="ref-for-directive-state⑥">directive state</a> with <a data-link-type="dfn" href="#directive-state-value" id="ref-for-directive-state-value①">value</a> set to <var>fragment directive</var>.</span></p>
       </ol>
      <li data-md>
       <p>Let historyEntry be a new session history entry, with</p>
       <ul>
        <li data-md>
         <p>URL url</p>
        <li data-md>
         <p>document state navigable’s active session history entry’s document state</p>
        <li data-md>
         <p>scroll restoration mode navigable’s active session history entry’s scroll restoration
mode</p>
        <li data-md>
         <p><span class="diff"><a data-link-type="dfn" href="#she-directive-state" id="ref-for-she-directive-state②">directive state</a> <var>directive state</var></span></p>
       </ul>
      <li data-md>
       <p>Let entryToReplace be navigable’s active session history entry if historyHandling is
"replace", otherwise null.</p>
      <li data-md>
       <p>...</p>
     </ol>
    </div>
   </blockquote>
   <p>In the definition of <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#url-and-history-update-steps">URL and history update steps</a>:</p>
   <blockquote>
    <p><strong>Monkeypatching <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate-non-frag-sync"><cite>HTML</cite> § 7.4.4 Non-fragment synchronous "navigations"</a>:</strong></p>
    <div class="monkeypatch">
     The URL and history update steps, given a Document <var>document</var>, ...: 
     <ol>
      <li data-md>
       <p>Let <var>navigable</var> be <var>document</var>’s node navigable.</p>
      <li data-md>
       <p>Let <var>activeEntry</var> be <var>navigable</var>’s active session history entry.</p>
      <li data-md>
       <p><span class="diff">Let <var>fragment directive</var> be the result of running <a data-link-type="dfn" href="#remove-the-fragment-directive" id="ref-for-remove-the-fragment-directive②">remove the
fragment directive</a> on <var>newUrl</var>.</span></p>
      <li data-md>
       <p>Let <var>historyEntry</var> be a new session history entry, with</p>
       <ul>
        <li data-md>
         <p>URL <var>newUrl</var></p>
        <li data-md>
         <p>...</p>
        <li data-md>
         <p><span class="diff"><a data-link-type="dfn" href="#she-directive-state" id="ref-for-she-directive-state③">directive state</a> <var>activeEntry</var>’s <a data-link-type="dfn" href="#she-directive-state" id="ref-for-she-directive-state④">directive
state</a></span></p>
       </ul>
      <li data-md>
       <p>If <var>document</var>’s is initial about:blank is true, then set historyHandling to "replace".</p>
      <li data-md>
       <p>If historyHandling is "push", then:</p>
       <ol>
        <li data-md>
         <p>Increment document’s history object’s index.</p>
        <li data-md>
         <p>Set document’s history object’s length to its index + 1.</p>
        <li data-md>
         <p><span class="diff">If <var>newUrl</var> does not equal <var>activeEntry</var>’s URL with exclude
fragments set to true OR <var>fragment directive</var> is not null, then:</span></p>
         <div class="note" role="note">Otherwise, when only the fragment has changed and it did not specify
a directive, the active entry’s directive state is reused. This prevents a fragment
change from clobbering highlights.</div>
         <ol>
          <li data-md>
           <p><span class="diff">Let <var>historyEntry</var>’s <a data-link-type="dfn" href="#she-directive-state" id="ref-for-she-directive-state⑤">directive state</a> be a new <a data-link-type="dfn" href="#directive-state" id="ref-for-directive-state⑦">directive state</a> with <a data-link-type="dfn" href="#directive-state-value" id="ref-for-directive-state-value②">value</a> set to <var>fragment
directive</var>.</span></p>
         </ol>
       </ol>
      <li data-md>
       <p><span class="diff">Otherwise, if <var>fragment directive</var> is not null, set <var>historyEntry</var>’s <a data-link-type="dfn" href="#she-directive-state" id="ref-for-she-directive-state⑥">directive state</a>'s <a data-link-type="dfn" href="#directive-state-value" id="ref-for-directive-state-value③">value</a> to <var>fragment
directive</var>.</span></p>
      <li data-md>
       <p>If serializedData is not null, then restore the history object state given document and
newEntry.</p>
     </ol>
    </div>
   </blockquote>
   <p>In the definition of <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#create-navigation-params-by-fetching"> create navigation params by fetching</a>:</p>
   <blockquote>
    <p><strong>Monkeypatching <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#populating-a-session-history-entry"><cite>HTML</cite> § 7.4.5 Populating a session history entry</a>:</strong></p>
    <div class="monkeypatch">
     To create navigation params by fetching given a session history entry <var>entry</var>, ...: 
     <ol>
      <li data-md>
       <p class="assertion">Assert: this is running in parallel.</p>
      <li data-md>
       <p>...</p>
      <li value="17">Let currentURL be request’s current URL.
      <li data-md>
       <p>Let commitEarlyHints be null.</p>
      <li data-md>
       <p>While true:</p>
       <ol>
        <li data-md>
         <p>If request’s reserved client is not null and currentURL’s origin is not the same as request’s reserved client’s creation URL’s origin, then:</p>
        <li data-md>
         <p>...</p>
        <li value="21">Set currentURL to <var>locationURL</var>.
        <li data-md>
         <p><span class="diff">Let <var>fragment directive</var> be the result of running <a data-link-type="dfn" href="#remove-the-fragment-directive" id="ref-for-remove-the-fragment-directive③">remove the fragment directive</a> on <var>locationURL</var>.</span></p>
        <li data-md>
         <strike class="diff">Set <var>entry</var>’s URL to currentURL.</strike>
        <li data-md>
         <p><span class="diff">Set <var>entry</var>’s URL to <var>locationURL</var>.</span></p>
        <li data-md>
         <p><span class="diff">Set <var>entry</var>’s <a data-link-type="dfn" href="#she-directive-state" id="ref-for-she-directive-state⑦">directive state</a>'s <a data-link-type="dfn" href="#directive-state-value" id="ref-for-directive-state-value④">value</a> to <var>fragment directive</var>.</span></p>
        <li data-md>
         <p>If <var>locationURL</var> is a URL whose scheme is not a fetch scheme, then return a new non-fetch
scheme navigation params, with initiator origin request’s current URL’s origin</p>
        <li data-md>
         <p>...</p>
       </ol>
     </ol>
    </div>
   </blockquote>
   <div class="note" role="note">
    <p> Since a Document is populated from a history entry, its <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document-url" id="ref-for-concept-document-url">URL</a> will not include the
    fragment directive. Similarly, since a window’s <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#location" id="ref-for-location">Location</a></code> object is a representation of the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#concept-url" id="ref-for-concept-url②">URL</a> of the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document" id="ref-for-nav-document">active document</a>, all getters on it will show a fragment-directive-stripped
    version of the URL. </p>
    <p> Additionally, since the <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/nav-history-apis.html#hashchangeevent" id="ref-for-hashchangeevent">HashChangeEvent</a></code> is <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#updating-the-document"> fired in response to a changed fragment</a> between URLs of session history entries, <code>hashchange</code> will not be fired if a navigation or traversal changes only the fragment
    directive. </p>
    <p> Some examples are provided to help clarify various edge cases. </p>
   </div>
   <div class="example" id="example-c4fd5b50">
    <a class="self-link" href="#example-c4fd5b50"></a> 
<pre>window.location = "https://example.com#page1:~:hello";
console.log(window.location.href); // 'https://example.com#page1'
console.log(window.location.hash); // '#page1'
</pre>
    <p>The initial navigation created a new session history entry. The entry’s URL is stripped of the
  fragment directive: "https://example.com#page1". The entry’s directive state value is set to
  "hello". Since the document is populated from the entry, web APIs don’t include the fragment
  directive in URLs.</p>
<pre>location.hash = "page2";
console.log(location.href); // 'https://example.com#page2'
</pre>
    <p>A same document navigation changed only the fragment. This adds a new session history entry in the <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate-fragid">navigate to
  a fragment</a> steps. However, since only the fragment changed, the new entry’s directive state
  points to the same state as the first entry, with a value of "bar".</p>
<pre>onhashchange = () => console.assert(false, "hashchange doesn’t fire.");
location.hash = "page2:~:world";
console.log(location.href); // 'https://example.com#page2'
onhashchange = null;
</pre>
    <p>A same document navigation changes only the fragment but includes a fragment directive. Since an
  explicit directive was provided, the new entry includes its own directive state with a value of
  "fizz".</p>
    <p>The hashchange event is not fired since the page-visible fragment is unchanged; only the fragment
  directive changed. This is because the comparison for hashchange is done on the URLs in the
  session history entries, where the fragment directive has been removed.</p>
<pre>history.pushState("", "", "page3");
console.log(location.href); // 'https://example.com/page3'
</pre>
    <p>pushState creates a new session history entry for the same document. However, since the
  non-fragment URL has changed, this entry has its own directive state with value currently null.</p>
   </div>
   <div class="example" id="example-f4d8b076">
    <a class="self-link" href="#example-f4d8b076"></a> In other cases where a URL is not set to a session history entry, there is no
  fragment directive stripping. 
    <p>For URL objects:</p>
<pre>let url = new URL('https://example.com#foo:~:bar');
console.log(url.href); // 'https://example.com#foo:~:bar'
console.log(url.hash); // '#foo:~:bar'

document.url = url;
console.log(document.url.href); // 'https://example.com#foo:~:bar'
console.log(document.url.hash); // '#foo:~:bar'

</pre>
    <p>The <code>&lt;a></code> or <code>&lt;area></code> elements:</p>
<pre>&lt;a id='anchor' href="https://example.com#foo:~:bar">Anchor&lt;/a>
&lt;script>
  console.log(anchor.href); // 'https://example.com#foo:~:bar'
  console.log(anchor.hash); // '#foo:~:bar'
&lt;/script>
</pre>
   </div>
   <h4 class="heading settled" data-level="3.3.2" id="applying-directives-to-a-document"><span class="secno">3.3.2. </span><span class="content">Applying directives to a document</span><a class="self-link" href="#applying-directives-to-a-document"></a></h4>
   <p>The section above described how the <a data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive⑦">fragment directive</a> is separated from the URL and stored in a
session history entry.</p>
   <p>This section defines how and when navigations and traversals make use of history entry’s <a data-link-type="dfn" href="#she-directive-state" id="ref-for-she-directive-state⑧">directive
state</a> to apply the directives associated with a session history entry to a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document">Document</a>.</p>
   <blockquote>
    <p><strong>Monkeypatching <a href="https://dom.spec.whatwg.org/#interface-document"><cite>DOM</cite> § 4.5 Interface Document</a>:</strong></p>
    <p>Each document has an associated <dfn class="dfn-paneled" data-dfn-for="Document" data-dfn-type="dfn" data-noexport id="document-uninvoked-directives">uninvoked directives</dfn> which is either
  null or an ASCII string holding data used by the UA to process the resource. It is initially
  null.</p>
   </blockquote>
   <p>In the definition of <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#update-document-for-history-step-application" id="fb71d7890"> update document for history step application</a>:</p>
   <blockquote>
    <p><strong>Monkeypatching <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#updating-the-document"><cite>HTML</cite> § 7.4.6.2 Updating the document</a>:</strong></p>
    <div class="monkeypatch">
     To update document for history step application given a Document <var>document</var>, a session history entry <var>entry</var>,... 
     <ol>
      <li data-md>
       <p>...</p>
      <li value="4">Set <var>document</var>’s history object’s length to scriptHistoryLength
      <li data-md>
       <p>If <var>documentsEntryChanged</var> is true, then:</p>
       <ol>
        <li data-md>
         <p>Let <var>oldURL</var> be <var>document</var>’s latest entry’s URL.</p>
        <li data-md>
         <p><span class="diff">If <var>document</var>’s latest entry’s <a data-link-type="dfn" href="#she-directive-state" id="ref-for-she-directive-state⑨">directive state</a> is not <var>entry</var>’s <a data-link-type="dfn" href="#she-directive-state" id="ref-for-she-directive-state①⓪">directive state</a> then set <var>document</var>’s <a data-link-type="dfn" href="#document-uninvoked-directives" id="ref-for-document-uninvoked-directives">uninvoked directives</a> to <var>entry</var>’s <a data-link-type="dfn" href="#she-directive-state" id="ref-for-she-directive-state①①">directive state</a>'s <a data-link-type="dfn" href="#directive-state-value" id="ref-for-directive-state-value⑤">value</a>.</span></p>
        <li data-md>
         <p>Set <var>document</var>’s latest entry to <var>entry</var></p>
        <li data-md>
         <p>...</p>
       </ol>
     </ol>
    </div>
   </blockquote>
   <h4 class="heading settled" data-level="3.3.3" id="parsing-the-fragment-directive"><span class="secno">3.3.3. </span><span class="content">Parsing the fragment directive</span><a class="self-link" href="#parsing-the-fragment-directive"></a></h4>
   <h4 class="heading settled" data-level="3.3.4" id="fragment-directive-grammar"><span class="secno">3.3.4. </span><span class="content">Fragment directive grammar</span><a class="self-link" href="#fragment-directive-grammar"></a></h4>
   <p>An <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ascii-string" id="ref-for-ascii-string①">ASCII string</a> is a <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="valid-fragment-directive">valid fragment directive</dfn> if
it matches the production:</p>
   <dl>
    <dt> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="fragmentdirectiveproduction"><code>FragmentDirective</code></dfn> <code>::=</code> 
    <dd> <code>(<a data-link-type="dfn" href="#textdirective" id="ref-for-textdirective">TextDirective</a> | <a data-link-type="dfn" href="#unknowndirective" id="ref-for-unknowndirective">UnknownDirective</a>) ("&amp;" <a data-link-type="dfn" href="#fragmentdirectiveproduction" id="ref-for-fragmentdirectiveproduction">FragmentDirective</a>)?</code> 
    <dt> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="unknowndirective"><code>UnknownDirective</code></dfn> <code>::=</code> 
    <dd> <code><a data-link-type="dfn" href="#characterstring" id="ref-for-characterstring">CharacterString</a></code> 
    <dt> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="characterstring"><code>CharacterString</code></dfn> <code>::=</code> 
    <dd> <code>(<a data-link-type="dfn" href="#explicitchar" id="ref-for-explicitchar">ExplicitChar</a> | <a data-link-type="dfn" href="#percentencodedbyte" id="ref-for-percentencodedbyte">PercentEncodedByte</a>)+</code> 
    <dt> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="explicitchar"><code>ExplicitChar</code></dfn> <code>::=</code> 
    <dd>
      <code>[a-zA-Z0-9] | "!" | "$" | "'" | "(" | ")" | "*" | "+" | "." | "/" | ":" |
    ";" | "=" | "?" | "@" | "_" | "~" | "," | "-"</code> 
     <div class="note" role="note"> An <a data-link-type="dfn" href="#explicitchar" id="ref-for-explicitchar①">ExplicitChar</a> may be any <a data-link-type="dfn" href="https://url.spec.whatwg.org/#url-code-points" id="ref-for-url-code-points">URL code point</a> other than "&amp;". </div>
   </dl>
   <div class="note" role="note"> The <a data-link-type="dfn" href="#fragmentdirectiveproduction" id="ref-for-fragmentdirectiveproduction①">FragmentDirective</a> can contain multiple directives split by the "&amp;"
  character. Currently this means we allow multiple text directives to enable
  multiple indicated strings in the page, but this also allows for future
  directive types to be added and combined. For extensibility, we do not fail to
  parse if an unknown directive is in the &amp;-separated list of directives. </div>
   <dl>
    <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="textdirective"><code>TextDirective</code></dfn> <code>::=</code>
    <dd><code>"text=" <a data-link-type="dfn" href="#textdirectiveparameters" id="ref-for-textdirectiveparameters">TextDirectiveParameters</a></code>
    <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="textdirectiveparameters"><code>TextDirectiveParameters</code></dfn> <code>::=</code>
    <dd> <code> (<a data-link-type="dfn" href="#textdirectiveprefix" id="ref-for-textdirectiveprefix">TextDirectivePrefix</a> ",")? <a data-link-type="dfn" href="#textdirectivestring" id="ref-for-textdirectivestring">TextDirectiveString</a> ("," <a data-link-type="dfn" href="#textdirectivestring" id="ref-for-textdirectivestring①">TextDirectiveString</a>)?  ("," <a data-link-type="dfn" href="#textdirectivesuffix" id="ref-for-textdirectivesuffix">TextDirectiveSuffix</a>)? </code> 
    <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="textdirectiveprefix"><code>TextDirectivePrefix</code></dfn> <code>::=</code>
    <dd><code><a data-link-type="dfn" href="#textdirectivestring" id="ref-for-textdirectivestring②">TextDirectiveString</a>"-"</code>
    <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="textdirectivesuffix"><code>TextDirectiveSuffix</code></dfn> <code>::=</code>
    <dd><code>"-"<a data-link-type="dfn" href="#textdirectivestring" id="ref-for-textdirectivestring③">TextDirectiveString</a></code>
    <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="textdirectivestring"><code>TextDirectiveString</code></dfn> <code>::=</code>
    <dd><code>(<a data-link-type="dfn" href="#textdirectiveexplicitchar" id="ref-for-textdirectiveexplicitchar">TextDirectiveExplicitChar</a> | <a data-link-type="dfn" href="#percentencodedbyte" id="ref-for-percentencodedbyte①">PercentEncodedByte</a>)+</code>
    <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="textdirectiveexplicitchar"><code>TextDirectiveExplicitChar</code></dfn> <code>::=</code>
    <dd>
      <code> [a-zA-Z0-9] | "!" | "$" | "'" | "(" | ")" | "*" | "+" | "." | "/" | ":" |
    ";" | "=" | "?" | "@" | "_" | "~" </code> 
     <div class="note" role="note"> A <a data-link-type="dfn" href="#textdirectiveexplicitchar" id="ref-for-textdirectiveexplicitchar①">TextDirectiveExplicitChar</a> is any <a data-link-type="dfn" href="https://url.spec.whatwg.org/#url-code-points" id="ref-for-url-code-points①">URL code point</a> that is not
    explicitly used in the <a data-link-type="dfn" href="#textdirective" id="ref-for-textdirective①">TextDirective</a> syntax, that is "&amp;", "-", and ",".
    If a text fragment refers to a "&amp;", "-", or "," character in the document,
    it will be percent-encoded in the fragment. </div>
    <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="percentencodedbyte"><code>PercentEncodedByte</code></dfn> <code>::=</code>
    <dd><code>"%" [a-zA-Z0-9][a-zA-Z0-9]</code>
   </dl>
   <h3 class="heading settled" data-level="3.4" id="text-directives"><span class="secno">3.4. </span><span class="content">Text Directives</span><a class="self-link" href="#text-directives"></a></h3>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="text-directive">text directive</dfn> is a kind of <a data-link-type="dfn" href="#directives" id="ref-for-directives">directive</a> representing a range of
text to be indicated to the user. It is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#struct" id="ref-for-struct">struct</a> that consists of
four strings: <dfn class="dfn-paneled" data-dfn-for="text directive" data-dfn-type="dfn" data-noexport id="text-directive-start">start</dfn>, <dfn class="dfn-paneled" data-dfn-for="text directive" data-dfn-type="dfn" data-noexport id="text-directive-end">end</dfn>, <dfn class="dfn-paneled" data-dfn-for="text directive" data-dfn-type="dfn" data-noexport id="text-directive-prefix">prefix</dfn>, and <dfn class="dfn-paneled" data-dfn-for="text directive" data-dfn-type="dfn" data-noexport id="text-directive-suffix">suffix</dfn>. <a data-link-type="dfn" href="#text-directive-start" id="ref-for-text-directive-start">start</a> is required to be non-null. The other three items may be set to null,
indicating they weren’t provided. The empty string is not a valid value for any
of these items.</p>
   <p>See <a href="#syntax">§ 3.2 Syntax</a> for the what each of these components means and how they’re
used.</p>
   <div class="algorithm" data-algorithm="parse a text directive">
    <p>To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="parse-a-text-directive">parse a text directive</dfn>, on an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ascii-string" id="ref-for-ascii-string②">ASCII string</a> <var>text
directive input</var>, run these steps:</p>
    <div class="note" role="note">
     <p> This algorithm takes a single text directive string as input (e.g.
    "text=prefix-,foo,bar") and attempts to parse the string into the
    components of the directive (e.g. ("prefix", "foo", "bar", null)). See <a href="#syntax">§ 3.2 Syntax</a> for the what each of these components means and how they’re
    used. </p>
     <p> Returns null if the input is invalid or fails to parse in any way.
    Otherwise, returns a <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive①">text directive</a>. </p>
    </div>
    <ol class="algorithm">
     <li data-md>
      <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert" id="ref-for-assert">Assert</a>: <var>text directive input</var> matches the production <a data-link-type="dfn" href="#textdirective" id="ref-for-textdirective②">TextDirective</a>.</p>
     <li data-md>
      <p>Let <var>textDirectiveString</var> be the substring of <var>text directive
input</var> starting at index 5.</p>
      <div class="note" role="note"> This is the remainder of the <var>text directive input</var> following,
  but not including, the "text=" prefix. </div>
     <li data-md>
      <p>Let <var>tokens</var> be a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list">list</a> of strings that is the result of <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#split-on-commas" id="ref-for-split-on-commas">splitting <var>textDirectiveString</var> on commas</a>.</p>
     <li data-md>
      <p>If <var>tokens</var> has size less than 1 or greater than 4, return null.</p>
     <li data-md>
      <p>If any of <var>tokens</var>’s items are the empty string, return null.</p>
     <li data-md>
      <p>Let <var>retVal</var> be a <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive②">text directive</a> with each of its items initialized
to null.</p>
     <li data-md>
      <p>Let <var>potential prefix</var> be the first item of <var>tokens</var>.</p>
     <li data-md>
      <p>If the last character of <var>potential prefix</var> is U+002D (-), then:</p>
      <ol>
       <li data-md>
        <p>Set <var>retVal</var>’s <a data-link-type="dfn" href="#text-directive-prefix" id="ref-for-text-directive-prefix">prefix</a> to the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#string-percent-decode" id="ref-for-string-percent-decode">percent-decoding</a> of the result of removing the
last character from <var>potential prefix</var>.</p>
       <li data-md>
        <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-remove" id="ref-for-list-remove">Remove</a> the first item of the list <var>tokens</var>.</p>
      </ol>
     <li data-md>
      <p>Let <var>potential suffix</var> be the last item of <var>tokens</var>, if one exists, null
otherwise.</p>
     <li data-md>
      <p>If <var>potential suffix</var> is non-null and its first character is U+002D (-),
then:</p>
      <ol>
       <li data-md>
        <p>Set <var>retVal</var>’s <a data-link-type="dfn" href="#text-directive-suffix" id="ref-for-text-directive-suffix">suffix</a> to the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#string-percent-decode" id="ref-for-string-percent-decode①">percent-decoding</a> of the result of removing the
first character from <var>potential suffix</var>.</p>
       <li data-md>
        <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-remove" id="ref-for-list-remove①">Remove</a> the last item of the list <var>tokens</var>.</p>
      </ol>
     <li data-md>
      <p>If <var>tokens</var> has <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-size" id="ref-for-list-size">size</a> not equal to 1 nor 2 then
return null.</p>
     <li data-md>
      <p>Set <var>retVal</var>’s <a data-link-type="dfn" href="#text-directive-start" id="ref-for-text-directive-start①">start</a> be the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#string-percent-decode" id="ref-for-string-percent-decode②">percent-decoding</a> of the first item of <var>tokens</var>.</p>
     <li data-md>
      <p>If <var>tokens</var> has <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-size" id="ref-for-list-size①">size</a> 2, then set <var>retVal</var>’s <a data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end">end</a> be the <a data-link-type="dfn" href="https://url.spec.whatwg.org/#string-percent-decode" id="ref-for-string-percent-decode③">percent-decoding</a> of the last item of <var>tokens</var>.</p>
     <li data-md>
      <p>Return <var>retVal</var>.</p>
    </ol>
   </div>
   <h4 class="heading settled" data-level="3.4.1" id="invoking-text-directives"><span class="secno">3.4.1. </span><span class="content">Invoking Text Directives</span><a class="self-link" href="#invoking-text-directives"></a></h4>
   <p>This section describes how text directives in a document’s <a data-link-type="dfn" href="#document-uninvoked-directives" id="ref-for-document-uninvoked-directives①">uninvoked directives</a> are
processed and invoked to cause indication of the relevant text passages.</p>
   <div class="note" role="note">
     The summarized changes in this section: 
    <ul>
     <li data-md>
      <p>Modify the indicated part processing model to try processing <a data-link-type="dfn" href="#document-uninvoked-directives" id="ref-for-document-uninvoked-directives②">uninvoked directives</a> into a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range">range</a> that will be returned as the indicated part.</p>
     <li data-md>
      <p>Modify "scrolling to a fragment" to correctly scroll and set the Document’s target element in the case
of a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range①">range</a> based indicated part.</p>
     <li data-md>
      <p>Ensure <a data-link-type="dfn" href="#document-uninvoked-directives" id="ref-for-document-uninvoked-directives③">uninvoked directives</a> is reset to null when the user agent has finished the
fragment search for the current navigation/traversal.</p>
     <li data-md>
      <p>If the user agent finishes searching for a text directive, ensure it tries the regular
fragment as a fallback.</p>
    </ul>
   </div>
   <p>In <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#the-indicated-part-of-the-document"> indicated part</a>, enable a fragment to indicate a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range②">range</a>. Make the following changes:</p>
   <blockquote>
    <p><strong>Monkeypatching <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scrolling-to-a-fragment"><cite>HTML</cite> § 7.4.6.3 Scrolling to a fragment</a>:</strong></p>
    <div class="monkeypatch">
      For an HTML document <var>document</var>, the following processing model must be followed to determine
  its indicated part: 
     <ol>
      <li data-md>
       <p><span class="diff">Let <var>directives</var> be the document’s <a data-link-type="dfn" href="#document-uninvoked-directives" id="ref-for-document-uninvoked-directives④">uninvoked directives</a>. </span></p>
      <li data-md>
       <p><span class="diff">If <var>directives</var> is non-null and <var>document</var>’s <a data-link-type="dfn" href="#document-allow-text-fragment-scroll" id="ref-for-document-allow-text-fragment-scroll">allow text
  fragment scroll</a> is true then:</span></p>
       <ol>
        <li data-md>
         <p><span class="diff">Let <var>ranges</var> be a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list①">list</a> that is the result of running
  the <a data-link-type="dfn" href="#invoke-text-directives" id="ref-for-invoke-text-directives">invoke text directives</a> steps with <var>directives</var> and the document.</span></p>
        <li data-md>
         <p><span class="diff">If <var>ranges</var> is non-empty, then:</span></p>
         <ol>
          <li data-md>
           <p><span class="diff">Let <var>firstRange</var> be the first item of <var>ranges</var>.</span></p>
          <li data-md>
           <p><span class="diff">Visually indicate each <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range③">range</a> in <var>ranges</var> in an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#implementation-defined" id="ref-for-implementation-defined">implementation-defined</a> way. The indication must not be observable from author
  script. See <a href="#indicating-the-text-match">§ 3.7 Indicating The Text Match</a>.</span></p>
           <div class="note" role="note"> The first <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range④">range</a> in <var>ranges</var> is the one that gets scrolled into view but all
    ranges should be visually indicated to the user. </div>
          <li data-md>
           <p><span class="diff">Set <var>firstRange</var> as <var>document</var>’s indicated part, return.</span></p>
         </ol>
       </ol>
      <li data-md>
       <p>Let fragment be document’s URL’s fragment.</p>
      <li data-md>
       <p>If fragment is the empty string, then return the special value top of the document.</p>
      <li data-md>
       <p>Let potentialIndicatedElement be the result of finding a potential indicated element given
  document and fragment.</p>
      <li data-md>
       <p>...</p>
     </ol>
    </div>
   </blockquote>
   <p>In <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-the-fragment-identifier" id="ref-for-scroll-to-the-fragment-identifier">scroll to the fragment</a>, handle a indicated part that is a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range⑤">range</a> and also
prevent fragment scrolling if the force-load-at-top policy is enabled. Make the following changes:</p>
   <blockquote>
    <p><strong>Monkeypatching <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scrolling-to-a-fragment"><cite>HTML</cite> § 7.4.6.3 Scrolling to a fragment</a>:</strong></p>
    <div class="monkeypatch">
     <ol>
      <li data-md>
       <p>If document’s indicated part is null, then set document’s target element to null.</p>
      <li data-md>
       <p>Otherwise, if document’s indicated part is top of the document, then:</p>
       <ol>
        <li data-md>
         <p>Set document’s target element to null.</p>
        <li data-md>
         <p>Scroll to the beginning of the document for document.</p>
        <li data-md>
         <p>Return.</p>
       </ol>
      <li data-md>
       <p>Otherwise:</p>
       <ol>
        <li data-md>
         <p class="assertion">Assert: document’s indicated part is an element <span class="diff">or it is a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range⑥">range</a>.</span></p>
        <li data-md>
         <p><span class="diff">Let <var>scrollTarget</var> be <var>document</var>’s indicated part.</span></p>
        <li data-md>
         <p><span class="diff">Let <var>target</var> be <var>scrollTarget</var>.</span></p>
        <li data-md>
         <p><span class="diff">If <var>target</var> is a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range⑦">range</a>, then:</span></p>
         <ol>
          <li data-md>
           <p><span class="diff">Set <var>target</var> to be the <a data-link-type="dfn" href="#first-common-ancestor" id="ref-for-first-common-ancestor">first common ancestor</a> of <var>target</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-node" id="ref-for-concept-range-start-node">start node</a> and <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end-node" id="ref-for-concept-range-end-node">end node</a>.</span></p>
          <li data-md>
           <p><span class="diff">While <var>target</var> is non-null and is not an <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-element" id="ref-for-concept-element">element</a>, set <var>target</var> to <var>target</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-tree-parent" id="ref-for-concept-tree-parent">parent</a>.</span></p>
           <div class="issue" id="issue-424a4e25"><a class="self-link" href="#issue-424a4e25"></a> What should be set as target if inside a shadow tree? <a href="https://github.com/WICG/scroll-to-text-fragment/issues/190">#190</a> </div>
         </ol>
        <li data-md>
         <p><span class="diff">Assert: <var>target</var> is an <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-element" id="ref-for-concept-element①">element</a>.</span></p>
        <li data-md>
         <p>Set <var>document</var>’s target element to <var>target</var>.</p>
        <li data-md>
         <p>Run the ancestor details revealing algorithm on <var>target</var>.</p>
        <li data-md>
         <p>Run the ancestor hidden-until-found revealing algorithm on <var>target</var>.</p>
         <div class="issue" id="issue-10739530"><a class="self-link" href="#issue-10739530"></a> These revealing algorithms currently wont work well since <var>target</var> could be an
      ancestor or even the root document node. Issue <a href="https://github.com/WICG/scroll-to-text-fragment/issues/89">#89</a> proposes
      restricting matches to <code>contain:style layout</code> blocks which would resolve this
      problem. </div>
        <li data-md>
         <p><span class="diff">Let <var>blockPosition</var> be "center" if <var>scrollTarget</var> is a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range⑧">range</a>,
  "start" otherwise.</span></p>
         <div class="note" role="note"> Scrolling to a text directive centers it in the block flow direction. </div>
        <li data-md>
         <strike class="diff">Scroll target into view, with behavior set to "auto", block set to
  "start", and inline set to "nearest".</strike>
        <li value="10">
         <span class="diff"><a data-link-type="dfn" href="https://drafts.csswg.org/cssom-view-1/#scroll-a-target-into-view" id="ref-for-scroll-a-target-into-view">scroll a target into view</a>,
  with <em>target</em> set to <var>scrollTarget</var>, <em>behavior</em> set to "auto", <em>block</em> set to <var>blockPosition</var>, and <em>inline</em> set to "nearest".</span> 
         <p><span class="diff">Implementations MAY avoid scrolling to the target if it is
  produced from a <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive③">text directive</a>.</span></p>
        <p></p>
        <li data-md>
         <p>Run the focusing steps for target, with the Document’s viewport as the fallback target.</p>
         <div class="issue" id="issue-e253a983"><a class="self-link" href="#issue-e253a983"></a>Implementation note: Blink doesn’t currently set focus for text
  fragments, it probably should? TODO: file crbug.</div>
        <li data-md>
         <p>Move the sequential focus navigation starting point to target.</p>
       </ol>
     </ol>
    </div>
   </blockquote>
   <p>The next two monkeypatches ensure the user agent clears <a data-link-type="dfn" href="#document-uninvoked-directives" id="ref-for-document-uninvoked-directives⑤">uninvoked directives</a> when
the fragment search is complete. In the case where a text directive search finishes because parsing
has stopped, it tries one more search for a non-text directive fragment.</p>
   <p>In the definition of <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#try-to-scroll-to-the-fragment" id="44bd3acf0"> try to scroll to the fragment</a>:</p>
   <blockquote>
    <p><strong>Monkeypatching <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scrolling-to-a-fragment"><cite>HTML</cite> § 7.4.6.3 Scrolling to a fragment</a>:</strong></p>
    <div class="monkeypatch">
      To try to scroll to the fragment for a Document <var>document</var>, perform the following steps in
  parallel: 
     <ol>
      <li data-md>
       <p>Wait for an implementation-defined amount of time. (This is intended to allow the user agent
  to optimize the user experience in the face of performance concerns.)</p>
      <li data-md>
       <p>Queue a global task on the navigation and traversal task source given document’s relevant
  global object to run these steps:</p>
       <ol>
        <li data-md>
         <strike class="diff">If document has no parser, or its parser has stopped parsing, or the user agent
  has reason to believe the user is no longer interested in scrolling to the fragment, then
  abort these steps.</strike>
        <li class="diff" value="1">
         If the user agent has reason to believe the user is no longer interested in scrolling to
  the fragment, then: 
         <ol>
          <li data-md>
           <p><span class="diff">Set <a data-link-type="dfn" href="#document-uninvoked-directives" id="ref-for-document-uninvoked-directives⑥">uninvoked directives</a> to null.</span></p>
          <li data-md>
           <p><span class="diff">Abort these steps.</span></p>
         </ol>
        <li data-md>
         <p><span class="diff">If the document has no parser, or its parser has stopped parsing,
  then:</span></p>
        <p></p>
        <ol>
         <li data-md>
          <p><span class="diff">If <a data-link-type="dfn" href="#document-uninvoked-directives" id="ref-for-document-uninvoked-directives⑦">uninvoked directives</a> is not null, then:</span></p>
          <ol>
           <li data-md>
            <p><span class="diff">Set <a data-link-type="dfn" href="#document-uninvoked-directives" id="ref-for-document-uninvoked-directives⑧">uninvoked directives</a> to null.</span></p>
           <li data-md>
            <p><span class="diff"><a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-the-fragment-identifier" id="ref-for-scroll-to-the-fragment-identifier①">Scroll to the fragment</a> given <var>document</var>.</span></p>
          </ol>
         <li data-md>
          <p><span class="diff">Abort these steps.</span></p>
        </ol>
        <li data-md>
         <p>Scroll to the fragment given document.</p>
        <li data-md>
         <p>If document’s indicated part is still null, then try to scroll to the fragment for
  document. <span class="diff">Otherwise, set <a data-link-type="dfn" href="#document-uninvoked-directives" id="ref-for-document-uninvoked-directives⑨">uninvoked directives</a> to
  null.</span></p>
       </ol>
     </ol>
    </div>
   </blockquote>
   <p>In the definition of <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate-fragid"> navigate to a fragment</a>:</p>
   <blockquote>
    <p><strong>Monkeypatching <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-fragid"><cite>HTML</cite> § 7.4.2.3.3 Fragment navigations</a>:</strong></p>
    <div class="monkeypatch">
     To navigate to a fragment given navigable <var>navigable</var>, ...: 
     <ol>
      <li data-md>
       <p>...</p>
      <li value="8">Update document for history step application given navigable’s active
document, historyEntry, true, scriptHistoryIndex, and scriptHistoryLength. 
      <li data-md>
       <p>Scroll to the fragment given navigable’s active document.</p>
      <li class="diff">Set <var>navigable</var>’s active document’s <a data-link-type="dfn" href="#document-uninvoked-directives" id="ref-for-document-uninvoked-directives①⓪">uninvoked directives</a> to
null.
      <li data-md>
       <p>Let traversable be navigable’s traversable navigable.</p>
      <li data-md>
       <p>...</p>
     </ol>
    </div>
   </blockquote>
   <p>Scrolling to the indicated part is only one of several things that happens from "scroll to the
fragment". Rename it and related definitions:</p>
   <blockquote>
    <p><strong>Monkeypatching <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-fragid"><cite>HTML</cite> § 7.4.2.3.3 Fragment navigations</a>:</strong></p>
    <p>Rename <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-fragid"><cite>HTML</cite> § 7.4.2.3.3 Fragment navigations</a> and related steps to "indicating a fragment" to reflect its
  broader effects.</p>
   </blockquote>
   <h3 class="heading settled" data-level="3.5" id="security-and-privacy"><span class="secno">3.5. </span><span class="content">Security and Privacy</span><a class="self-link" href="#security-and-privacy"></a></h3>
   <h4 class="heading settled" data-level="3.5.1" id="motivation"><span class="secno">3.5.1. </span><span class="content">Motivation</span><a class="self-link" href="#motivation"></a></h4>
   <div class="note" role="note">This section is non-normative</div>
   <p>Care must be taken when implementing <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive④">text directive</a> so that it
cannot be used to exfiltrate information across origins. Scripts can navigate a
page to a cross-origin URL with a <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive⑤">text directive</a>. If a malicious
actor can determine that the text fragment was successfully found in victim
page as a result of such a navigation, they can infer the existence of any text
on the page.</p>
   <p>The processing model in the following subsections restricts the feature to
mitigate the expected attack vectors. In summary, text directives are restricted
to:</p>
   <ul>
    <li data-md>
     <p>top level navigables (i.e. no iframes).</p>
     <ul>
      <li data-md>
       <p class="issue" id="issue-35f490f0"><a class="self-link" href="#issue-35f490f0"></a> This isn’t strictly true, Chrome
allows this for same-origin initiators. Need to update the spec on this
point. <a href="https://github.com/WICG/scroll-to-text-fragment/issues/240">[Issue #WICG/scroll-to-text-fragment#240]</a></p>
     </ul>
    <li data-md>
     <p>navigations that are the result of a user action</p>
    <li data-md>
     <p>in cases where the navigation has a cross-origin initiator, the destination
must be opener isolated (i.e. no references to its global objects in other
documents)</p>
   </ul>
   <h4 class="heading settled" data-level="3.5.2" id="scroll-on-navigation"><span class="secno">3.5.2. </span><span class="content">Scroll On Navigation</span><a class="self-link" href="#scroll-on-navigation"></a></h4>
   <p>A UA may choose to automatically scroll a matched text passage into view. This
can be a convenient experience for the user but does present some risks that
implementing UAs need to be aware of.</p>
   <p>There are known (and potentially unknown) ways a scroll on navigation might be
detectable and distinguished from natural user scrolls.</p>
   <div class="example" id="example-fe268bc5"><a class="self-link" href="#example-fe268bc5"></a> An origin embedded in an iframe in the target page registers an
  IntersectionObserver and determines in the first 500ms of page load whether
  a scroll has occurred. This scroll can be indicative of whether the text
  fragment was successfully found on the page. </div>
   <div class="example" id="example-ce37442a"><a class="self-link" href="#example-ce37442a"></a> Two users share the same network on which traffic is visible between them.
  A malicious user sends the victim a link with a text fragment to a
  page. The searched-for text appears nearby to a resource located on a unique
  (on the page) domain. The attacker may be able to infer the success or failure
  of the fragment search based on the order of requests for DNS lookup. </div>
   <div class="example" id="example-2e4f39df"><a class="self-link" href="#example-2e4f39df"></a> An attacker sends a link to a victim, sending them to a page that displays
  a private token. The attacker asks the victim to read back the token. Using
  a text fragment, the attacker gets the page to load for the victim such that
  warnings about keeping the token secret are scrolled out of view. </div>
   <p>All known cases like this rely on specific circumstances about the target page
so don’t apply generally. With additional restrictions about when the text
fragment can invoke an attacker is further restricted. Nonetheless, different
UAs can come to different conclusions about whether these risks are acceptable.
UAs need to consider these factors when determining whether to scroll as part of
navigating to a text fragment.</p>
   <p>Conforming UAs may choose not to scroll automatically on navigation. Such UAs
may, instead, provide UI to initiate the scroll ("click to scroll") or none
at all. In these cases UA should provide some indication to the user that an
indicated passage exists further down on the page.</p>
   <p>The examples above illustrate that in specific circumstances, it can be
possible for an attacker to extract 1 bit of information about content on the
page. However, care must be taken so that such opportunities cannot be
exploited to extract arbitrary content from the page by repeating the attack.
For this reason, restrictions based on user activation and browsing context
isolation are very important and must be implemented.</p>
   <div class="note" role="note">
     Browsing context isolation ensures that no other document can script the
  target document which helps reduce the attack surface. 
    <p>However, it also ensures any malicious use is difficult to hide. A browsing
  context that’s the only one in a group will be a top level browsing context
  (i.e. a full tab/window).</p>
   </div>
   <p>If a UA does choose to scroll automatically, it must ensure no scrolling is
performed while the document is in the background (for example, in an inactive
tab). This ensures any malicious usage is visible to the user and prevents
attackers from trying to secretly automate a search in background documents.</p>
   <p>If a UA chooses not to scroll automatically, it must scroll a fallback
element-id into view, if provided, regardless of whether a text fragment was
matched. Not doing so would allow detecting the text fragment match based on
whether the element-id was scrolled.</p>
   <h4 class="heading settled" data-level="3.5.3" id="search-timing"><span class="secno">3.5.3. </span><span class="content">Search Timing</span><a class="self-link" href="#search-timing"></a></h4>
   <p>A naive implementation of the text search algorithm could allow information
exfiltration based on runtime duration differences between a matching and non-
matching query. If an attacker could find a way to synchronously navigate
to a <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive⑥">text directive</a>-invoking URL, they would be able to determine
the existence of a text snippet by measuring how long the navigation call takes.</p>
   <div class="note" role="note"> The restrictions in <a href="#restricting-the-text-fragment">§ 3.5.4 Restricting the Text Fragment</a> prevent this
  specific case; in particular, the no-same-document-navigation restriction.
  However, these restrictions are provided as multiple layers of defence. </div>
   <p>For this reason, the implementation <em>must ensure the runtime of <a href="#navigating-to-text-fragment">§ 3.6 Navigating to a Text Fragment</a> steps does not differ based on whether a match
has been successfully found</em>.</p>
   <p>This specification does not specify exactly how a UA achieves this as there are
multiple solutions with differing tradeoffs. For example, a UA <em>may</em> continue to walk the tree even after a match is found in <a data-link-type="dfn" href="#find-a-range-from-a-text-directive" id="ref-for-find-a-range-from-a-text-directive">find a range from a
text directive</a>.  Alternatively, it <em>may</em> schedule an asynchronous task
to find and set the <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document①">Document</a>'s indicated part.</p>
   <h4 class="heading settled" data-level="3.5.4" id="restricting-the-text-fragment"><span class="secno">3.5.4. </span><span class="content">Restricting the Text Fragment</span><a class="self-link" href="#restricting-the-text-fragment"></a></h4>
   <p>Amend the definition of a <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request">request</a> and of a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document②">Document</a> to include a new
boolean <a data-link-type="dfn" href="#document-text-directive-user-activation" id="ref-for-document-text-directive-user-activation">text directive user activation</a> field:</p>
   <blockquote>
    <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-fetch" title="Fetch Standard">[FETCH]</a>:</strong></p>
    <p>A <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request①">request</a> has an associated boolean <dfn class="dfn-paneled" data-dfn-for="request" data-dfn-type="dfn" data-noexport id="request-text-directive-user-activation">text directive user activation</dfn>,
  initially false.</p>
   </blockquote>
   <blockquote>
    <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a>:</strong></p>
    <p>Each <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document③">Document</a> has a <dfn class="dfn-paneled" data-dfn-for="document" data-dfn-type="dfn" data-noexport id="document-text-directive-user-activation">text directive user activation</dfn>, which is a boolean,
  initially false.</p>
    <div class="note" role="note">
      <a data-link-type="dfn" href="#document-text-directive-user-activation" id="ref-for-document-text-directive-user-activation①">text directive user activation</a> provides the necessary user gesture signal to allow
    a single activation of a text fragment. It is set to true during document loading only if the
    navigation occurred as a result of a user activation and is propagated across client-side
    redirects. 
     <p>If a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document④">Document</a>'s <a data-link-type="dfn" href="#document-text-directive-user-activation" id="ref-for-document-text-directive-user-activation②">text directive user activation</a> isn’t used to activate a text
    fragment, it is instead used to set a new navigation <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request②">request</a>'s <a data-link-type="dfn" href="#request-text-directive-user-activation" id="ref-for-request-text-directive-user-activation">text directive user activation</a> to true. In this way, a <a data-link-type="dfn" href="#document-text-directive-user-activation" id="ref-for-document-text-directive-user-activation③">text directive user activation</a> can be propagated
    from one <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document⑤">Document</a> to another across a navigation.</p>
     <p>Both <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document⑥">Document</a>'s <a data-link-type="dfn" href="#document-text-directive-user-activation" id="ref-for-document-text-directive-user-activation④">text directive user activation</a> and <a data-link-type="dfn" href="https://fetch.spec.whatwg.org/#concept-request" id="ref-for-concept-request③">request</a>'s <a data-link-type="dfn" href="#request-text-directive-user-activation" id="ref-for-request-text-directive-user-activation①">text directive user activation</a> are always set to false when used, such that a
    single user activation cannot be reused to activate more than one text fragment.</p>
    </div>
   </blockquote>
   <div class="note" role="note">
    <p>
      This mechanism allows text fragments to activate through a common redirect
    technique used by many popular web sites. Such sites redirect users to
    their intended destination by responding with a 200 status code containing
    script to set the 
     <tt>window.location</tt>
     . 
    </p>
    <p>
      Unlike real HTTP (
     <tt>status 3xx</tt>
     ) redirects, these "client-side"
    redirects cannot propagate the fact that the navigation is the result of a
    user gesture. The <a data-link-type="dfn" href="#document-text-directive-user-activation" id="ref-for-document-text-directive-user-activation⑤">text directive user activation</a> mechanism allows passing
    through this specifically scoped user-activation through such navigations.
    This means a page is able to programmatically navigate to a text fragment, a
    single time, as if it has a user gesture. However, since this resets <code>text fragment user
    activation</code>, further text fragment navigations will not activation without a new user gesture. 
    </p>
    <p> The following diagram demonstrates how the flag is used to activate a text
    fragment through a client-side redirect service: </p>
    <p><img alt="Diagram showing how a text fragment flag is set and used" height="671" src="https://raw.githubusercontent.com/WICG/scroll-to-text-fragment/master/text_fragment_activation_flag.png" style="margin-left:auto;margin-right:auto;display:block" width="745"></p>
    <p> See <a href="redirects.md">redirects.md</a> for a more in-depth discussion. </p>
   </div>
   <blockquote>
    <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a>:</strong></p>
    <p>Each <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document⑦">Document</a> has an <dfn class="dfn-paneled" data-dfn-for="document" data-dfn-type="dfn" data-noexport id="document-allow-text-fragment-scroll">allow text fragment scroll</dfn>, which is a
  boolean, initially false.</p>
    <div class="note" role="note">
     <p> <a data-link-type="dfn" href="#document-allow-text-fragment-scroll" id="ref-for-document-allow-text-fragment-scroll①">allow text fragment scroll</a> is used to determine whether a text fragment will
      perform scrolling when the document is loaded. If it is false, the text fragment can be
      visually indicated but will not be scrolled to. This implements the mitigations discussed in <a href="#scroll-on-navigation">§ 3.5.2 Scroll On Navigation</a>. </p>
     <p> The reason we compute and store allow text fragment scroll, rather than performing these
      checks at the time of use, is that it relies on the properties of the navigation while the
      invocation will occur as part of the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-the-fragment-identifier" id="ref-for-scroll-to-the-fragment-identifier②">scroll to the fragment</a> steps which can
      happen outside the context of a navigation. </p>
    </div>
   </blockquote>
   <div class="note" role="note"> TODO: This should really only prevent potentially observable side-effects like
  automatic scrolling. Unobservable effects like a highlight could be safely
  allowed in all cases. </div>
   <p>Amend the definition of <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params">navigation params</a> to include a new field:</p>
   <blockquote>
    <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a>:</strong></p>
    <dl>
     <dt><dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="user-involvement">user involvement</dfn>
     <dd>A <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#user-navigation-involvement">user navigation involvement</a> value.
    </dl>
    <p>Initialize <a data-link-type="dfn" href="#user-involvement" id="ref-for-user-involvement">user involvement</a> value everywhere a navigation params is created, in particular,
amend the definition of <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#attempt-to-populate-the-history-entry’s-document">attempt to populate the history entry’s document</a> to take a user navigation involvement as a parameter, using it to populate the field when creating
a new navigation params.</p>
   </blockquote>
   <p>Amend <a href="https://html.spec.whatwg.org/multipage/document-lifecycle.html#initialise-the-document-object">create
and initialize a Document object</a> to take the initiator origin as a new parameter:</p>
   <blockquote>
    <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a>:</strong></p>
    <div class="monkeypatch">A session history entry is a struct with the following items:
    To load an HTML document, given navigation params navigationParams <span class="diff">and <a href="https://html.spec.whatwg.org/multipage/browsers.html#concept-origin">origin</a> <var>initiatorOrigin</var></span>: </div>
   </blockquote>
   <p>and pass the initiator origin as an argument wherever it is called, specifically through the <a href="https://html.spec.whatwg.org/multipage/document-lifecycle.html#navigate-html">load an HTML
document</a> steps and the <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#loading-a-document">Load a
document</a> steps:</p>
   <blockquote>
    <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a>:</strong></p>
    <div class="monkeypatch">
     <dl class="switch">
      <dt>an <span>HTML MIME type</span>
      <dd> Return the result of loading an HTML document, given <var>navigationParams</var> <span class="diff">and <var>initiatorOrigin</var></span>. </dd>
      <dl></dl>
     </dl>
    </div>
   </blockquote>
   <p>and amend the <a href="https://html.spec.whatwg.org/multipage/document-lifecycle.html#initialise-the-document-object">create
and initialize a Document object</a> steps by adding the following steps before returning <var>document</var>:</p>
   <blockquote>
    <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a>:</strong></p>
    <ol start="19">
     <li data-md>
      <p>Set <var>document</var>’s <a data-link-type="dfn" href="#document-text-directive-user-activation" id="ref-for-document-text-directive-user-activation⑥">text directive user activation</a> to true if any of the following
conditions hold, false otherwise:</p>
      <ul>
       <li data-md>
        <p><var>navigationParams</var>’s <a data-link-type="dfn" href="#user-involvement" id="ref-for-user-involvement①">user involvement</a> is "<code>activation</code>";</p>
       <li data-md>
        <p><var>navigationParams</var>’s <a data-link-type="dfn" href="#user-involvement" id="ref-for-user-involvement②">user involvement</a> is "<code>browser UI</code>"; or</p>
       <li data-md>
        <p><var>navigationParams</var>’s <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-request">request</a>’s <a data-link-type="dfn" href="#request-text-directive-user-activation" id="ref-for-request-text-directive-user-activation②">text directive user activation</a> is true.</p>
        <div class="note" role="note"> It’s important that <a data-link-type="dfn" href="#document-text-directive-user-activation" id="ref-for-document-text-directive-user-activation⑦">text directive user activation</a> not be copyable so that
  only one text fragment can be activated per user-activated navigation. </div>
      </ul>
     <li data-md>
      <p>Set <var>document</var>’s <a data-link-type="dfn" href="#document-allow-text-fragment-scroll" id="ref-for-document-allow-text-fragment-scroll②">allow text fragment scroll</a> by following these sub-steps:</p>
      <ol>
       <li data-md>
        <p>If <var>document</var>’s <a data-link-type="dfn" href="#document-uninvoked-directives" id="ref-for-document-uninvoked-directives①①">uninvoked directives</a> field is null or empty, set <a data-link-type="dfn" href="#document-allow-text-fragment-scroll" id="ref-for-document-allow-text-fragment-scroll③">allow text fragment scroll</a> to false and abort these sub-steps.</p>
       <li data-md>
        <p>Let <var>text directive user activation</var> be the value of <var>document</var>’s <a data-link-type="dfn" href="#document-text-directive-user-activation" id="ref-for-document-text-directive-user-activation⑧">text directive user activation</a> and set <var>document</var>’s <a data-link-type="dfn" href="#document-text-directive-user-activation" id="ref-for-document-text-directive-user-activation⑨">text directive user activation</a> to false.</p>
       <li data-md>
        <p>If <var>navigationParam</var>’s <a data-link-type="dfn" href="#user-involvement" id="ref-for-user-involvement③">user involvement</a> is "<code>browser UI</code>", set <a data-link-type="dfn" href="#document-allow-text-fragment-scroll" id="ref-for-document-allow-text-fragment-scroll④">allow text fragment scroll</a> to true and abort these sub-steps.</p>
        <div class="note" role="note">
         <p> If a navigation originates from browser UI, it’s always ok to allow it
      since it’ll be user triggered and the page/script isn’t providing the
      text snippet. </p>
         <p> Note: The intent in this item is to distinguish cases where the
      app/page is able to control the URL from those that are fully
      under the user’s control. In the former we want to prevent
      scrolling of the text fragment unless the destination is loaded
      in a separate browsing context group (so that the source cannot
      both control the text snippet and observe side-effects in the
      navigation). There are some cases where "browser UI" may be a
      grey area in this regard. E.g. an "open in new window" context
      menu item when right clicking on a link. </p>
         <p> See <a href="https://w3c.github.io/webappsec-fetch-metadata/#directly-user-initiated">sec-fetch-site</a> in <a data-link-type="biblio" href="#biblio-fetch-metadata" title="Fetch Metadata Request Headers">[FETCH-METADATA]</a> for a related discussion of how this applies. </p>
        </div>
       <li data-md>
        <p>If <var>text directive user activation</var> is false, or <var>browsing context</var> is
  not a top-level browsing context, set <a data-link-type="dfn" href="#document-allow-text-fragment-scroll" id="ref-for-document-allow-text-fragment-scroll⑤">allow text fragment scroll</a> to false and abort these sub-steps.</p>
       <li data-md>
        <p>If <var>navigationParam</var>’s <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigation-params-origin"> origin</a> is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsers.html#same-origin" id="ref-for-same-origin">same origin</a> with <var>initiatorOrigin</var> set <a data-link-type="dfn" href="#document-allow-text-fragment-scroll" id="ref-for-document-allow-text-fragment-scroll⑥">allow text fragment scroll</a> to true and abort these
  sub-steps.</p>
       <li data-md>
        <p>If <var>document</var>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc" id="ref-for-concept-document-bc">browsing context</a>'s <a href="https://html.spec.whatwg.org/multipage/browsers.html#tlbc-group">group</a>’s <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context-set" id="ref-for-browsing-context-set">browsing context set</a> has length 1, set <a data-link-type="dfn" href="#document-allow-text-fragment-scroll" id="ref-for-document-allow-text-fragment-scroll⑦">allow text fragment scroll</a> to true and abort these sub-steps.</p>
        <div class="note" role="note"> i.e. Only allow navigation from a cross-origin element/script if the
    document is loaded in a noopener context. That is, a new top level
    browsing context group to which the navigator does not have script access
    and which can be placed into a separate process. </div>
       <li data-md>
        <p>Otherwise, set <a data-link-type="dfn" href="#document-allow-text-fragment-scroll" id="ref-for-document-allow-text-fragment-scroll⑧">allow text fragment scroll</a> to false.</p>
      </ol>
    </ol>
   </blockquote>
   <p>Amend step 2 of the <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#process-a-navigate-fetch"> process a navigate fetch</a> steps to additionally set <var>request</var>’s <a data-link-type="dfn" href="#request-text-directive-user-activation" id="ref-for-request-text-directive-user-activation③">text directive user activation</a> to the value of the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document" id="ref-for-nav-document①">active document</a>'s <a data-link-type="dfn" href="#document-text-directive-user-activation" id="ref-for-document-text-directive-user-activation①⓪">text directive user activation</a> and set the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document" id="ref-for-nav-document②">active document</a>'s value to
false.</p>
   <blockquote>
    <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a>:</strong></p>
    <ol start="2">
     <li data-md>
      <p>Set request’s client to sourceBrowsingContext’s active document’s relevant
  settings object, destination to "document", mode to "navigate", credentials
  mode to "include", use-URL-credentials flag, redirect mode to "manual",
  replaces client id to browsingContext’s active document’s relevant settings
  object’s id, and <a data-link-type="dfn" href="#request-text-directive-user-activation" id="ref-for-request-text-directive-user-activation④">text directive user activation</a> to
  sourceBrowsingContext’s active document’s <a data-link-type="dfn" href="#document-text-directive-user-activation" id="ref-for-document-text-directive-user-activation①①">text directive user activation</a>. Set sourceBrowsingContext’s active
  document’s <a data-link-type="dfn" href="#document-text-directive-user-activation" id="ref-for-document-text-directive-user-activation①②">text directive user activation</a> to false.</p>
    </ol>
   </blockquote>
   <p>Amend the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#try-to-scroll-to-the-fragment" id="ref-for-try-to-scroll-to-the-fragment">try to scroll to the fragment</a> steps by replacing the
steps of the task queued in step 2:</p>
   <blockquote>
    <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a>:</strong></p>
    <ol>
     <li data-md>
      <p>If document has no parser, or its parser has stopped parsing, or the user
  agent has reason to believe the user is no longer interested in scrolling to
  the fragment, then set <em>document</em>’s <a data-link-type="dfn" href="#document-allow-text-fragment-scroll" id="ref-for-document-allow-text-fragment-scroll⑨">allow text fragment scroll</a> to false and abort these steps.</p>
     <li data-md>
      <p>Scroll to the fragment given in document’s URL. If this does not find an
  indicated part, then try to scroll to the fragment for
  document.</p>
     <li data-md>
      <p>Set <em>document</em>’s <a data-link-type="dfn" href="#document-allow-text-fragment-scroll" id="ref-for-document-allow-text-fragment-scroll①⓪">allow text fragment scroll</a> to false.</p>
    </ol>
   </blockquote>
   <h4 class="heading settled" data-level="3.5.5" id="restricting-scroll-on-load"><span class="secno">3.5.5. </span><span class="content">Restricting Scroll on Load</span><a class="self-link" href="#restricting-scroll-on-load"></a></h4>
   <p>This section defines how the <code>force-load-at-top</code> policy is used to prevent all
types of scrolling when loading a new document, including but not limited to
text directives.</p>
   <p class="issue" id="issue-de0fed9d"><a class="self-link" href="#issue-de0fed9d"></a> Need to decide how <code>force-load-at-top</code> interacts with the Navigation API. <a href="https://github.com/WICG/scroll-to-text-fragment/issues/242">[Issue #WICG/scroll-to-text-fragment#242]</a></p>
   <p>Amend the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#restore-persisted-state" id="ref-for-restore-persisted-state">restore persisted state</a> steps to take a new boolean
parameter which suppresses scroll restoration:</p>
   <blockquote>
    <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a>:</strong></p>
    <div class="monkeypatch">
      To restore persisted state from a session history entry <var>entry</var> <span class="diff">, and boolean <var>suppressScrolling</var></span>: 
     <ol>
      <li data-md>
       <p>If entry’s scroll restoration mode is "auto", <span class="diff"><var>suppressScrolling</var> is false,</span> and entry’s document’s relevant global object’s navigation API’s suppress
normal scroll restoration during ongoing navigation is false, then restore scroll position
data given entry.</p>
      <li data-md>
       <p>...</p>
     </ol>
    </div>
   </blockquote>
   <p>Amend the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#update-document-for-history-step-application" id="ref-for-update-document-for-history-step-application">update document for history step application</a> steps
to check the <code>force-load-at-top</code> policy and avoid scrolling in a new document
if it’s set.</p>
   <blockquote>
    <p><strong>Monkeypatching <a data-link-type="biblio" href="#biblio-html" title="HTML Standard">[HTML]</a>:</strong></p>
    <div class="monkeypatch">
     <ol>
      <li data-md>
       <p>...</p>
      <li value="4">Set document’s history object’s length to scriptHistoryLength.
      <li data-md>
       <p><span class="diff">Let <var>scrollingBlockedInNewDocument</var> be the result of <a href="https://wicg.github.io/document-policy#algo-get-policy-value">getting the policy
  value</a> for <code>force-load-at-top</code> for <var>document</var>.</span></p>
      <li data-md>
       <p>If documentsEntryChanged is true, then:</p>
       <ol>
        <li data-md>
         <p>Let oldURL be document’s latest entry’s URL.</p>
        <li data-md>
         <p>...</p>
        <li value="5">
          If documentIsNew is false, then: 
         <ol>
          <li data-md>
           <p>Update the navigation API entries for a same-document navigation given navigation,
  entry, and "traverse".</p>
          <li data-md>
           <p>Fire an event named popstate...</p>
          <li data-md>
           <p>Restore persisted state given entry <span class="diff">and <var>suppressScrolling</var> set to false.</span></p>
          <li data-md>
           <p>If oldURL’s fragment is not equal to...</p>
         </ol>
        <li data-md>
         <p>Otherwise,</p>
         <ol>
          <li data-md>
           <p class="assertion">Assert: entriesForNavigationAPI is given.</p>
          <li data-md>
           <p>Restore persisted state given entry <span class="diff">and <var>scrollingBlockedInNewDocument</var>.</span></p>
          <li data-md>
           <p>Initialize the navigation API entries for a new document given navigation,
  entriesForNavigationAPI, and entry.</p>
         </ol>
       </ol>
      <li data-md>
       <p>If documentIsNew is true, then:</p>
       <ol>
        <li data-md>
         <p><span class="diff">If <var>scrollingBlockedInNewDocument</var> is false,</span> try to scroll to
  the fragment for document.</p>
        <li data-md>
         <p>At this point scripts may run for the newly-created document document.</p>
       </ol>
      <li data-md>
       <p>Otherwise, if documentsEntryChanged is false and doNotReactivate is false, then:</p>
       <ol>
        <li data-md>
         <p>...</p>
       </ol>
     </ol>
    </div>
   </blockquote>
   <h3 class="heading settled" data-level="3.6" id="navigating-to-text-fragment"><span class="secno">3.6. </span><span class="content">Navigating to a Text Fragment</span><a class="self-link" href="#navigating-to-text-fragment"></a></h3>
   <div class="note" role="note"> The text fragment specification proposes an amendment to <a href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-fragid"><cite>HTML</cite> § 7.4.2.3.3 Fragment navigations</a>. In summary, if a <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive⑦">text directive</a> is
present and a match is found in the page, the text fragment takes precedent over
the element fragment as the indicated part. We amend the HTML Document’s
indicated part processing model to return a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range⑨">range</a>, rather than an <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-element" id="ref-for-concept-element②">element</a>, that will be scrolled into view. </div>
   <div class="algorithm" data-algorithm="first common ancestor">
     To find the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="first-common-ancestor">first common ancestor</dfn> of two nodes <var>nodeA</var> and <var>nodeB</var>,
follow these steps: 
    <ol class="algorithm">
     <li data-md>
      <p>Let <var>commonAncestor</var> be <var>nodeA</var>.</p>
     <li data-md>
      <p>While <var>commonAncestor</var> is non-null and is not a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-including-inclusive-ancestor" id="ref-for-concept-shadow-including-inclusive-ancestor">shadow-including inclusive
ancestor</a> of <var>nodeB</var>, let <var>commonAncestor</var> be <var>commonAncestor</var>’s <a data-link-type="dfn" href="#shadow-including-parent" id="ref-for-shadow-including-parent">shadow-including parent</a>.</p>
     <li data-md>
      <p>Return <var>commonAncestor</var>.</p>
    </ol>
   </div>
   <div class="algorithm" data-algorithm="shadow-including parent">
     To find the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="shadow-including-parent">shadow-including parent</dfn> of <var>node</var> follow these steps: 
    <ol class="algorithm">
     <li data-md>
      <p>If <var>node</var> is a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-root" id="ref-for-concept-shadow-root">shadow root</a>, return <var>node</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-documentfragment-host" id="ref-for-concept-documentfragment-host">host</a>.</p>
     <li data-md>
      <p>Otherwise, return <var>node</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-tree-parent" id="ref-for-concept-tree-parent①">parent</a>.</p>
    </ol>
   </div>
   <h4 class="heading settled" data-level="3.6.1" id="finding-ranges-in-a-document"><span class="secno">3.6.1. </span><span class="content">Finding Ranges in a Document</span><a class="self-link" href="#finding-ranges-in-a-document"></a></h4>
   <div class="note" role="note">
     This section outlines several algorithms and definitions that specify how to
  turn a full fragment directive string into a list of <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range①⓪">Ranges</a> in the
  document. 
    <p>At a high level, we take a fragment directive string that looks like this:</p>
<pre>text=prefix-,foo&amp;unknown&amp;text=bar,baz
</pre>
    <p>We break this up into the individual text directives:</p>
<pre>text=prefix-,foo
text=bar,baz
</pre>
    <p>For each text directive, we perform a search in the document for the first
  instance of rendered text that matches the restrictions in the directive.
  Each search is independent of any others; that is, the result is the same
  regardless of how many other directives are provided or their match result.</p>
    <p>If a directive successfully matches to text in the document, it returns a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range①①">range</a> indicating that match in the document. The <a data-link-type="dfn" href="#invoke-text-directives" id="ref-for-invoke-text-directives①">invoke text directives</a> steps are the high level API provided by this
  section. These return a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list②">list</a> of <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range①②">ranges</a> that were matched
  by the individual directive matching steps, in the order the directives were
  specified in the fragment directive string.</p>
    <p>If a directive was not matched, it does not add an item to the returned
  list.</p>
   </div>
   <div class="algorithm" data-algorithm="invoke text directives">
     To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="invoke-text-directives">invoke text directives</dfn>, given as input an <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ascii-string" id="ref-for-ascii-string③">ASCII string</a> <var>text directives</var> and a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document⑧">Document</a> <var>document</var>, run these steps: 
    <div class="note" role="note"> This algorithm takes as input a <var>text directives</var>, that is the
  raw text of the fragment directive and the <var>document</var> over which it operates.
  It returns a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list③">list</a> of <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range①③">ranges</a> that are to be visually
  indicated, the first of which will be scrolled into view (if the UA scrolls
  automatically). </div>
    <ol class="algorithm">
     <li data-md>
      <p>If <var>text directives</var> is not a <a data-link-type="dfn" href="#valid-fragment-directive" id="ref-for-valid-fragment-directive">valid fragment directive</a>, then
return an empty <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list④">list</a>.</p>
     <li data-md>
      <p>Let <var>directives</var> be a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑤">list</a> of <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ascii-string" id="ref-for-ascii-string④">ASCII string</a>s
that is the result of <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#strictly-split" id="ref-for-strictly-split">strictly splitting the
string</a> <var>text directives</var> on "&amp;".</p>
     <li data-md>
      <p>Let <var>ranges</var> be a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑥">list</a> of <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range①④">ranges</a>, initially empty.</p>
     <li data-md>
      <p>For each <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#ascii-string" id="ref-for-ascii-string⑤">ASCII string</a> <var>directive</var> of <var>directives</var>:</p>
      <ol>
       <li data-md>
        <p>If <var>directive</var> does not match the production <a data-link-type="dfn" href="#textdirective" id="ref-for-textdirective③">TextDirective</a>,
then <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-continue" id="ref-for-iteration-continue">continue</a>.</p>
       <li data-md>
        <p>Let <var>parsedValues</var> be the result of running the <a data-link-type="dfn" href="#parse-a-text-directive" id="ref-for-parse-a-text-directive">parse a text
directive</a> steps on <var>directive</var>.</p>
       <li data-md>
        <p>If <var>parsedValues</var> is null then <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-continue" id="ref-for-iteration-continue①">continue</a>.</p>
       <li data-md>
        <p>If the result of running <a data-link-type="dfn" href="#find-a-range-from-a-text-directive" id="ref-for-find-a-range-from-a-text-directive①">find a range from a text directive</a> given <var>parsedValues</var> and <var>document</var> is non-null, then <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list-append" id="ref-for-list-append">append</a> it to <var>ranges</var>.</p>
      </ol>
     <li data-md>
      <p>Return <var>ranges</var>.</p>
    </ol>
   </div>
   <div class="algorithm" data-algorithm="find a range from a text directive">
     To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="find-a-range-from-a-text-directive">find a range from a text directive</dfn>, given a <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive⑧">text directive</a> <var>parsedValues</var> and <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document⑨">Document</a> <var>document</var>, run the
following steps: 
    <div class="note" role="note">
      This algorithm takes as input a successfully parsed text directive and a
  document in which to search. It returns a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range①⑤">range</a> that points to the first
  text passage within the document that matches the searched-for text and
  satisfies the surrounding context. Returns null if no such passage exists. 
     <p><a data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end①">end</a> can be null. If omitted, this is an "exact"
  search and the returned <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range①⑥">range</a> will contain a string exactly matching <a data-link-type="dfn" href="#text-directive-start" id="ref-for-text-directive-start②">start</a>. If <a data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end②">end</a> is
  provided, this is a "range" search; the returned <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range①⑦">range</a> will start with <a data-link-type="dfn" href="#text-directive-start" id="ref-for-text-directive-start③">start</a> and end with <a data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end③">end</a>. In the normative text below, we’ll call a
  text passage that matches the provided <a data-link-type="dfn" href="#text-directive-start" id="ref-for-text-directive-start④">start</a> and <a data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end④">end</a>, regardless of which mode we’re in, the
  "matching text".</p>
     <p>Either or both of <a data-link-type="dfn" href="#text-directive-prefix" id="ref-for-text-directive-prefix①">prefix</a> and <a data-link-type="dfn" href="#text-directive-suffix" id="ref-for-text-directive-suffix①">suffix</a> can be null, in which case context on that
  side of a match is not checked. E.g. If <a data-link-type="dfn" href="#text-directive-prefix" id="ref-for-text-directive-prefix②">prefix</a> is
  null, text is matched without any requirement on what text precedes it.</p>
    </div>
    <div class="note" role="note">
      While the matching text and its prefix/suffix can span across
  block-boundaries, the individual parameters to these steps cannot. That is,
  each of <a data-link-type="dfn" href="#text-directive-prefix" id="ref-for-text-directive-prefix③">prefix</a>, <a data-link-type="dfn" href="#text-directive-start" id="ref-for-text-directive-start⑤">start</a>, <a data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end⑤">end</a>, and <a data-link-type="dfn" href="#text-directive-suffix" id="ref-for-text-directive-suffix②">suffix</a> will only
  match text within a single block. 
     <div class="example" id="example-73638554">
      <a class="self-link" href="#example-73638554"></a> 
<pre>:~:text=The quick,lazy dog</pre>
       will fail to match in 
<pre>&lt;div>The&lt;div> &lt;/div>quick brown fox&lt;/div>
&lt;div>jumped over the lazy dog&lt;/div>
</pre>
      <p>because the starting string "The quick" does not appear within a single,
    uninterrupted block. The instance of "The quick" in the document has a
    block element between "The" and "quick".</p>
      <p>It does, however, match in this example:</p>
<pre>&lt;div>The quick brown fox&lt;/div>
&lt;div>jumped over the lazy dog&lt;/div>
</pre>
     </div>
    </div>
    <ol class="algorithm">
     <li data-md>
      <p>Let <var>searchRange</var> be a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range①⑧">range</a> with <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start">start</a> (<var>document</var>, 0) and <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end">end</a> (<var>document</var>, <var>document</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-node-length" id="ref-for-concept-node-length">length</a>)</p>
     <li data-md>
      <p>While <var>searchRange</var> is not <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#range-collapsed" id="ref-for-range-collapsed">collapsed</a>:</p>
      <ol>
       <li data-md>
        <p>Let <var>potentialMatch</var> be null.</p>
       <li data-md>
        <p>If <var>parsedValues</var>’s <a data-link-type="dfn" href="#text-directive-prefix" id="ref-for-text-directive-prefix④">prefix</a> is not null:</p>
        <ol>
         <li data-md>
          <p>Let <var>prefixMatch</var> be the the result of running the <a data-link-type="dfn" href="#find-a-string-in-range" id="ref-for-find-a-string-in-range">find a string
in range</a> steps with <var>query</var> <var>parsedValues</var>’s <a data-link-type="dfn" href="#text-directive-prefix" id="ref-for-text-directive-prefix⑤">prefix</a>, <var>searchRange</var> <var>searchRange</var>, <var>wordStartBounded</var> true and <var>wordEndBounded</var> false.</p>
         <li data-md>
          <p>If <var>prefixMatch</var> is null, return null.</p>
         <li data-md>
          <p>Set <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start①">start</a> to the first <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp" id="ref-for-concept-range-bp">boundary point</a> <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp-after" id="ref-for-concept-range-bp-after">after</a> <var>prefixMatch</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start②">start</a></p>
         <li data-md>
          <p>Let <var>matchRange</var> be a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range①⑨">range</a> whose <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start③">start</a> is <var>prefixMatch</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end①">end</a> and <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end②">end</a> is <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end③">end</a>.</p>
         <li data-md>
          <p>Advance <var>matchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start④">start</a> to the <a data-link-type="dfn" href="#next-non-whitespace-position" id="ref-for-next-non-whitespace-position">next non-whitespace position</a>.</p>
         <li data-md>
          <p>If <var>matchRange</var> is <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#range-collapsed" id="ref-for-range-collapsed①">collapsed</a> return null.</p>
          <div class="note" role="note"> This can happen if <var>prefixMatch</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end④">end</a> or its subsequent
  non-whitespace position is at the end of the document. </div>
         <li data-md>
          <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert" id="ref-for-assert①">Assert</a>: <var>matchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-node" id="ref-for-concept-range-start-node①">start node</a> is a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#text" id="ref-for-text">Text</a></code> node.</p>
          <div class="note" role="note"> <var>matchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start⑤">start</a> now points to the next
  non-whitespace text data following a matched prefix. </div>
         <li data-md>
          <p>Let <var>mustEndAtWordBoundary</var> be true if <var>parsedValues</var>’s <a data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end⑥">end</a> is non-null or <var>parsedValues</var>’s <a data-link-type="dfn" href="#text-directive-suffix" id="ref-for-text-directive-suffix③">suffix</a> is null, false
otherwise.</p>
         <li data-md>
          <p>Set <var>potentialMatch</var> to the result of running the <a data-link-type="dfn" href="#find-a-string-in-range" id="ref-for-find-a-string-in-range①">find a string in
range</a> steps with <var>query</var> <var>parsedValues</var>’s <a data-link-type="dfn" href="#text-directive-start" id="ref-for-text-directive-start⑥">start</a>, <var>searchRange</var> <var>matchRange</var>, <var>wordStartBounded</var> false, and <var>wordEndBounded</var> <var>mustEndAtWordBoundary</var>.</p>
         <li data-md>
          <p>If <var>potentialMatch</var> is null, return null.</p>
         <li data-md>
          <p>If <var>potentialMatch</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start⑥">start</a> is not <var>matchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start⑦">start</a>, then <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-continue" id="ref-for-iteration-continue②">continue</a>.</p>
          <div class="note" role="note"> In this case, we found a prefix but it was followed by something
  other than a matching text so we’ll continue searching for the
  next instance of <a data-link-type="dfn" href="#text-directive-prefix" id="ref-for-text-directive-prefix⑥">prefix</a>. </div>
        </ol>
       <li data-md>
        <p>Otherwise:</p>
        <ol>
         <li data-md>
          <p>Let <var>mustEndAtWordBoundary</var> be true if <var>parsedValues</var>’s <a data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end⑦">end</a> is non-null or <var>parsedValues</var>’s <a data-link-type="dfn" href="#text-directive-suffix" id="ref-for-text-directive-suffix④">suffix</a> is null, false
otherwise.</p>
         <li data-md>
          <p>Set <var>potentialMatch</var> to the result of running the <a data-link-type="dfn" href="#find-a-string-in-range" id="ref-for-find-a-string-in-range②">find a string in
range</a> steps with <var>query</var> <var>parsedValues</var>’s <a data-link-type="dfn" href="#text-directive-start" id="ref-for-text-directive-start⑦">start</a>, <var>searchRange</var> <var>searchRange</var>, <var>wordStartBounded</var> true, and <var>wordEndBounded</var> <var>mustEndAtWordBoundary</var>.</p>
         <li data-md>
          <p>If <var>potentialMatch</var> is null, return null.</p>
         <li data-md>
          <p>Set <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start⑧">start</a> to the first <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp" id="ref-for-concept-range-bp①">boundary point</a> <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp-after" id="ref-for-concept-range-bp-after①">after</a> <var>potentialMatch</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start⑨">start</a></p>
        </ol>
       <li data-md>
        <p>Let <var>rangeEndSearchRange</var> be a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range②⓪">range</a> whose <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start①⓪">start</a> is <var>potentialMatch</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end⑤">end</a> and whose <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end⑥">end</a> is <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end⑦">end</a>.</p>
       <li data-md>
        <p>While <var>rangeEndSearchRange</var> is not <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#range-collapsed" id="ref-for-range-collapsed②">collapsed</a>:</p>
        <ol>
         <li data-md>
          <p>If <var>parsedValues</var>’s <a data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end⑧">end</a> item is
non-null, then:</p>
          <ol>
           <li data-md>
            <p>Let <var>mustEndAtWordBoundary</var> be true if <var>parsedValues</var>’s <a data-link-type="dfn" href="#text-directive-suffix" id="ref-for-text-directive-suffix⑤">suffix</a> is null, false otherwise.</p>
           <li data-md>
            <p>Let <var>endMatch</var> be the result of running the <a data-link-type="dfn" href="#find-a-string-in-range" id="ref-for-find-a-string-in-range③">find a string
in range</a> steps with <var>query</var> <var>parsedValues</var>’s <a data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end⑨">end</a>, <var>searchRange</var> <var>rangeEndSearchRange</var>, <var>wordStartBounded</var> true, and <var>wordEndBounded</var> <var>mustEndAtWordBoundary</var>.</p>
           <li data-md>
            <p>If <var>endMatch</var> is null then return null.</p>
           <li data-md>
            <p>Set <var>potentialMatch</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end⑧">end</a> to <var>endMatch</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end⑨">end</a>.</p>
          </ol>
         <li data-md>
          <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert" id="ref-for-assert②">Assert</a>: <var>potentialMatch</var> is non-null, not <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#range-collapsed" id="ref-for-range-collapsed③">collapsed</a> and
represents a range exactly containing an instance of matching text.</p>
         <li data-md>
          <p>If <var>parsedValues</var>’s <a data-link-type="dfn" href="#text-directive-suffix" id="ref-for-text-directive-suffix⑥">suffix</a> is null, return <var>potentialMatch</var>.</p>
         <li data-md>
          <p>Let <var>suffixRange</var> be a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range②①">range</a> with <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start①①">start</a> equal to <var>potentialMatch</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end①⓪">end</a> and <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end①①">end</a> equal to <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end①②">end</a>.</p>
         <li data-md>
          <p>Advance <var>suffixRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start①②">start</a> to the <a data-link-type="dfn" href="#next-non-whitespace-position" id="ref-for-next-non-whitespace-position①">next non-whitespace
position</a>.</p>
         <li data-md>
          <p>Let <var>suffixMatch</var> be result of running the <a data-link-type="dfn" href="#find-a-string-in-range" id="ref-for-find-a-string-in-range④">find a string in range</a> steps with <var>query</var> <var>parsedValues</var>’s <a data-link-type="dfn" href="#text-directive-suffix" id="ref-for-text-directive-suffix⑦">suffix</a>, <var>searchRange</var> <var>suffixRange</var>, <var>wordStartBounded</var> false, and <var>wordEndBounded</var> true.</p>
         <li data-md>
          <p>If <var>suffixMatch</var> is null then return null.</p>
          <div class="note" role="note"> If the suffix doesn’t appear in the remaining text of the document,
  there’s no possible way to make a match. </div>
         <li data-md>
          <p>If <var>suffixMatch</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start①③">start</a> is <var>suffixRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start①④">start</a>,
return <var>potentialMatch</var>.</p>
         <li data-md>
          <p>If <var>parsedValues</var>’s <a data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end①⓪">end</a> item is null
then <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-break" id="ref-for-iteration-break">break</a>;</p>
          <div class="note" role="note"> If this is an exact match and the suffix doesn’t match,
  start searching for the next range start by breaking out
  of this loop without <var>rangeEndSearchRange</var> being collapsed.
  If we’re looking for a range match, we’ll continue iterating
  this inner loop since the range start will already be correct. </div>
         <li data-md>
          <p>Set <var>rangeEndSearchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start①⑤">start</a> to <var>potentialMatch</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end①③">end</a>.</p>
          <div class="note" role="note"> Otherwise, it is possible that we found the correct range
  start, but not the correct range end. Continue the inner
  loop to keep searching for another matching instance of
  rangeEnd. </div>
        </ol>
       <li data-md>
        <p>If <var>rangeEndSearchRange</var> is <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#range-collapsed" id="ref-for-range-collapsed④">collapsed</a> then:</p>
        <ol>
         <li data-md>
          <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert" id="ref-for-assert③">Assert</a>: <var>parsedValues</var>’s <a data-link-type="dfn" href="#text-directive-end" id="ref-for-text-directive-end①①">end</a> item is non-null</p>
         <li data-md>
          <p>Return null</p>
          <div class="note" role="note"> This can only happen for range matches due to the <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-break" id="ref-for-iteration-break①">break</a> for exact matches in step 9 of the
    above loop. If we couldn’t find a valid rangeEnd+suffix
    pair anywhere in the doc then there’s no possible way to
    make a match. </div>
        </ol>
      </ol>
     <li data-md>
      <p>Return null</p>
    </ol>
   </div>
   <details class="wpt-tests-block" dir="ltr" lang="en" open>
    <summary>Tests</summary>
    <ul class="wpt-tests-list">
     <li class="wpt-test"><a class="wpt-name" href="https://wpt.fyi/results/scroll-to-text-fragment/find-range-from-text-directive.html" title="scroll-to-text-fragment/find-range-from-text-directive.html">find-range-from-text-directive.html</a> <a class="wpt-live" href="http://wpt.live/scroll-to-text-fragment/find-range-from-text-directive.html"><small>(live test)</small></a> <a class="wpt-source" href="https://github.com/web-platform-tests/wpt/blob/master/scroll-to-text-fragment/find-range-from-text-directive.html"><small>(source)</small></a>
    </ul>
   </details>
   <div class="algorithm" data-algorithm="advance range start to next non-whitespace position">
     To advance a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range②②">range</a> <var>range</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start①⑥">start</a> to the <dfn class="dfn-paneled" data-dfn-type="dfn" data-lt="next non-whitespace position" data-noexport id="next-non-whitespace-position">next
non-whitespace position</dfn> follow the steps: 
    <ol class="algorithm">
     <li data-md>
      <p>While <var>range</var> is not collapsed:</p>
      <ol>
       <li data-md>
        <p>Let <var>node</var> be <var>range</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-node" id="ref-for-concept-range-start-node②">start node</a>.</p>
       <li data-md>
        <p>Let <var>offset</var> be <var>range</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-offset" id="ref-for-concept-range-start-offset">start offset</a>.</p>
       <li data-md>
        <p>If <var>node</var> is part of a <a data-link-type="dfn" href="#non-searchable-subtree" id="ref-for-non-searchable-subtree">non-searchable subtree</a> or if <var>node</var> is
not a <a data-link-type="dfn" href="#visible-text-node" id="ref-for-visible-text-node">visible text node</a> or if <var>offset</var> is equal to <var>node</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-node-length" id="ref-for-concept-node-length①">length</a> then:</p>
        <ol>
         <li data-md>
          <p>Set <var>range</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-node" id="ref-for-concept-range-start-node③">start node</a> to the next node, in <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order" id="ref-for-concept-shadow-including-tree-order">shadow-including tree order</a>.</p>
         <li data-md>
          <p>Set <var>range</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-offset" id="ref-for-concept-range-start-offset①">start offset</a> to 0.</p>
         <li data-md>
          <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-continue" id="ref-for-iteration-continue③">Continue</a>.</p>
        </ol>
       <li data-md>
        <p>If the <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-cd-substring" id="ref-for-concept-cd-substring">substring data</a> of <var>node</var> at offset <var>offset</var> and count 6 is equal to the string "&amp;nbsp;" then:</p>
        <ol>
         <li data-md>
          <p>Add 6 to <var>range</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-offset" id="ref-for-concept-range-start-offset②">start offset</a>.</p>
        </ol>
       <li data-md>
        <p>Otherwise, if the <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-cd-substring" id="ref-for-concept-cd-substring①">substring data</a> of <var>node</var> at offset <var>offset</var> and count 5 is equal to the string "&amp;nbsp" then:</p>
        <ol>
         <li data-md>
          <p>Add 5 to <var>range</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-offset" id="ref-for-concept-range-start-offset③">start offset</a>.</p>
        </ol>
       <li data-md>
        <p>Otherwise:</p>
        <ol>
         <li data-md>
          <p>Let <var>cp</var> be the <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#code-point" id="ref-for-code-point">code point</a> at the <var>offset</var> index in <var>node</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-cd-data" id="ref-for-concept-cd-data">data</a>.</p>
         <li data-md>
          <p>If <var>cp</var> does not have the <a href="http://www.unicode.org/reports/tr44/#White_Space">White_Space</a> property set, return.</p>
         <li data-md>
          <p>Add 1 to <var>range</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-offset" id="ref-for-concept-range-start-offset④">start offset</a>.</p>
        </ol>
      </ol>
    </ol>
   </div>
   <div class="algorithm" data-algorithm="find a string in a range">
     To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="find-a-string-in-range">find a string in range</dfn> given a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string">string</a> <var>query</var>, a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range②③">range</a> <var>searchRange</var>, and booleans <var>wordStartBounded</var> and <var>wordEndBounded</var>,
run these steps: 
    <div class="note" role="note"> This algorithm will return a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range②④">range</a> that represents the first instance of
  the <var>query</var> text that is fully contained within <var>searchRange</var>, optionally
  restricting itself to matches that start and/or end at word boundaries (see <a href="#word-boundaries">§ 3.6.2 Word Boundaries</a>). Returns null if none is found. </div>
    <div class="note" role="note">
     <p> The basic premise of this algorithm is to walk all searchable text nodes
    within a block, collecting them into a list. The list is then concatenated
    into a single string in which we can search, using the node list to
    determine offsets with a node so we can return a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range②⑤">range</a>. </p>
     <p> Collection breaks when we hit a block node, e.g. searching over this tree: </p>
<pre>&lt;div>
  a&lt;em>b&lt;/em>c&lt;div>d&lt;/div>e
&lt;/div>
</pre>
     <p></p>
     <p>Will perform a search on "abc", then on "d", then on "e".</p>
     <p>Thus, <var>query</var> will only match text that is continuous (i.e. uninterrupted by
  a block-level container) within a single block-level container.</p>
    </div>
    <ol class="algorithm">
     <li data-md>
      <p>While <var>searchRange</var> is not <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#range-collapsed" id="ref-for-range-collapsed⑤">collapsed</a>:</p>
      <ol>
       <li data-md>
        <p>Let <var>curNode</var> be <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-node" id="ref-for-concept-range-start-node④">start node</a>.</p>
       <li data-md>
        <p>If <var>curNode</var> is part of a <a data-link-type="dfn" href="#non-searchable-subtree" id="ref-for-non-searchable-subtree①">non-searchable subtree</a>:</p>
        <ol>
         <li data-md>
          <p>Set <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-node" id="ref-for-concept-range-start-node⑤">start node</a> to the next node, in <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order" id="ref-for-concept-shadow-including-tree-order①">shadow-including tree order</a>, that isn’t a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-including-descendant" id="ref-for-concept-shadow-including-descendant">shadow-including
descendant</a> of <var>curNode</var>.</p>
         <li data-md>
          <p>Set <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-offset" id="ref-for-concept-range-start-offset⑤">start offset</a> to 0.</p>
         <li data-md>
          <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-continue" id="ref-for-iteration-continue④">Continue</a>.</p>
        </ol>
       <li data-md>
        <p>If <var>curNode</var> is not a <a data-link-type="dfn" href="#visible-text-node" id="ref-for-visible-text-node①">visible text node</a>:</p>
        <ol>
         <li data-md>
          <p>Set <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-node" id="ref-for-concept-range-start-node⑥">start node</a> to the next node, in <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order" id="ref-for-concept-shadow-including-tree-order②">shadow-including tree order</a>, that is not a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-doctype" id="ref-for-concept-doctype">doctype</a>.</p>
         <li data-md>
          <p>Set <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-offset" id="ref-for-concept-range-start-offset⑥">start offset</a> to 0.</p>
         <li data-md>
          <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-continue" id="ref-for-iteration-continue⑤">Continue</a>.</p>
        </ol>
       <li data-md>
        <p>Let <var>blockAncestor</var> be the <a data-link-type="dfn" href="#nearest-block-ancestor" id="ref-for-nearest-block-ancestor">nearest block ancestor</a> of <var>curNode</var>.</p>
       <li data-md>
        <p>Let <var>textNodeList</var> be a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑦">list</a> of <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#text" id="ref-for-text①">Text</a></code> nodes,
initially empty.</p>
       <li data-md>
        <p>While <var>curNode</var> is a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-including-descendant" id="ref-for-concept-shadow-including-descendant①">shadow-including descendant</a> of <var>blockAncestor</var> and the position of the <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp" id="ref-for-concept-range-bp②">boundary point</a> (<var>curNode</var>, 0) is not <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp-after" id="ref-for-concept-range-bp-after②">after</a> <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end①④">end</a>:</p>
        <ol>
         <li data-md>
          <p>If <var>curNode</var> <a data-link-type="dfn" href="#has-block-level-display" id="ref-for-has-block-level-display">has block-level display</a> then <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-break" id="ref-for-iteration-break②">break</a>.</p>
         <li data-md>
          <p>If <var>curNode</var> is <a data-link-type="dfn" href="#search-invisible" id="ref-for-search-invisible">search invisible</a>:</p>
          <ol>
           <li data-md>
            <p>Set <var>curNode</var> to the next node, in <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order" id="ref-for-concept-shadow-including-tree-order③">shadow-including tree
order</a>, that isn’t a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-including-descendant" id="ref-for-concept-shadow-including-descendant②">shadow-including descendant</a> of <var>curNode</var>.</p>
           <li data-md>
            <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-continue" id="ref-for-iteration-continue⑥">Continue</a>.</p>
          </ol>
         <li data-md>
          <p>If <var>curNode</var> is a <a data-link-type="dfn" href="#visible-text-node" id="ref-for-visible-text-node②">visible text node</a> then append it to <var>textNodeList</var>.</p>
         <li data-md>
          <p>Set <var>curNode</var> to the next node in <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-including-tree-order" id="ref-for-concept-shadow-including-tree-order④">shadow-including tree order</a>.</p>
        </ol>
       <li data-md>
        <p>Run the <a data-link-type="dfn" href="#find-a-range-from-a-node-list" id="ref-for-find-a-range-from-a-node-list">find a range from a node list</a> steps given <var>query</var>, <var>searchRange</var>, <var>textNodeList</var>, <var>wordStartBounded</var> and <var>wordEndBounded</var> as input. If the resulting <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range②⑥">range</a> is not null, then return it.</p>
       <li data-md>
        <p>If <var>curNode</var> is null, then <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#iteration-break" id="ref-for-iteration-break③">break</a>.</p>
       <li data-md>
        <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert" id="ref-for-assert④">Assert</a>: <var>curNode</var> <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-tree-following" id="ref-for-concept-tree-following">follows</a> <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-node" id="ref-for-concept-range-start-node⑦">start node</a>.</p>
       <li data-md>
        <p>Set <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start①⑦">start</a> to the <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp" id="ref-for-concept-range-bp③">boundary point</a> (<var>curNode</var>,
0).</p>
      </ol>
     <li data-md>
      <p>Return null.</p>
    </ol>
   </div>
   <p>A node is <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="search-invisible">search invisible</dfn> if it is an <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-element" id="ref-for-concept-element③">element</a> in the <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#html-namespace" id="ref-for-html-namespace">HTML
namespace</a> and meets any of the following conditions:</p>
   <ol>
    <li data-md>
     <p>The <a data-link-type="dfn" href="https://drafts.csswg.org/css-cascade-5/#computed-value" id="ref-for-computed-value">computed value</a> of its <a class="property css" data-link-type="property" href="https://drafts.csswg.org/css-display-4/#propdef-display" id="ref-for-propdef-display">display</a> property is <a class="css" data-link-type="maybe" href="https://drafts.csswg.org/css-display-4/#valdef-display-none" id="ref-for-valdef-display-none">none</a>.</p>
    <li data-md>
     <p>If the node <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/parsing.html#serializes-as-void" id="ref-for-serializes-as-void">serializes as void</a>.</p>
    <li data-md>
     <p>Is any of the following types: <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#htmliframeelement" id="ref-for-htmliframeelement">HTMLIFrameElement</a></code>, <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/embedded-content.html#htmlimageelement" id="ref-for-htmlimageelement">HTMLImageElement</a></code>, <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/form-elements.html#htmlmeterelement" id="ref-for-htmlmeterelement">HTMLMeterElement</a></code>, <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#htmlobjectelement" id="ref-for-htmlobjectelement">HTMLObjectElement</a></code>, <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/form-elements.html#htmlprogresselement" id="ref-for-htmlprogresselement">HTMLProgressElement</a></code>, <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/semantics.html#htmlstyleelement" id="ref-for-htmlstyleelement">HTMLStyleElement</a></code>, <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/scripting.html#htmlscriptelement" id="ref-for-htmlscriptelement">HTMLScriptElement</a></code>, <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/media.html#htmlvideoelement" id="ref-for-htmlvideoelement">HTMLVideoElement</a></code>, <code class="idl"><a data-link-type="idl" href="https://html.spec.whatwg.org/multipage/media.html#htmlaudioelement" id="ref-for-htmlaudioelement">HTMLAudioElement</a></code></p>
    <li data-md>
     <p>Is a <code><a data-link-type="element" href="https://html.spec.whatwg.org/multipage/form-elements.html#the-select-element" id="ref-for-the-select-element">select</a></code> element whose <code><a data-link-type="element-sub" href="https://html.spec.whatwg.org/multipage/form-elements.html#attr-select-multiple" id="ref-for-attr-select-multiple">multiple</a></code> content attribute is absent.</p>
   </ol>
   <p>A node is part of a <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="non-searchable-subtree">non-searchable subtree</dfn> if it is or has a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-shadow-including-ancestor" id="ref-for-concept-shadow-including-ancestor">shadow-including ancestor</a> that is <a data-link-type="dfn" href="#search-invisible" id="ref-for-search-invisible①">search invisible</a>.</p>
   <p>A node is a <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="visible-text-node">visible text node</dfn> if it is a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#text" id="ref-for-text②">Text</a></code> node, the <a data-link-type="dfn" href="https://drafts.csswg.org/css-cascade-5/#computed-value" id="ref-for-computed-value①">computed value</a> of its <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#parent-element" id="ref-for-parent-element">parent element</a>'s <a class="property css" data-link-type="property" href="https://drafts.csswg.org/css-display-4/#propdef-visibility" id="ref-for-propdef-visibility">visibility</a> property is <a class="css" data-link-type="maybe" href="https://drafts.csswg.org/css-display-4/#valdef-visibility-visible" id="ref-for-valdef-visibility-visible">visible</a>, and it is <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/rendering.html#being-rendered" id="ref-for-being-rendered">being rendered</a>.</p>
   <p>A node <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="has-block-level-display">has block-level display</dfn> if it is an <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-element" id="ref-for-concept-element④">element</a> and the <a data-link-type="dfn" href="https://drafts.csswg.org/css-cascade-5/#computed-value" id="ref-for-computed-value②">computed value</a> of its <a class="property css" data-link-type="property" href="https://drafts.csswg.org/css-display-4/#propdef-display" id="ref-for-propdef-display①">display</a> property is any of <a class="css" data-link-type="maybe" href="https://drafts.csswg.org/css-display-4/#valdef-display-block" id="ref-for-valdef-display-block">block</a>, <a class="css" data-link-type="maybe" href="https://drafts.csswg.org/css-display-4/#valdef-display-table" id="ref-for-valdef-display-table">table</a>, <a class="css" data-link-type="maybe" href="https://drafts.csswg.org/css-display-4/#valdef-display-flow-root" id="ref-for-valdef-display-flow-root">flow-root</a>, <a class="css" data-link-type="maybe" href="https://drafts.csswg.org/css-display-3/#valdef-display-grid" id="ref-for-valdef-display-grid">grid</a>, <a class="css" data-link-type="maybe" href="https://drafts.csswg.org/css-display-3/#valdef-display-flex" id="ref-for-valdef-display-flex">flex</a>, <a class="css" data-link-type="maybe" href="https://drafts.csswg.org/css-display-4/#valdef-display-list-item" id="ref-for-valdef-display-list-item">list-item</a>.</p>
   <div class="algorithm" data-algorithm="nearest block ancestor">
     To find the <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="nearest-block-ancestor">nearest block ancestor</dfn> of a <var>node</var> follow the steps: 
    <ol class="algorithm">
     <li data-md>
      <p>Let <var>curNode</var> be <var>node</var>.</p>
     <li data-md>
      <p>While <var>curNode</var> is non-null</p>
      <ol>
       <li data-md>
        <p>If <var>curNode</var> is not a <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#text" id="ref-for-text③">Text</a></code> node and it <a data-link-type="dfn" href="#has-block-level-display" id="ref-for-has-block-level-display①">has block-level display</a> then
return <var>curNode</var>.</p>
       <li data-md>
        <p>Otherwise, set <var>curNode</var> to <var>curNode</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-tree-parent" id="ref-for-concept-tree-parent②">parent</a>.</p>
      </ol>
     <li data-md>
      <p>Return <var>node</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-node-document" id="ref-for-concept-node-document">node document</a>'s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#document-element" id="ref-for-document-element">document element</a>.</p>
    </ol>
   </div>
   <div class="algorithm" data-algorithm="range from node list">
     To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="find-a-range-from-a-node-list">find a range from a node list</dfn> given a search string <var>queryString</var>,
a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range②⑦">range</a> <var>searchRange</var>, a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑧">list</a> of <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#text" id="ref-for-text④">Text</a></code> nodes <var>nodes</var>, and booleans <var>wordStartBounded</var> and <var>wordEndBounded</var>, follow these steps: 
    <div class="note" role="note">
      Optionally, this will only return a match if the matched text begins and/or
  ends on a <a data-link-type="dfn" href="#word-boundary" id="ref-for-word-boundary">word boundary</a>. For example: 
     <div class="example" id="example-27ab4025">
      <a class="self-link" href="#example-27ab4025"></a> The query string “range” will always match in “mountain range”, but 
      <ol>
       <li data-md>
        <p>When requiring a word boundary at the beginning, it will not match in “color orange”.</p>
       <li data-md>
        <p>When requiring a word boundary at the end, it will not match in “forest ranger”.</p>
      </ol>
     </div>
     <p>See <a href="#word-boundaries">§ 3.6.2 Word Boundaries</a> for details and more examples.</p>
    </div>
    <ol class="algorithm">
     <li data-md>
      <p>Let <var>searchBuffer</var> be the <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string-concatenate" id="ref-for-string-concatenate">concatenation</a> of the <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-cd-data" id="ref-for-concept-cd-data①">data</a> of each item in <var>nodes</var>.</p>
      <p class="issue" id="issue-96fe4755"><a class="self-link" href="#issue-96fe4755"></a> <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-cd-data" id="ref-for-concept-cd-data②">data</a> is not
correct here since that’s the text data as it exists in the DOM. This
algorithm means to run over the text as rendered (and then convert back
to Ranges in the DOM). <a href="https://github.com/WICG/scroll-to-text-fragment/issues/98">[Issue #WICG/scroll-to-text-fragment#98]</a></p>
     <li data-md>
      <p>Let <var>searchStart</var> be 0.</p>
     <li data-md>
      <p>If the first item in <var>nodes</var> is <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-node" id="ref-for-concept-range-start-node⑧">start node</a> then
set <var>searchStart</var> to <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start-offset" id="ref-for-concept-range-start-offset⑦">start offset</a>.</p>
     <li data-md>
      <p>Let <var>start</var> and <var>end</var> be <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp" id="ref-for-concept-range-bp④">boundary points</a>, initially null.</p>
     <li data-md>
      <p>Let <var>matchIndex</var> be null.</p>
     <li data-md>
      <p>While <var>matchIndex</var> is null</p>
      <ol>
       <li data-md>
        <p>Set <var>matchIndex</var> to the index of the first instance of <var>queryString</var> in <var>searchBuffer</var>, starting at <var>searchStart</var>. The string search must be
performed using a base character comparison, or the <a href="http://www.unicode.org/reports/tr10/#Multi_Level_Comparison">primary
level</a>, as defined in <a data-link-type="biblio" href="#biblio-uts10" title="Unicode Collation Algorithm">[UTS10]</a>.</p>
        <div class="note" role="note"> Intuitively, this is a case-insensitive search also ignoring accents, umlauts,
  and other marks. </div>
       <li data-md>
        <p>If <var>matchIndex</var> is null, return null.</p>
       <li data-md>
        <p>Let <var>endIx</var> be <var>matchIndex</var> + <var>queryString</var>’s <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string-length" id="ref-for-string-length">length</a>.</p>
        <div class="note" role="note"> <var>endIx</var> is the index of the last character in the match + 1. </div>
       <li data-md>
        <p>Set <var>start</var> to the <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp" id="ref-for-concept-range-bp⑤">boundary point</a> result of <a data-link-type="dfn" href="#get-boundary-point-at-index" id="ref-for-get-boundary-point-at-index">get boundary point at
index</a> <var>matchIndex</var> run over <var>nodes</var> with <var>isEnd</var> false.</p>
       <li data-md>
        <p>Set <var>end</var> to the <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp" id="ref-for-concept-range-bp⑥">boundary point</a> result of <a data-link-type="dfn" href="#get-boundary-point-at-index" id="ref-for-get-boundary-point-at-index①">get boundary point at
index</a> <var>endIx</var> run over <var>nodes</var> with <var>isEnd</var> true.</p>
       <li data-md>
        <p>If <var>wordStartBounded</var> is true and <var>matchIndex</var> <a data-link-type="dfn" href="#is-at-a-word-boundary" id="ref-for-is-at-a-word-boundary">is
not at a word boundary</a> in <var>searchBuffer</var>, given the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/dom.html#language" id="ref-for-language">language</a> from <var>start</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#boundary-point-node" id="ref-for-boundary-point-node">node</a> as the <var>locale</var>; or <var>wordEndBounded</var> is true and <var>matchIndex</var> + <var>queryString</var>’s <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string-length" id="ref-for-string-length①">length</a> <a data-link-type="dfn" href="#is-at-a-word-boundary" id="ref-for-is-at-a-word-boundary①">is not at a word boundary</a> in <var>searchBuffer</var>, given the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/dom.html#language" id="ref-for-language①">language</a> from <var>end</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#boundary-point-node" id="ref-for-boundary-point-node①">node</a> as the <var>locale</var>:</p>
        <ol>
         <li data-md>
          <p>Set <var>searchStart</var> to <var>matchIndex</var> + 1.</p>
         <li data-md>
          <p>Set <var>matchIndex</var> to null.</p>
        </ol>
      </ol>
     <li data-md>
      <p>Let <var>endInset</var> be 0.</p>
     <li data-md>
      <p>If the last item in <var>nodes</var> is <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end-node" id="ref-for-concept-range-end-node①">end node</a> then set <var>endInset</var> to (<var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end-node" id="ref-for-concept-range-end-node②">end node</a>'s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-node-length" id="ref-for-concept-node-length②">length</a> − <var>searchRange</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end-offset" id="ref-for-concept-range-end-offset">end offset</a>)</p>
      <div class="note" role="note"> <var>endInset</var> is the offset from the last position in the last node in the
  reverse direction. Alternatively, it is the length of the node that’s not
  included in the range. </div>
     <li data-md>
      <p>If <var>matchIndex</var> + <var>queryString</var>’s <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string-length" id="ref-for-string-length②">length</a> is greater than <var>searchBuffer</var>’s length − <var>endInset</var> return null.</p>
      <div class="note" role="note"> If the match runs past the end of the search range, return null. </div>
     <li data-md>
      <p><a data-link-type="dfn" href="https://infra.spec.whatwg.org/#assert" id="ref-for-assert⑤">Assert</a>: <var>start</var> and <var>end</var> are non-null, valid <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp" id="ref-for-concept-range-bp⑦">boundary points</a> in <var>searchRange</var>.</p>
     <li data-md>
      <p>Return a <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range" id="ref-for-concept-range②⑧">range</a> with <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-start" id="ref-for-concept-range-start①⑧">start</a> <var>start</var> and <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-end" id="ref-for-concept-range-end①⑤">end</a> <var>end</var>.</p>
    </ol>
   </div>
   <div class="algorithm" data-algorithm="boundary point at index">
     To <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="get-boundary-point-at-index">get boundary point at index</dfn>, given an integer <var>index</var>, <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#list" id="ref-for-list⑨">list</a> of <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#text" id="ref-for-text⑤">Text</a></code> nodes <var>nodes</var>, and a boolean <var>isEnd</var>, follow these steps: 
    <div class="note" role="note">
     <p> This is a small helper routine used by the steps above to determine which
    node a given index in the concatenated string belongs to. </p>
     <p> <var>isEnd</var> is used to differentiate start and end indices. An end index points
    to the "one-past-last" character of the matching string. If the match ends
    at node boundary, we want the end offset to remain within that node, rather
    than the start of the next node. </p>
    </div>
    <ol class="algorithm">
     <li data-md>
      <p>Let <var>counted</var> be 0.</p>
     <li data-md>
      <p>For each <var>curNode</var> of <var>nodes</var>:</p>
      <ol>
       <li data-md>
        <p>Let <var>nodeEnd</var> be <var>counted</var> + <var>curNode</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-node-length" id="ref-for-concept-node-length③">length</a>.</p>
       <li data-md>
        <p>If <var>isEnd</var> is true, add 1 to <var>nodeEnd</var>.</p>
       <li data-md>
        <p>If <var>nodeEnd</var> is greater than <var>index</var> then:</p>
        <ol>
         <li data-md>
          <p>Return the <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-range-bp" id="ref-for-concept-range-bp⑧">boundary point</a> (<var>curNode</var>, <var>index</var> − <var>counted</var>).</p>
        </ol>
       <li data-md>
        <p>Increment <var>counted</var> by <var>curNode</var>’s <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-node-length" id="ref-for-concept-node-length④">length</a>.</p>
      </ol>
     <li data-md>
      <p>Return null.</p>
    </ol>
   </div>
   <h4 class="heading settled" data-level="3.6.2" id="word-boundaries"><span class="secno">3.6.2. </span><span class="content">Word Boundaries</span><a class="self-link" href="#word-boundaries"></a></h4>
   <div class="note" role="note"> Limiting matching to word boundaries is one of the mitigations to limit
  cross-origin information leakage. </div>
   <div class="note" role="note"> See <a href="https://github.com/tc39/proposal-intl-segmenter">Intl.Segmenter</a>, a
  proposal to specify unicode segmentation, including word segmentation. Once
  specified, this algorithm can be improved by making use of the Intl.Segmenter
  API for word boundary matching. </div>
   <p> A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="word-boundary">word boundary</dfn> is defined in <a data-link-type="biblio" href="#biblio-uax29" title="Unicode Text Segmentation">[UAX29]</a> in <a href="https://www.unicode.org/reports/tr29/tr29-43.html#Word_Boundaries">Unicode Text Segmentation § Word_Boundaries</a>. <a href="https://www.unicode.org/reports/tr29/tr29-43.html#Default_Word_Boundaries">Unicode Text Segmentation § Default_Word_Boundaries</a> defines a
  default set of what constitutes a word boundary, but as the specification
  mentions, a more sophisticated algorithm should be used based on the locale. </p>
   <p> Dictionary-based word bounding should take specific care in locales without a
  word-separating character. E.g. In English, words are separated by the space
  character (' '); however, in Japanese there is no character that separates one
  word from the next. In such cases, and where the alphabet contains fewer
  than 100 characters, the dictionary must not contain more than 20% of the
  alphabet as valid, one-letter words. </p>
   <p>A <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="locale">locale</dfn> is a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string①">string</a> containing a valid <a data-link-type="biblio" href="#biblio-bcp47" title="Tags for Identifying Languages">[BCP47]</a> language tag, or the empty string. An empty string indicates that the primary
language is unknown.</p>
   <p>A substring is <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="word-bounded">word bounded</dfn> in a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string②">string</a> <var>text</var>,
given <a data-link-type="dfn" href="#locale" id="ref-for-locale">locales</a> <var>startLocale</var> and <var>endLocale</var>, if both the position of its
first character <a data-link-type="dfn" href="#is-at-a-word-boundary" id="ref-for-is-at-a-word-boundary②">is at a word boundary</a> given <var>startLocale</var>, and the position
after its last character <a data-link-type="dfn" href="#is-at-a-word-boundary" id="ref-for-is-at-a-word-boundary③">is at a word boundary</a> given <var>endLocale</var>.</p>
   <p>A number <var>position</var> <dfn class="dfn-paneled" data-dfn-type="dfn" data-noexport id="is-at-a-word-boundary">is at a word boundary</dfn> in a <a data-link-type="dfn" href="https://infra.spec.whatwg.org/#string" id="ref-for-string③">string</a> <var>text</var>, given a <a data-link-type="dfn" href="#locale" id="ref-for-locale①">locale</a> <var>locale</var>, if, using <var>locale</var>, either a <a data-link-type="dfn" href="#word-boundary" id="ref-for-word-boundary①">word
boundary</a> immediately precedes the <var>position</var>th code unit, or <var>text</var>’s length
is more than 0 and <var>position</var> equals either 0 or <var>text</var>’s length.</p>
   <div class="note" role="note">
     Intuitively, a substring is <a data-link-type="dfn" href="#word-bounded" id="ref-for-word-bounded">word bounded</a> if it neither begins nor ends in
  the middle of a word. 
    <p>In languages with a word separator (e.g. " " space) this is (mostly)
  straightforward; though there are details covered by the above technical
  reports such as new lines, hyphenations, quotes, etc.</p>
    <p>Some languages do not have such a separator (notably,
  Chinese/Japanese/Korean). Languages such as these requires dictionaries to
  determine what a valid word in the given locale is.</p>
   </div>
   <div class="example" id="example-0a0acb46">
    <a class="self-link" href="#example-0a0acb46"></a> 
    <p> Text fragments are restricted such that match terms, when combined with
    their adjacent context terms, are word bounded. For example, in an
    exact search like <code>prefix,start,suffix</code>, <code>"prefix+start+suffix"</code> will match only if the entire result is word bounded. However, in a
    range search like <code>prefix,start,end,suffix</code>, a match is
    found only if both <code>"prefix+start"</code> and <code>"end+suffix"</code> are
    word bounded. </p>
    <p> The goal is that a third-party must already know the full tokens they are
    matching against. A range match like <code>start,end</code> must be
    word bounded on the inside of the two terms; otherwise a third party could
    use this repeatedly to try and reveal a token (e.g. on a page with <code>"Balance: 123,456 $"</code>, a third-party could set <code>prefix="Balance: ", end="$"</code> and vary <code>start</code> to try and guess the numeric token one digit at a time). </p>
    <p> For more details, refer to the <a href="https://docs.google.com/document/d/1YHcl1-vE_ZnZ0kL2almeikAj2gkwCq8_5xwIae7PVik/edit#heading=h.78iny7nejmx2">Security Review Doc</a> </p>
   </div>
   <div class="example" id="example-1b2a6f00"><a class="self-link" href="#example-1b2a6f00"></a> The substring "mountain range" is word bounded within the string "An impressive
  mountain range" but not within "An impressive mountain ranger". </div>
   <div class="example" id="example-c7882c95"><a class="self-link" href="#example-c7882c95"></a> In the Japanese string "<span lang="ja">ウィキペディアへようこそ</span>" (Welcome to Wikipedia),
  "<span lang="ja">ようこそ</span>" (Welcome) is considered word-bounded but "<span lang="ja">ようこ</span>" is not. </div>
   <h3 class="heading settled" data-level="3.7" id="indicating-the-text-match"><span class="secno">3.7. </span><span class="content">Indicating The Text Match</span><a class="self-link" href="#indicating-the-text-match"></a></h3>
   <p>The UA may choose to scroll the text fragment into view as part of the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#try-to-scroll-to-the-fragment" id="ref-for-try-to-scroll-to-the-fragment①">try to scroll to the fragment</a> steps or by some other mechanism;
however, it is not required to scroll the match into view.</p>
   <p>The UA should visually indicate the matched text in some way such that the user
is made aware of the text match, such as with a high-contrast highlight.</p>
   <p>The UA should provide to the user some method of dismissing the match, such
that the matched text no longer appears visually indicated.</p>
   <p>The exact appearance and mechanics of the indication are left as UA-defined.
However, the UA must not use any methods observable by author script, such as
the Document’s <a href="https://w3c.github.io/selection-api/#dfn-selection"> selection</a>, to indicate the text match. Doing so could allow attack vectors
for content exfiltration.</p>
   <p>The UA must not visually indicate any provided context terms.</p>
   <p>Since the indicator is not part of the document’s content, UAs should consider
ways to differentiate it from the page’s content as perceived by the user.</p>
   <div class="example" id="example-30d9320e"><a class="self-link" href="#example-30d9320e"></a> The UA could provide an in-product help prompt the first few times the
  indicator appears to help train the user that it comes from the linking page
  and is provided by the UA. </div>
   <h4 class="heading settled" data-level="3.7.1" id="urls-in-ua-features"><span class="secno">3.7.1. </span><span class="content">URLs in UA features</span><a class="self-link" href="#urls-in-ua-features"></a></h4>
   <p>UAs provide a number of consumers for a document’s URL (outside of programmatic
APIs like <code>window.location</code>). Examples include a location bar
indicating the URL of the currently visible document, or the URL used when a
user requests to create a bookmark for the current page.</p>
   <p>To avoid user confusion, UAs should be consistent in whether such URLs include
the <a data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive⑧">fragment directive</a>. This section provides a default set of
recommendations for how UAs can handle these cases.</p>
   <div class="note" role="note">
    <p> We provide these as a baseline for consistent behavior; however, as these
  features don’t affect cross-UA interoperability, they are not strict
  conformance requirements. </p>
    <p> Exact behavior is left up to the implementing UA which can have differing
  constraints or reasons for modifying the behavior. e.g. UAs can allow users
  to configure defaults or expose UI options so users can choose whether they
  prefer to include fragment directives in these URLs. </p>
    <p>It’s also useful to allow UAs to experiment with providing a better
  experience. E.g. perhaps the UA’s displayed URL can elide the text fragment if
  the user scrolls it out of view?</p>
    <p></p>
   </div>
   <p>The general principle is that a URL should include the <a data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive⑨">fragment directive</a> only while the visual indicator is visible (i.e. not dismissed). If the user
dismisses the indicator, the URL should reflect that by also removing the the <a data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive①⓪">fragment directive</a>.</p>
   <p>If the URL includes a text fragment but a match wasn’t found in the current
page, the UA may choose to omit it from the exposed URL.</p>
   <div class="note" role="note">
    <p> A text fragment that isn’t found on the page can be useful information to
  surface to a user to indicate that the page has changed since the link
  was created. </p>
    <p> However, it’s unlikely to be useful to the user in a bookmark. </p>
   </div>
   <p>A few common examples are provided below.</p>
   <div class="note" role="note"> We use "text fragment" and "fragment directive" interchangeably here as text
  fragments are assumed to be the only kind of directive. If additional
  directives are added in the future, the UX in these cases will have to be
  re-evaluated separately for new directive types. </div>
   <h5 class="heading settled" data-level="3.7.1.1" id="urls-in-location-bar"><span class="secno">3.7.1.1. </span><span class="content">Location Bar</span><a class="self-link" href="#urls-in-location-bar"></a></h5>
   <p>The location bar’s URL should include a text fragment while it is visually
indicated. The <a data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive①①">fragment directive</a> should be stripped from the location bar
URL when the user dismisses the indication.</p>
   <p>It is recommended that the text fragment be displayed in the location bar’s URL
even if a match wasn’t located in the document.</p>
   <h5 class="heading settled" data-level="3.7.1.2" id="urls-in-bookmarks"><span class="secno">3.7.1.2. </span><span class="content">Bookmarks</span><a class="self-link" href="#urls-in-bookmarks"></a></h5>
   <p>Many UAs provide a "bookmark" feature allowing users to store a convenient link
to the current page in the UA’s interface.</p>
   <p>A newly created bookmark should, by default, include the <a data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive①②">fragment directive</a> in the URL if, and only if, a match was found and the visual indicator hasn’t
been dismissed.</p>
   <p>Navigating to a URL from a bookmark should process a <a data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive①③">fragment directive</a> as
if it were navigated to in a typical navigation.</p>
   <h5 class="heading settled" data-level="3.7.1.3" id="urls-in-sharing"><span class="secno">3.7.1.3. </span><span class="content">Sharing</span><a class="self-link" href="#urls-in-sharing"></a></h5>
   <p>Some UAs provide a method for users to share the current page with others,
typically by providing the URL to another app or messaging service.</p>
   <p>When providing a URL in these situations, it should include the <a data-link-type="dfn" href="#fragment-directive" id="ref-for-fragment-directive①④">fragment
directive</a> if, and only if, a match was found and the visual indicator hasn’t
been dismissed.</p>
   <h3 class="heading settled" data-level="3.8" id="document-policy-integration"><span class="secno">3.8. </span><span class="content">Document Policy Integration</span><a class="self-link" href="#document-policy-integration"></a></h3>
   <p>This specification defines a <a href="https://wicg.github.io/document-policy#configuration-point">configuration point</a> in <a data-link-type="biblio" href="#biblio-document-policy" title="Document Policy">Document Policy</a> with name "force-load-at-top". Its <a href="https://wicg.github.io/document-policy#configuration-point-type">type</a> is <code>boolean</code> with <a href="https://wicg.github.io/document-policy#configuration-point-default-value">default value</a> <code>false</code>.</p>
   <div class="note" role="note"> When enabled, this policy disables all automatic scroll-on-load features:
  text-fragments, element fragments, history scroll restoration. </div>
   <div class="example" id="example-a128f34b">
    <a class="self-link" href="#example-a128f34b"></a> Suppose the user navigates to <code>https://example.com#:~:text=foo</code>. The
  example.com server response includes the header: 
<pre>Document-Policy: force-load-at-top
</pre>
    <p>When the page loads, the element containing "foo" will be marked as the
  indicated part and set as the document’s target element. However, "foo"
  will not be scrolled into view.</p>
   </div>
   <p>Fragment-based scroll blocking from this policy is specified in an amendment to the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-the-fragment-identifier" id="ref-for-scroll-to-the-fragment-identifier③">scroll to the fragment</a> algorithm in the <a href="#navigating-to-text-fragment">§ 3.6 Navigating to a Text Fragment</a> section of this document.</p>
   <p>History scroll restoration is blocked by amending the <a data-link-type="dfn" href="https://html.spec.whatwg.org/multipage/browsing-the-web.html#restore-persisted-state" id="ref-for-restore-persisted-state①">restore
persisted state</a> steps by inserting a new step after 2:</p>
   <ol start="3">
    <li data-md>
     <p><a href="https://wicg.github.io/document-policy#algo-get-policy-value">Get
the document policy value</a> of the "force-load-at-top" feature for the <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document①⓪">Document</a>. If
the result is true, then the user agent should not restore the scroll
position for the <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-document" id="ref-for-concept-document①①">Document</a> or any of its scrollable regions.</p>
   </ol>
   <h3 class="heading settled" data-level="3.9" id="feature-detectability"><span class="secno">3.9. </span><span class="content">Feature Detectability</span><a class="self-link" href="#feature-detectability"></a></h3>
   <p>For feature detectability, we propose adding a new FragmentDirective interface
that is exposed via <code>document.fragmentDirective</code> if the UA supports
the feature.</p>
<pre class="idl highlight def">[<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed" id="ref-for-Exposed"><c- g>Exposed</c-></a>=<c- n>Window</c->]
<c- b>interface</c-> <dfn class="dfn-paneled idl-code" data-dfn-type="interface" data-export id="fragmentdirective"><code><c- g>FragmentDirective</c-></code></dfn> {
};
</pre>
   <p>We amend the <code class="idl"><a data-link-type="idl" href="https://dom.spec.whatwg.org/#document" id="ref-for-document">Document</a></code> interface to include a <code>fragmentDirective</code> property:</p>
<pre class="idl highlight def"><c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#document" id="ref-for-document①"><c- g>Document</c-></a> {
    [<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#SameObject" id="ref-for-SameObject"><c- g>SameObject</c-></a>] <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#fragmentdirective" id="ref-for-fragmentdirective"><c- n>FragmentDirective</c-></a> <dfn class="idl-code" data-dfn-for="Document" data-dfn-type="attribute" data-export data-readonly data-type="FragmentDirective" id="dom-document-fragmentdirective"><code><c- g>fragmentDirective</c-></code><a class="self-link" href="#dom-document-fragmentdirective"></a></dfn>;
};
</pre>
   <p>This object may be used to expose additional information about the text
fragment or other fragment directives in the future.</p>
   <h2 class="heading settled" data-level="4" id="generating-text-fragment-directives"><span class="secno">4. </span><span class="content">Generating Text Fragment Directives</span><a class="self-link" href="#generating-text-fragment-directives"></a></h2>
   <div class="note" role="note"> This section is non-normative. </div>
   <p>This section contains recommendations for UAs automatically generating URLs
with a <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive⑨">text directive</a>. These recommendations aren’t normative but
are provided to ensure generated URLs result in maximally stable and usable
URLs.</p>
   <h3 class="heading settled" data-level="4.1" id="prefer-exact-matching-to-range-based"><span class="secno">4.1. </span><span class="content">Prefer Exact Matching To Range-based</span><a class="self-link" href="#prefer-exact-matching-to-range-based"></a></h3>
   <p>The match text can be provided either as an exact string "text=foo%20bar%20baz"
or as a range "text=foo,bar".</p>
   <p>Prefer to specify the entire string where practical. This ensures that if the
destination page is removed or changed, the intended destination can still be
derived from the URL itself.</p>
   <div class="example" id="example-53e82e58">
    <a class="self-link" href="#example-53e82e58"></a> Suppose we wish to craft a URL to
  https://en.wikipedia.org/wiki/History_of_computing quoting the sentence: 
<pre>The first recorded idea of using digital electronics for computing was the
1931 paper "The Use of Thyratrons for High Speed Automatic Counting of
Physical Phenomena" by C. E. Wynn-Williams.
</pre>
    <p>We could create a range-based match like so:</p>
    <p><a href="https://en.wikipedia.org/wiki/History_of_computing#:~:text=The%20first%20recorded,Williams"> https://en.wikipedia.org/wiki/History_of_computing#:~:text=The%20first%20recorded,Williams</a></p>
    <p>Or we could encode the entire sentence using an exact match term:</p>
    <p><a href="https://en.wikipedia.org/wiki/History_of_computing#:~:text=The%20first%20recorded%20idea%20of%20using%20digital%20electronics%20for%20computing%20was%20the%201931%20paper%20%22The%20Use%20of%20Thyratrons%20for%20High%20Speed%20Automatic%20Counting%20of%20Physical%20Phenomena%22%20by%20C.%20E.%20Wynn-Williams"> https://en.wikipedia.org/wiki/History_of_computing#:~:text=The%20first%20recorded%20idea%20of%20using%20digital%20electronics%20for%20computing%20was%20the%201931%20paper%20%22The%20Use%20of%20Thyratrons%20for%20High%20Speed%20Automatic%20Counting%20of%20Physical%20Phenomena%22%20by%20C.%20E.%20Wynn-Williams</a></p>
    <p>The range-based match is less stable, meaning that if the page is changed to
  include another instance of "The first recorded" somewhere earlier in the
  page, the link will now target an unintended text snippet.</p>
    <p>The range-based match is also less useful semantically. If the page is
  changed to remove the sentence, the user won’t know what the intended
  target was. In the exact match case, the user can read, or the UA can
  surface, the text that was being searched for but not found.</p>
   </div>
   <p>Range-based matches can be helpful when the quoted text is excessively long
and encoding the entire string would produce an unwieldy URL.</p>
   <p>Text snippets shorter than 300 characters are encouraged to be encoded using an
exact match. Above this limit, the UA can encode the string as a range-based
match.</p>
   <div class="note" role="note"> TODO:  Can we determine the above limit in some less arbitrary way? </div>
   <h3 class="heading settled" data-level="4.2" id="use-context-only-when-necessary"><span class="secno">4.2. </span><span class="content">Use Context Only When Necessary</span><a class="self-link" href="#use-context-only-when-necessary"></a></h3>
   <p>Context terms allow the <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive①⓪">text directive</a> to disambiguate text
snippets on a page. However, their use can make the URL more brittle in some
cases. Often, the desired string will start or end at an element boundary. The
context will therefore exist in an adjacent element. Changes to the page
structure could invalidate the <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive①①">text directive</a> since the context and
match text will no longer appear to be adjacent.</p>
   <div class="example" id="example-7a86f6f5">
    <a class="self-link" href="#example-7a86f6f5"></a> Suppose we wish to craft a URL for the following text: 
<pre>&lt;div class="section">HEADER&lt;/div>
&lt;div class="content">Text to quote&lt;/div>
</pre>
    <p>We could craft the <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive①②">text directive</a> as follows:</p>
<pre>text=HEADER-,Text%20to%20quote
</pre>
    <p>However, suppose the page changes to add a "[edit]" link beside all section
  headers. This would now break the URL.</p>
   </div>
   <p>Where a text snippet is long enough and unique, a UAs are encouraged to avoid
adding superfluous context terms.</p>
   <p>Use context only if one of the following is true:</p>
   <ul>
    <li>The UA determines the quoted text is ambiguous
    <li>The quoted text contains 3 or fewer words
   </ul>
   <div class="note" role="note"> TODO: Determine the numeric limit above in less arbitrary way. </div>
   <h3 class="heading settled" data-level="4.3" id="determine-if-fragment-id-is-needed"><span class="secno">4.3. </span><span class="content">Determine If Fragment Id Is Needed</span><a class="self-link" href="#determine-if-fragment-id-is-needed"></a></h3>
   <p>When the UA navigates to a URL containing a <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive①③">text directive</a>, it will
fallback to scrolling into view a regular element-id based fragment if it
exists and the text fragment isn’t found.</p>
   <p>This can be useful to provide a fallback, in case the text in the document
changes, invalidating the <a data-link-type="dfn" href="#text-directive" id="ref-for-text-directive①④">text directive</a>.</p>
   <div class="example" id="example-5990805b">
    <a class="self-link" href="#example-5990805b"></a> Suppose we wish to craft a URL to
  https://en.wikipedia.org/wiki/History_of_computing quoting the sentence: 
<pre>The earliest known tool for use in computation is the Sumerian abacus
</pre>
    <p>By specifying the section that the text appears in, we ensure that, if the
  text is changed or removed, the user will still be pointed to the relevant
  section:</p>
    <p><a href="https://en.wikipedia.org/wiki/History_of_computing#Early_computation:~:text=The%20earliest%20known%20tool%20for%20use%20in%20computation%20is%20the%20Sumerian%20abacus"> https://en.wikipedia.org/wiki/History_of_computing#Early_computation:~:text=The%20earliest%20known%20tool%20for%20use%20in%20computation%20is%20the%20Sumerian%20abacus</a></p>
   </div>
   <p>However, UAs should take care that the fallback element-id fragment is the
correct one:</p>
   <div class="example" id="example-3c4e565c">
    <a class="self-link" href="#example-3c4e565c"></a> Suppose the user navigates to
  https://en.wikipedia.org/wiki/History_of_computing#Early_computation. They
  now scroll down to the Symbolic Computations section. There, they select a
  text snippet and choose to create a URL to it: 
<pre>By the late 1960s, computer systems could perform symbolic algebraic
manipulations
</pre>
    <p>Even though the current URL of the page is:
  https://en.wikipedia.org/wiki/History_of_computing#Early_computation, using
  #Early_computation as a fallback is inappropriate. If the above sentence is
  changed or removed, the page will load in the #Early_computation section
  which could be quite confusing to the user.</p>
    <p>If the UA cannot reliably determine an appropriate fragment to fallback to,
  it should remove the fragment id from the URL:</p>
    <p><a href="https://en.wikipedia.org/wiki/History_of_computing#:~:text=By%20the%20late%201960s,%20computer%20systems%20could%20perform%20symbolic%20algebraic%20manipulations"> https://en.wikipedia.org/wiki/History_of_computing#:~:text=By%20the%20late%201960s,%20computer%20systems%20could%20perform%20symbolic%20algebraic%20manipulations</a></p>
   </div>
  </main>
  <div data-fill-with="conformance">
   <h2 class="no-ref no-num heading settled" id="w3c-conformance"><span class="content">Conformance</span><a class="self-link" href="#w3c-conformance"></a></h2>
   <h3 class="no-ref no-num heading settled" id="w3c-conventions"><span class="content">Document conventions</span><a class="self-link" href="#w3c-conventions"></a></h3>
   <p>Conformance requirements are expressed
    with a combination of descriptive assertions
    and RFC 2119 terminology.
    The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”
    in the normative parts of this document
    are to be interpreted as described in RFC 2119.
    However, for readability,
    these words do not appear in all uppercase letters in this specification. </p>
   <p>All of the text of this specification is normative
    except sections explicitly marked as non-normative, examples, and notes. <a data-link-type="biblio" href="#biblio-rfc2119" title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</a> </p>
   <p>Examples in this specification are introduced with the words “for example”
    or are set apart from the normative text
    with <code>class="example"</code>,
    like this: </p>
   <div class="example" id="w3c-example">
    <a class="self-link" href="#w3c-example"></a> 
    <p>This is an example of an informative example. </p>
   </div>
   <p>Informative notes begin with the word “Note”
    and are set apart from the normative text
    with <code>class="note"</code>,
    like this: </p>
   <p class="note" role="note">Note, this is an informative note.</p>
   <details class="wpt-tests-block" dir="ltr" lang="en" open>
    <summary>Tests</summary>
    <p>Tests relating to the content of this specification
                     may be documented in “Tests” blocks like this one.
                     Any such block is non-normative.</p>
    <ul class="wpt-tests-list"></ul>
    <hr>
   </details>
  </div>
<script src="https://www.w3.org/scripts/TR/2021/fixup.js"></script>
  <h2 class="no-num no-ref heading settled" id="index"><span class="content">Index</span><a class="self-link" href="#index"></a></h2>
  <h3 class="no-num no-ref heading settled" id="index-defined-here"><span class="content">Terms defined by this specification</span><a class="self-link" href="#index-defined-here"></a></h3>
  <ul class="index">
   <li><a href="#document-allow-text-fragment-scroll">allow text fragment scroll</a><span>, in § 3.5.4</span>
   <li><a href="#characterstring">CharacterString</a><span>, in § 3.3.4</span>
   <li><a href="#directives">directives</a><span>, in § 3.3</span>
   <li>
    directive state
    <ul>
     <li><a href="#directive-state">definition of</a><span>, in § 3.3.1</span>
     <li><a href="#she-directive-state">dfn for she</a><span>, in § 3.3.1</span>
    </ul>
   <li><a href="#text-directive-end">end</a><span>, in § 3.4</span>
   <li><a href="#explicitchar">ExplicitChar</a><span>, in § 3.3.4</span>
   <li><a href="#find-a-range-from-a-node-list">find a range from a node list</a><span>, in § 3.6.1</span>
   <li><a href="#find-a-range-from-a-text-directive">find a range from a text directive</a><span>, in § 3.6.1</span>
   <li><a href="#find-a-string-in-range">find a string in range</a><span>, in § 3.6.1</span>
   <li><a href="#first-common-ancestor">first common ancestor</a><span>, in § 3.6</span>
   <li><a href="#fragment-directive">fragment directive</a><span>, in § 3.3</span>
   <li>
    FragmentDirective
    <ul>
     <li><a href="#fragmentdirective">(interface)</a><span>, in § 3.9</span>
     <li><a href="#fragmentdirectiveproduction">definition of</a><span>, in § 3.3.4</span>
    </ul>
   <li><a href="#dom-document-fragmentdirective">fragmentDirective</a><span>, in § 3.9</span>
   <li><a href="#fragment-directive-delimiter">fragment directive delimiter</a><span>, in § 3.3</span>
   <li><a href="#get-boundary-point-at-index">get boundary point at index</a><span>, in § 3.6.1</span>
   <li><a href="#has-block-level-display">has block-level display</a><span>, in § 3.6.1</span>
   <li><a href="#invoke-text-directives">invoke text directives</a><span>, in § 3.6.1</span>
   <li><a href="#is-at-a-word-boundary">is at a word boundary</a><span>, in § 3.6.2</span>
   <li><a href="#locale">locale</a><span>, in § 3.6.2</span>
   <li><a href="#nearest-block-ancestor">nearest block ancestor</a><span>, in § 3.6.1</span>
   <li><a href="#next-non-whitespace-position">next non-whitespace position</a><span>, in § 3.6.1</span>
   <li><a href="#non-searchable-subtree">non-searchable subtree</a><span>, in § 3.6.1</span>
   <li><a href="#parse-a-text-directive">parse a text directive</a><span>, in § 3.4</span>
   <li><a href="#percentencodedbyte">PercentEncodedByte</a><span>, in § 3.3.4</span>
   <li><a href="#text-directive-prefix">prefix</a><span>, in § 3.4</span>
   <li><a href="#remove-the-fragment-directive">remove the fragment directive</a><span>, in § 3.3.1</span>
   <li><a href="#search-invisible">search invisible</a><span>, in § 3.6.1</span>
   <li><a href="#shadow-including-parent">shadow-including parent</a><span>, in § 3.6</span>
   <li><a href="#text-directive-start">start</a><span>, in § 3.4</span>
   <li><a href="#text-directive-suffix">suffix</a><span>, in § 3.4</span>
   <li><a href="#text-directive">text directive</a><span>, in § 3.4</span>
   <li><a href="#textdirective">TextDirective</a><span>, in § 3.3.4</span>
   <li><a href="#textdirectiveexplicitchar">TextDirectiveExplicitChar</a><span>, in § 3.3.4</span>
   <li><a href="#textdirectiveparameters">TextDirectiveParameters</a><span>, in § 3.3.4</span>
   <li><a href="#textdirectiveprefix">TextDirectivePrefix</a><span>, in § 3.3.4</span>
   <li><a href="#textdirectivestring">TextDirectiveString</a><span>, in § 3.3.4</span>
   <li><a href="#textdirectivesuffix">TextDirectiveSuffix</a><span>, in § 3.3.4</span>
   <li>
    text directive user activation
    <ul>
     <li><a href="#document-text-directive-user-activation">dfn for document</a><span>, in § 3.5.4</span>
     <li><a href="#request-text-directive-user-activation">dfn for request</a><span>, in § 3.5.4</span>
    </ul>
   <li><a href="#document-uninvoked-directives">uninvoked directives</a><span>, in § 3.3.2</span>
   <li><a href="#unknowndirective">UnknownDirective</a><span>, in § 3.3.4</span>
   <li><a href="#user-involvement">user involvement</a><span>, in § 3.5.4</span>
   <li><a href="#valid-fragment-directive">valid fragment directive</a><span>, in § 3.3.4</span>
   <li><a href="#directive-state-value">value</a><span>, in § 3.3.1</span>
   <li><a href="#visible-text-node">visible text node</a><span>, in § 3.6.1</span>
   <li><a href="#word-boundary">word boundary</a><span>, in § 3.6.2</span>
   <li><a href="#word-bounded">word bounded</a><span>, in § 3.6.2</span>
  </ul>
  <h3 class="no-num no-ref heading settled" id="index-defined-elsewhere"><span class="content">Terms defined by reference</span><a class="self-link" href="#index-defined-elsewhere"></a></h3>
  <ul class="index">
   <li>
    <a data-link-type="biblio">[CSS-CASCADE-5]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="9cd25054">computed value</span>
    </ul>
   <li>
    <a data-link-type="biblio">[CSS-DISPLAY-3]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="66498315">flex</span>
     <li><span class="dfn-paneled" id="a555386f">grid</span>
    </ul>
   <li>
    <a data-link-type="biblio">[CSS-DISPLAY-4]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="bb886fc6">block</span>
     <li><span class="dfn-paneled" id="e7f0dd6c">display</span>
     <li><span class="dfn-paneled" id="607244fc">flow-root</span>
     <li><span class="dfn-paneled" id="96626f55">list-item</span>
     <li><span class="dfn-paneled" id="55e8f5de">none</span>
     <li><span class="dfn-paneled" id="abb2bed7">table</span>
     <li><span class="dfn-paneled" id="12f8fb07">visibility</span>
     <li><span class="dfn-paneled" id="6420cb11">visible</span>
    </ul>
   <li>
    <a data-link-type="biblio">[CSSOM-VIEW-1]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="2cbb079e">scroll a target into view</span>
    </ul>
   <li>
    <a data-link-type="biblio">[DOM]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="85394472">Document</span>
     <li><span class="dfn-paneled" id="597088f0">Text</span>
     <li><span class="dfn-paneled" id="4fef809c">after</span>
     <li><span class="dfn-paneled" id="8a3e6de2">boundary point</span>
     <li><span class="dfn-paneled" id="8aac8409">collapsed</span>
     <li><span class="dfn-paneled" id="212ee1f7">data</span>
     <li><span class="dfn-paneled" id="cefd9ec1">doctype</span>
     <li><span class="dfn-paneled" id="a973e0fe">document</span>
     <li><span class="dfn-paneled" id="2f0ba72c">document element</span>
     <li><span class="dfn-paneled" id="27d9b7ea">element</span>
     <li><span class="dfn-paneled" id="5bbf7dec">end</span>
     <li><span class="dfn-paneled" id="3edd98b4">end node</span>
     <li><span class="dfn-paneled" id="203b148b">end offset</span>
     <li><span class="dfn-paneled" id="6fba6744">following</span>
     <li><span class="dfn-paneled" id="5d233601">host</span>
     <li><span class="dfn-paneled" id="5e8d5f81">length</span>
     <li><span class="dfn-paneled" id="d462b34f">node</span>
     <li><span class="dfn-paneled" id="5216e1a0">node document</span>
     <li><span class="dfn-paneled" id="d729a9ff">parent</span>
     <li><span class="dfn-paneled" id="5afeceea">parent element</span>
     <li><span class="dfn-paneled" id="8044ee41">range</span>
     <li><span class="dfn-paneled" id="3fcc582f">shadow root</span>
     <li><span class="dfn-paneled" id="8f378588">shadow-including ancestor</span>
     <li><span class="dfn-paneled" id="fd32e3c9">shadow-including descendant</span>
     <li><span class="dfn-paneled" id="3d6a3d36">shadow-including inclusive ancestor</span>
     <li><span class="dfn-paneled" id="fefa5851">shadow-including tree order</span>
     <li><span class="dfn-paneled" id="936c50ab">start</span>
     <li><span class="dfn-paneled" id="6c88f67e">start node</span>
     <li><span class="dfn-paneled" id="683b1507">start offset</span>
     <li><span class="dfn-paneled" id="c9f15d91">substring data</span>
     <li><span class="dfn-paneled" id="347e8fe9">url</span>
    </ul>
   <li>
    <a data-link-type="biblio">[FETCH]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="55213b5b">request</span>
    </ul>
   <li>
    <a data-link-type="biblio">[HTML]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="fe2a6718">HTMLAudioElement</span>
     <li><span class="dfn-paneled" id="10e25f42">HTMLIFrameElement</span>
     <li><span class="dfn-paneled" id="c5891539">HTMLImageElement</span>
     <li><span class="dfn-paneled" id="cc59b66b">HTMLMeterElement</span>
     <li><span class="dfn-paneled" id="59ce5887">HTMLObjectElement</span>
     <li><span class="dfn-paneled" id="fcadc50c">HTMLProgressElement</span>
     <li><span class="dfn-paneled" id="ec4838d8">HTMLScriptElement</span>
     <li><span class="dfn-paneled" id="aa8746c3">HTMLStyleElement</span>
     <li><span class="dfn-paneled" id="f57f330b">HTMLVideoElement</span>
     <li><span class="dfn-paneled" id="78492a07">HashChangeEvent</span>
     <li><span class="dfn-paneled" id="cc549724">Location</span>
     <li><span class="dfn-paneled" id="35972864">active document</span>
     <li><span class="dfn-paneled" id="f8434dee">being rendered</span>
     <li><span class="dfn-paneled" id="3b2ff63e">browsing context</span>
     <li><span class="dfn-paneled" id="b0b49d3c">browsing context set</span>
     <li><span class="dfn-paneled" id="d4dbbbf0">language</span>
     <li><span class="dfn-paneled" id="b07164ad">multiple</span>
     <li><span class="dfn-paneled" id="2594e562">navigate</span>
     <li><span class="dfn-paneled" id="8b87b428">restore persisted state</span>
     <li><span class="dfn-paneled" id="7393da89">same origin</span>
     <li><span class="dfn-paneled" id="3f2e859c">scroll to the fragment</span>
     <li><span class="dfn-paneled" id="85188fb3">select</span>
     <li><span class="dfn-paneled" id="c3ae9e6a">serializes as void</span>
     <li><span class="dfn-paneled" id="8a051c9f">try to scroll to the fragment</span>
     <li><span class="dfn-paneled" id="5c1d019b">update document for history step application</span>
    </ul>
   <li>
    <a data-link-type="biblio">[INFRA]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="53275e46">append</span>
     <li><span class="dfn-paneled" id="2d5a2765">ascii string</span>
     <li><span class="dfn-paneled" id="77b4c09a">assert</span>
     <li><span class="dfn-paneled" id="7b0d918d">break</span>
     <li><span class="dfn-paneled" id="915aff5e">code point</span>
     <li><span class="dfn-paneled" id="4ef39030">code point length</span>
     <li><span class="dfn-paneled" id="cfd05055">code point substring by positions</span>
     <li><span class="dfn-paneled" id="b8906bbb">code point substring to the end of the string</span>
     <li><span class="dfn-paneled" id="4a3bf5fb">concatenate</span>
     <li><span class="dfn-paneled" id="f937b7b6">continue</span>
     <li><span class="dfn-paneled" id="f052b1ea">html namespace</span>
     <li><span class="dfn-paneled" id="860300d4">implementation-defined</span>
     <li><span class="dfn-paneled" id="0fa357c3">length</span>
     <li><span class="dfn-paneled" id="649608b9">list</span>
     <li><span class="dfn-paneled" id="75bee4d5">position variable</span>
     <li><span class="dfn-paneled" id="99c988d6">remove</span>
     <li><span class="dfn-paneled" id="0204d188">size</span>
     <li><span class="dfn-paneled" id="0437147c">split on commas</span>
     <li><span class="dfn-paneled" id="7a3dbdb1">strictly split a string</span>
     <li><span class="dfn-paneled" id="0698d556">string</span>
     <li><span class="dfn-paneled" id="984221ca">struct</span>
    </ul>
   <li>
    <a data-link-type="biblio">[URL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="ed948033">fragment</span>
     <li><span class="dfn-paneled" id="8f69ce41">percent-decode</span>
     <li><span class="dfn-paneled" id="dcffbccd">url</span>
     <li><span class="dfn-paneled" id="4bb788fe">url code point</span>
    </ul>
   <li>
    <a data-link-type="biblio">[WEBIDL]</a> defines the following terms:
    <ul>
     <li><span class="dfn-paneled" id="889e932f">Exposed</span>
     <li><span class="dfn-paneled" id="a5c91173">SameObject</span>
    </ul>
  </ul>
  <h2 class="no-num no-ref heading settled" id="references"><span class="content">References</span><a class="self-link" href="#references"></a></h2>
  <h3 class="no-num no-ref heading settled" id="normative"><span class="content">Normative References</span><a class="self-link" href="#normative"></a></h3>
  <dl>
   <dt id="biblio-css-cascade-5">[CSS-CASCADE-5]
   <dd>Elika Etemad; Miriam Suzanne; Tab Atkins Jr.. <a href="https://drafts.csswg.org/css-cascade-5/"><cite>CSS Cascading and Inheritance Level 5</cite></a>. URL: <a href="https://drafts.csswg.org/css-cascade-5/">https://drafts.csswg.org/css-cascade-5/</a>
   <dt id="biblio-css-display-3">[CSS-DISPLAY-3]
   <dd>Elika Etemad; Tab Atkins Jr.. <a href="https://drafts.csswg.org/css-display/"><cite>CSS Display Module Level 3</cite></a>. URL: <a href="https://drafts.csswg.org/css-display/">https://drafts.csswg.org/css-display/</a>
   <dt id="biblio-css-display-4">[CSS-DISPLAY-4]
   <dd><a href="https://drafts.csswg.org/css-display-4/"><cite>CSS Display Module Level 4</cite></a>. Editor's Draft. URL: <a href="https://drafts.csswg.org/css-display-4/">https://drafts.csswg.org/css-display-4/</a>
   <dt id="biblio-cssom-view-1">[CSSOM-VIEW-1]
   <dd>Simon Pieters. <a href="https://drafts.csswg.org/cssom-view/"><cite>CSSOM View Module</cite></a>. URL: <a href="https://drafts.csswg.org/cssom-view/">https://drafts.csswg.org/cssom-view/</a>
   <dt id="biblio-document-policy">[DOCUMENT-POLICY]
   <dd>Ian Clelland. <a href="https://wicg.github.io/document-policy"><cite>Document Policy</cite></a>. ED. URL: <a href="https://wicg.github.io/document-policy">https://wicg.github.io/document-policy</a>
   <dt id="biblio-dom">[DOM]
   <dd>Anne van Kesteren. <a href="https://dom.spec.whatwg.org/"><cite>DOM Standard</cite></a>. Living Standard. URL: <a href="https://dom.spec.whatwg.org/">https://dom.spec.whatwg.org/</a>
   <dt id="biblio-fetch">[FETCH]
   <dd>Anne van Kesteren. <a href="https://fetch.spec.whatwg.org/"><cite>Fetch Standard</cite></a>. Living Standard. URL: <a href="https://fetch.spec.whatwg.org/">https://fetch.spec.whatwg.org/</a>
   <dt id="biblio-html">[HTML]
   <dd>Anne van Kesteren; et al. <a href="https://html.spec.whatwg.org/multipage/"><cite>HTML Standard</cite></a>. Living Standard. URL: <a href="https://html.spec.whatwg.org/multipage/">https://html.spec.whatwg.org/multipage/</a>
   <dt id="biblio-infra">[INFRA]
   <dd>Anne van Kesteren; Domenic Denicola. <a href="https://infra.spec.whatwg.org/"><cite>Infra Standard</cite></a>. Living Standard. URL: <a href="https://infra.spec.whatwg.org/">https://infra.spec.whatwg.org/</a>
   <dt id="biblio-rfc2119">[RFC2119]
   <dd>S. Bradner. <a href="https://datatracker.ietf.org/doc/html/rfc2119"><cite>Key words for use in RFCs to Indicate Requirement Levels</cite></a>. March 1997. Best Current Practice. URL: <a href="https://datatracker.ietf.org/doc/html/rfc2119">https://datatracker.ietf.org/doc/html/rfc2119</a>
   <dt id="biblio-uax29">[UAX29]
   <dd>Josh Hadley. <a href="https://www.unicode.org/reports/tr29/tr29-43.html"><cite>Unicode Text Segmentation</cite></a>. 16 August 2023. Unicode Standard Annex #29. URL: <a href="https://www.unicode.org/reports/tr29/tr29-43.html">https://www.unicode.org/reports/tr29/tr29-43.html</a>
   <dt id="biblio-url">[URL]
   <dd>Anne van Kesteren. <a href="https://url.spec.whatwg.org/"><cite>URL Standard</cite></a>. Living Standard. URL: <a href="https://url.spec.whatwg.org/">https://url.spec.whatwg.org/</a>
   <dt id="biblio-uts10">[UTS10]
   <dd>Ken Whistler; Markus Scherer. <a href="https://www.unicode.org/reports/tr10/tr10-49.html"><cite>Unicode Collation Algorithm</cite></a>. 5 September 2023. Unicode Technical Standard #10. URL: <a href="https://www.unicode.org/reports/tr10/tr10-49.html">https://www.unicode.org/reports/tr10/tr10-49.html</a>
   <dt id="biblio-webidl">[WEBIDL]
   <dd>Edgar Chen; Timothy Gu. <a href="https://webidl.spec.whatwg.org/"><cite>Web IDL Standard</cite></a>. Living Standard. URL: <a href="https://webidl.spec.whatwg.org/">https://webidl.spec.whatwg.org/</a>
  </dl>
  <h3 class="no-num no-ref heading settled" id="informative"><span class="content">Informative References</span><a class="self-link" href="#informative"></a></h3>
  <dl>
   <dt id="biblio-bcp47">[BCP47]
   <dd>A. Phillips, Ed.; M. Davis, Ed.. <a href="https://www.rfc-editor.org/rfc/rfc5646"><cite>Tags for Identifying Languages</cite></a>. September 2009. Best Current Practice. URL: <a href="https://www.rfc-editor.org/rfc/rfc5646">https://www.rfc-editor.org/rfc/rfc5646</a>
   <dt id="biblio-fetch-metadata">[FETCH-METADATA]
   <dd>Mike West. <a href="https://w3c.github.io/webappsec-fetch-metadata/"><cite>Fetch Metadata Request Headers</cite></a>. WD. URL: <a href="https://w3c.github.io/webappsec-fetch-metadata/">https://w3c.github.io/webappsec-fetch-metadata/</a>
  </dl>
  <h2 class="no-num no-ref heading settled" id="idl-index"><span class="content">IDL Index</span><a class="self-link" href="#idl-index"></a></h2>
<pre class="idl highlight def">[<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#Exposed"><c- g>Exposed</c-></a>=<c- n>Window</c->]
<c- b>interface</c-> <a href="#fragmentdirective"><code><c- g>FragmentDirective</c-></code></a> {
};

<c- b>partial</c-> <c- b>interface</c-> <a class="idl-code" data-link-type="interface" href="https://dom.spec.whatwg.org/#document"><c- g>Document</c-></a> {
    [<a class="idl-code" data-link-type="extended-attribute" href="https://webidl.spec.whatwg.org/#SameObject"><c- g>SameObject</c-></a>] <c- b>readonly</c-> <c- b>attribute</c-> <a data-link-type="idl-name" href="#fragmentdirective"><c- n>FragmentDirective</c-></a> <a data-readonly data-type="FragmentDirective" href="#dom-document-fragmentdirective"><code><c- g>fragmentDirective</c-></code></a>;
};

</pre>
  <h2 class="no-num no-ref heading settled" id="issues-index"><span class="content">Issues Index</span><a class="self-link" href="#issues-index"></a></h2>
  <div style="counter-reset:issue">
   <div class="issue"> TODO: If a URL’s fragment ends with ':~:' (i.e. empty directive), this will return null which
    is treated as the URL not specifying an explicit directive (and avoids clobbering an existing
    one. But maybe in this case we should return the empty string? That way a page can explicitly
    clear directives/highlights by navigating/pushState to '#:~:'. <a class="issue-return" href="#issue-f4a5d96b" title="Jump to section">↵</a></div>
   <div class="issue"> What should be set as target if inside a shadow tree? <a href="https://github.com/WICG/scroll-to-text-fragment/issues/190">#190</a> <a class="issue-return" href="#issue-424a4e25" title="Jump to section">↵</a></div>
   <div class="issue"> These revealing algorithms currently wont work well since <var>target</var> could be an
      ancestor or even the root document node. Issue <a href="https://github.com/WICG/scroll-to-text-fragment/issues/89">#89</a> proposes
      restricting matches to <code>contain:style layout</code> blocks which would resolve this
      problem. <a class="issue-return" href="#issue-10739530" title="Jump to section">↵</a></div>
   <div class="issue">Implementation note: Blink doesn’t currently set focus for text
  fragments, it probably should? TODO: file crbug. <a class="issue-return" href="#issue-e253a983" title="Jump to section">↵</a></div>
   <div class="issue"> This isn’t strictly true, Chrome
allows this for same-origin initiators. Need to update the spec on this
point. <a href="https://github.com/WICG/scroll-to-text-fragment/issues/240">[Issue #WICG/scroll-to-text-fragment#240]</a> <a class="issue-return" href="#issue-35f490f0" title="Jump to section">↵</a></div>
   <div class="issue"> Need to decide how <code>force-load-at-top</code> interacts with the Navigation API. <a href="https://github.com/WICG/scroll-to-text-fragment/issues/242">[Issue #WICG/scroll-to-text-fragment#242]</a> <a class="issue-return" href="#issue-de0fed9d" title="Jump to section">↵</a></div>
   <div class="issue"> <a data-link-type="dfn" href="https://dom.spec.whatwg.org/#concept-cd-data">data</a> is not
correct here since that’s the text data as it exists in the DOM. This
algorithm means to run over the text as rendered (and then convert back
to Ranges in the DOM). <a href="https://github.com/WICG/scroll-to-text-fragment/issues/98">[Issue #WICG/scroll-to-text-fragment#98]</a> <a class="issue-return" href="#issue-96fe4755" title="Jump to section">↵</a></div>
  </div>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
    const dfnsJson = window.dfnsJson || {};

    function genDfnPanel({dfnID, url, dfnText, refSections, external}) {
        return mk.aside({
            class: "dfn-panel",
            id: `infopanel-for-${dfnID}`,
            "data-for": dfnID,
            "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
            },
            mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
                `Info about the '${dfnText}' ${external?"external":""} reference.`),
            mk.a({href:url}, url),
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({
                                    href: `#${ref.id}`
                                    },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        );
    }

    function genAllDfnPanels() {
        for(const panelData of Object.values(window.dfnpanelData)) {
            const dfnID = panelData.dfnID;
            const dfn = document.getElementById(dfnID);
            if(!dfn) {
                console.log(`Can't find dfn#${dfnID}.`, panelData);
            } else {
                const panel = genDfnPanel(panelData);
                append(document.body, panel);
                insertDfnPopupAction(dfn, panel)
            }
        }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
        genAllDfnPanels();

        // Add popup behavior to all dfns to show the corresponding dfn-panel.
        var dfns = queryAll('.dfn-paneled');
        for(let dfn of dfns) { ; }

        document.body.addEventListener("click", (e) => {
            // If not handled already, just hide all dfn panels.
            hideAllDfnPanels();
        });
    })


    function hideAllDfnPanels() {
        // Turn off any currently "on" or "activated" panels.
        queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>hideDfnPanel(el));
    }

    function showDfnPanel(dfnPanel, dfn) {
        hideAllDfnPanels(); // Only display one at this time.
        dfn.setAttribute("aria-expanded", "true");
        dfnPanel.classList.add("on");
        dfnPanel.style.left = "5px";
        dfnPanel.style.top = "0px";
        const panelRect = dfnPanel.getBoundingClientRect();
        const panelWidth = panelRect.right - panelRect.left;
        if (panelRect.right > document.body.scrollWidth) {
            // Panel's overflowing the screen.
            // Just drop it below the dfn and flip it rightward instead.
            // This still wont' fix things if the screen is *really* wide,
            // but fixing that's a lot harder without 'anchor()'.
            dfnPanel.style.top = "1.5em";
            dfnPanel.style.left = "auto";
            dfnPanel.style.right = "0px";
        }
    }

    function pinDfnPanel(dfnPanel) {
        // Switch it to "activated" state, which pins it.
        dfnPanel.classList.add("activated");
        dfnPanel.style.left = null;
        dfnPanel.style.top = null;
    }

    function hideDfnPanel(dfnPanel, dfn) {
        if(!dfn) {
            dfn = document.getElementById(dfnPanel.getAttribute("data-for"));
        }
        dfn.setAttribute("aria-expanded", "false")
        dfnPanel.classList.remove("on");
        dfnPanel.classList.remove("activated");
    }

    function toggleDfnPanel(dfnPanel, dfn) {
        if(dfnPanel.classList.contains("on")) {
            hideDfnPanel(dfnPanel, dfn);
        } else {
            showDfnPanel(dfnPanel, dfn);
        }
    }

    function insertDfnPopupAction(dfn, dfnPanel) {
        // Find dfn panel
        const panelWrapper = document.createElement('span');
        panelWrapper.appendChild(dfnPanel);
        panelWrapper.style.position = "relative";
        panelWrapper.style.height = "0px";
        dfn.insertAdjacentElement("afterend", panelWrapper);
        dfn.setAttribute('role', 'button');
        dfn.setAttribute('aria-expanded', 'false')
        dfn.tabIndex = 0;
        dfn.classList.add('has-dfn-panel');
        dfn.addEventListener('click', (event) => {
            showDfnPanel(dfnPanel, dfn);
            event.stopPropagation();
        });
        dfn.addEventListener('keypress', (event) => {
            const kc = event.keyCode;
            // 32->Space, 13->Enter
            if(kc == 32 || kc == 13) {
                toggleDfnPanel(dfnPanel, dfn);
                event.stopPropagation();
                event.preventDefault();
            }
        });

        dfnPanel.addEventListener('click', (event) => {
            if (event.target.nodeName == 'A') {
                pinDfnPanel(dfnPanel);
            }
            event.stopPropagation();
        });

        dfnPanel.addEventListener('keydown', (event) => {
            if(event.keyCode == 27) { // Escape key
                hideDfnPanel(dfnPanel, dfn);
                event.stopPropagation();
                event.preventDefault();
            }
        })
    }
}
</script>
<script>/* Boilerplate: script-dfn-panel */
"use strict";
{
    const dfnsJson = window.dfnsJson || {};

    function genDfnPanel({dfnID, url, dfnText, refSections, external}) {
        return mk.aside({
            class: "dfn-panel",
            id: `infopanel-for-${dfnID}`,
            "data-for": dfnID,
            "aria-labelled-by":`infopaneltitle-for-${dfnID}`,
            },
            mk.span({id:`infopaneltitle-for-${dfnID}`, style:"display:none"},
                `Info about the '${dfnText}' ${external?"external":""} reference.`),
            mk.a({href:url}, url),
            mk.b({}, "Referenced in:"),
            mk.ul({},
                ...refSections.map(section=>
                    mk.li({},
                        ...section.refs.map((ref, refI)=>
                            [
                                mk.a({
                                    href: `#${ref.id}`
                                    },
                                    (refI == 0) ? section.title : `(${refI + 1})`
                                ),
                                " ",
                            ]
                        ),
                    ),
                ),
            ),
        );
    }

    function genAllDfnPanels() {
        for(const panelData of Object.values(window.dfnpanelData)) {
            const dfnID = panelData.dfnID;
            const dfn = document.getElementById(dfnID);
            if(!dfn) {
                console.log(`Can't find dfn#${dfnID}.`, panelData);
            } else {
                const panel = genDfnPanel(panelData);
                append(document.body, panel);
                insertDfnPopupAction(dfn, panel)
            }
        }
    }

    document.addEventListener("DOMContentLoaded", ()=>{
        genAllDfnPanels();

        // Add popup behavior to all dfns to show the corresponding dfn-panel.
        var dfns = queryAll('.dfn-paneled');
        for(let dfn of dfns) { ; }

        document.body.addEventListener("click", (e) => {
            // If not handled already, just hide all dfn panels.
            hideAllDfnPanels();
        });
    })


    function hideAllDfnPanels() {
        // Turn off any currently "on" or "activated" panels.
        queryAll(".dfn-panel.on, .dfn-panel.activated").forEach(el=>hideDfnPanel(el));
    }

    function showDfnPanel(dfnPanel, dfn) {
        hideAllDfnPanels(); // Only display one at this time.
        dfn.setAttribute("aria-expanded", "true");
        dfnPanel.classList.add("on");
        dfnPanel.style.left = "5px";
        dfnPanel.style.top = "0px";
        const panelRect = dfnPanel.getBoundingClientRect();
        const panelWidth = panelRect.right - panelRect.left;
        if (panelRect.right > document.body.scrollWidth) {
            // Panel's overflowing the screen.
            // Just drop it below the dfn and flip it rightward instead.
            // This still wont' fix things if the screen is *really* wide,
            // but fixing that's a lot harder without 'anchor()'.
            dfnPanel.style.top = "1.5em";
            dfnPanel.style.left = "auto";
            dfnPanel.style.right = "0px";
        }
    }

    function pinDfnPanel(dfnPanel) {
        // Switch it to "activated" state, which pins it.
        dfnPanel.classList.add("activated");
        dfnPanel.style.left = null;
        dfnPanel.style.top = null;
    }

    function hideDfnPanel(dfnPanel, dfn) {
        if(!dfn) {
            dfn = document.getElementById(dfnPanel.getAttribute("data-for"));
        }
        dfn.setAttribute("aria-expanded", "false")
        dfnPanel.classList.remove("on");
        dfnPanel.classList.remove("activated");
    }

    function toggleDfnPanel(dfnPanel, dfn) {
        if(dfnPanel.classList.contains("on")) {
            hideDfnPanel(dfnPanel, dfn);
        } else {
            showDfnPanel(dfnPanel, dfn);
        }
    }

    function insertDfnPopupAction(dfn, dfnPanel) {
        // Find dfn panel
        const panelWrapper = document.createElement('span');
        panelWrapper.appendChild(dfnPanel);
        panelWrapper.style.position = "relative";
        panelWrapper.style.height = "0px";
        dfn.insertAdjacentElement("afterend", panelWrapper);
        dfn.setAttribute('role', 'button');
        dfn.setAttribute('aria-expanded', 'false')
        dfn.tabIndex = 0;
        dfn.classList.add('has-dfn-panel');
        dfn.addEventListener('click', (event) => {
            showDfnPanel(dfnPanel, dfn);
            event.stopPropagation();
        });
        dfn.addEventListener('keypress', (event) => {
            const kc = event.keyCode;
            // 32->Space, 13->Enter
            if(kc == 32 || kc == 13) {
                toggleDfnPanel(dfnPanel, dfn);
                event.stopPropagation();
                event.preventDefault();
            }
        });

        dfnPanel.addEventListener('click', (event) => {
            if (event.target.nodeName == 'A') {
                pinDfnPanel(dfnPanel);
            }
            event.stopPropagation();
        });

        dfnPanel.addEventListener('keydown', (event) => {
            if(event.keyCode == 27) { // Escape key
                hideDfnPanel(dfnPanel, dfn);
                event.stopPropagation();
                event.preventDefault();
            }
        })
    }
}
</script>
<script>/* Boilerplate: script-dfn-panel-json */
window.dfnpanelData = {};
window.dfnpanelData['9cd25054'] = {"dfnID": "9cd25054", "url": "https://drafts.csswg.org/css-cascade-5/#computed-value", "dfnText": "computed value", "refSections": [{"refs": [{"id": "ref-for-computed-value"}, {"id": "ref-for-computed-value\u2460"}, {"id": "ref-for-computed-value\u2461"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['66498315'] = {"dfnID": "66498315", "url": "https://drafts.csswg.org/css-display-3/#valdef-display-flex", "dfnText": "flex", "refSections": [{"refs": [{"id": "ref-for-valdef-display-flex"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['a555386f'] = {"dfnID": "a555386f", "url": "https://drafts.csswg.org/css-display-3/#valdef-display-grid", "dfnText": "grid", "refSections": [{"refs": [{"id": "ref-for-valdef-display-grid"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['bb886fc6'] = {"dfnID": "bb886fc6", "url": "https://drafts.csswg.org/css-display-4/#valdef-display-block", "dfnText": "block", "refSections": [{"refs": [{"id": "ref-for-valdef-display-block"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['e7f0dd6c'] = {"dfnID": "e7f0dd6c", "url": "https://drafts.csswg.org/css-display-4/#propdef-display", "dfnText": "display", "refSections": [{"refs": [{"id": "ref-for-propdef-display"}, {"id": "ref-for-propdef-display\u2460"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['607244fc'] = {"dfnID": "607244fc", "url": "https://drafts.csswg.org/css-display-4/#valdef-display-flow-root", "dfnText": "flow-root", "refSections": [{"refs": [{"id": "ref-for-valdef-display-flow-root"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['96626f55'] = {"dfnID": "96626f55", "url": "https://drafts.csswg.org/css-display-4/#valdef-display-list-item", "dfnText": "list-item", "refSections": [{"refs": [{"id": "ref-for-valdef-display-list-item"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['55e8f5de'] = {"dfnID": "55e8f5de", "url": "https://drafts.csswg.org/css-display-4/#valdef-display-none", "dfnText": "none", "refSections": [{"refs": [{"id": "ref-for-valdef-display-none"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['abb2bed7'] = {"dfnID": "abb2bed7", "url": "https://drafts.csswg.org/css-display-4/#valdef-display-table", "dfnText": "table", "refSections": [{"refs": [{"id": "ref-for-valdef-display-table"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['12f8fb07'] = {"dfnID": "12f8fb07", "url": "https://drafts.csswg.org/css-display-4/#propdef-visibility", "dfnText": "visibility", "refSections": [{"refs": [{"id": "ref-for-propdef-visibility"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['6420cb11'] = {"dfnID": "6420cb11", "url": "https://drafts.csswg.org/css-display-4/#valdef-visibility-visible", "dfnText": "visible", "refSections": [{"refs": [{"id": "ref-for-valdef-visibility-visible"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['2cbb079e'] = {"dfnID": "2cbb079e", "url": "https://drafts.csswg.org/cssom-view-1/#scroll-a-target-into-view", "dfnText": "scroll a target into view", "refSections": [{"refs": [{"id": "ref-for-scroll-a-target-into-view"}], "title": "3.4.1. Invoking Text Directives"}], "external": true};
window.dfnpanelData['85394472'] = {"dfnID": "85394472", "url": "https://dom.spec.whatwg.org/#document", "dfnText": "Document", "refSections": [{"refs": [{"id": "ref-for-document"}, {"id": "ref-for-document\u2460"}], "title": "3.9. Feature Detectability"}], "external": true};
window.dfnpanelData['597088f0'] = {"dfnID": "597088f0", "url": "https://dom.spec.whatwg.org/#text", "dfnText": "Text", "refSections": [{"refs": [{"id": "ref-for-text"}, {"id": "ref-for-text\u2460"}, {"id": "ref-for-text\u2461"}, {"id": "ref-for-text\u2462"}, {"id": "ref-for-text\u2463"}, {"id": "ref-for-text\u2464"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['4fef809c'] = {"dfnID": "4fef809c", "url": "https://dom.spec.whatwg.org/#concept-range-bp-after", "dfnText": "after", "refSections": [{"refs": [{"id": "ref-for-concept-range-bp-after"}, {"id": "ref-for-concept-range-bp-after\u2460"}, {"id": "ref-for-concept-range-bp-after\u2461"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['8a3e6de2'] = {"dfnID": "8a3e6de2", "url": "https://dom.spec.whatwg.org/#concept-range-bp", "dfnText": "boundary point", "refSections": [{"refs": [{"id": "ref-for-concept-range-bp"}, {"id": "ref-for-concept-range-bp\u2460"}, {"id": "ref-for-concept-range-bp\u2461"}, {"id": "ref-for-concept-range-bp\u2462"}, {"id": "ref-for-concept-range-bp\u2463"}, {"id": "ref-for-concept-range-bp\u2464"}, {"id": "ref-for-concept-range-bp\u2465"}, {"id": "ref-for-concept-range-bp\u2466"}, {"id": "ref-for-concept-range-bp\u2467"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['8aac8409'] = {"dfnID": "8aac8409", "url": "https://dom.spec.whatwg.org/#range-collapsed", "dfnText": "collapsed", "refSections": [{"refs": [{"id": "ref-for-range-collapsed"}, {"id": "ref-for-range-collapsed\u2460"}, {"id": "ref-for-range-collapsed\u2461"}, {"id": "ref-for-range-collapsed\u2462"}, {"id": "ref-for-range-collapsed\u2463"}, {"id": "ref-for-range-collapsed\u2464"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['212ee1f7'] = {"dfnID": "212ee1f7", "url": "https://dom.spec.whatwg.org/#concept-cd-data", "dfnText": "data", "refSections": [{"refs": [{"id": "ref-for-concept-cd-data"}, {"id": "ref-for-concept-cd-data\u2460"}, {"id": "ref-for-concept-cd-data\u2461"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['cefd9ec1'] = {"dfnID": "cefd9ec1", "url": "https://dom.spec.whatwg.org/#concept-doctype", "dfnText": "doctype", "refSections": [{"refs": [{"id": "ref-for-concept-doctype"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['a973e0fe'] = {"dfnID": "a973e0fe", "url": "https://dom.spec.whatwg.org/#concept-document", "dfnText": "document", "refSections": [{"refs": [{"id": "ref-for-concept-document"}], "title": "3.3.2. Applying directives to a document"}, {"refs": [{"id": "ref-for-concept-document\u2460"}], "title": "3.5.3. Search Timing"}, {"refs": [{"id": "ref-for-concept-document\u2461"}, {"id": "ref-for-concept-document\u2462"}, {"id": "ref-for-concept-document\u2463"}, {"id": "ref-for-concept-document\u2464"}, {"id": "ref-for-concept-document\u2465"}, {"id": "ref-for-concept-document\u2466"}], "title": "3.5.4. Restricting the Text Fragment"}, {"refs": [{"id": "ref-for-concept-document\u2467"}, {"id": "ref-for-concept-document\u2468"}], "title": "3.6.1. Finding Ranges in a Document"}, {"refs": [{"id": "ref-for-concept-document\u2460\u24ea"}, {"id": "ref-for-concept-document\u2460\u2460"}], "title": "3.8. Document Policy Integration"}], "external": true};
window.dfnpanelData['2f0ba72c'] = {"dfnID": "2f0ba72c", "url": "https://dom.spec.whatwg.org/#document-element", "dfnText": "document element", "refSections": [{"refs": [{"id": "ref-for-document-element"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['27d9b7ea'] = {"dfnID": "27d9b7ea", "url": "https://dom.spec.whatwg.org/#concept-element", "dfnText": "element", "refSections": [{"refs": [{"id": "ref-for-concept-element"}, {"id": "ref-for-concept-element\u2460"}], "title": "3.4.1. Invoking Text Directives"}, {"refs": [{"id": "ref-for-concept-element\u2461"}], "title": "3.6. Navigating to a Text Fragment"}, {"refs": [{"id": "ref-for-concept-element\u2462"}, {"id": "ref-for-concept-element\u2463"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['5bbf7dec'] = {"dfnID": "5bbf7dec", "url": "https://dom.spec.whatwg.org/#concept-range-end", "dfnText": "end", "refSections": [{"refs": [{"id": "ref-for-concept-range-end"}, {"id": "ref-for-concept-range-end\u2460"}, {"id": "ref-for-concept-range-end\u2461"}, {"id": "ref-for-concept-range-end\u2462"}, {"id": "ref-for-concept-range-end\u2463"}, {"id": "ref-for-concept-range-end\u2464"}, {"id": "ref-for-concept-range-end\u2465"}, {"id": "ref-for-concept-range-end\u2466"}, {"id": "ref-for-concept-range-end\u2467"}, {"id": "ref-for-concept-range-end\u2468"}, {"id": "ref-for-concept-range-end\u2460\u24ea"}, {"id": "ref-for-concept-range-end\u2460\u2460"}, {"id": "ref-for-concept-range-end\u2460\u2461"}, {"id": "ref-for-concept-range-end\u2460\u2462"}, {"id": "ref-for-concept-range-end\u2460\u2463"}, {"id": "ref-for-concept-range-end\u2460\u2464"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['3edd98b4'] = {"dfnID": "3edd98b4", "url": "https://dom.spec.whatwg.org/#concept-range-end-node", "dfnText": "end node", "refSections": [{"refs": [{"id": "ref-for-concept-range-end-node"}], "title": "3.4.1. Invoking Text Directives"}, {"refs": [{"id": "ref-for-concept-range-end-node\u2460"}, {"id": "ref-for-concept-range-end-node\u2461"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['203b148b'] = {"dfnID": "203b148b", "url": "https://dom.spec.whatwg.org/#concept-range-end-offset", "dfnText": "end offset", "refSections": [{"refs": [{"id": "ref-for-concept-range-end-offset"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['6fba6744'] = {"dfnID": "6fba6744", "url": "https://dom.spec.whatwg.org/#concept-tree-following", "dfnText": "following", "refSections": [{"refs": [{"id": "ref-for-concept-tree-following"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['5d233601'] = {"dfnID": "5d233601", "url": "https://dom.spec.whatwg.org/#concept-documentfragment-host", "dfnText": "host", "refSections": [{"refs": [{"id": "ref-for-concept-documentfragment-host"}], "title": "3.6. Navigating to a Text Fragment"}], "external": true};
window.dfnpanelData['5e8d5f81'] = {"dfnID": "5e8d5f81", "url": "https://dom.spec.whatwg.org/#concept-node-length", "dfnText": "length", "refSections": [{"refs": [{"id": "ref-for-concept-node-length"}, {"id": "ref-for-concept-node-length\u2460"}, {"id": "ref-for-concept-node-length\u2461"}, {"id": "ref-for-concept-node-length\u2462"}, {"id": "ref-for-concept-node-length\u2463"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['d462b34f'] = {"dfnID": "d462b34f", "url": "https://dom.spec.whatwg.org/#boundary-point-node", "dfnText": "node", "refSections": [{"refs": [{"id": "ref-for-boundary-point-node"}, {"id": "ref-for-boundary-point-node\u2460"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['5216e1a0'] = {"dfnID": "5216e1a0", "url": "https://dom.spec.whatwg.org/#concept-node-document", "dfnText": "node document", "refSections": [{"refs": [{"id": "ref-for-concept-node-document"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['d729a9ff'] = {"dfnID": "d729a9ff", "url": "https://dom.spec.whatwg.org/#concept-tree-parent", "dfnText": "parent", "refSections": [{"refs": [{"id": "ref-for-concept-tree-parent"}], "title": "3.4.1. Invoking Text Directives"}, {"refs": [{"id": "ref-for-concept-tree-parent\u2460"}], "title": "3.6. Navigating to a Text Fragment"}, {"refs": [{"id": "ref-for-concept-tree-parent\u2461"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['5afeceea'] = {"dfnID": "5afeceea", "url": "https://dom.spec.whatwg.org/#parent-element", "dfnText": "parent element", "refSections": [{"refs": [{"id": "ref-for-parent-element"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['8044ee41'] = {"dfnID": "8044ee41", "url": "https://dom.spec.whatwg.org/#concept-range", "dfnText": "range", "refSections": [{"refs": [{"id": "ref-for-concept-range"}, {"id": "ref-for-concept-range\u2460"}, {"id": "ref-for-concept-range\u2461"}, {"id": "ref-for-concept-range\u2462"}, {"id": "ref-for-concept-range\u2463"}, {"id": "ref-for-concept-range\u2464"}, {"id": "ref-for-concept-range\u2465"}, {"id": "ref-for-concept-range\u2466"}, {"id": "ref-for-concept-range\u2467"}], "title": "3.4.1. Invoking Text Directives"}, {"refs": [{"id": "ref-for-concept-range\u2468"}], "title": "3.6. Navigating to a Text Fragment"}, {"refs": [{"id": "ref-for-concept-range\u2460\u24ea"}, {"id": "ref-for-concept-range\u2460\u2460"}, {"id": "ref-for-concept-range\u2460\u2461"}, {"id": "ref-for-concept-range\u2460\u2462"}, {"id": "ref-for-concept-range\u2460\u2463"}, {"id": "ref-for-concept-range\u2460\u2464"}, {"id": "ref-for-concept-range\u2460\u2465"}, {"id": "ref-for-concept-range\u2460\u2466"}, {"id": "ref-for-concept-range\u2460\u2467"}, {"id": "ref-for-concept-range\u2460\u2468"}, {"id": "ref-for-concept-range\u2461\u24ea"}, {"id": "ref-for-concept-range\u2461\u2460"}, {"id": "ref-for-concept-range\u2461\u2461"}, {"id": "ref-for-concept-range\u2461\u2462"}, {"id": "ref-for-concept-range\u2461\u2463"}, {"id": "ref-for-concept-range\u2461\u2464"}, {"id": "ref-for-concept-range\u2461\u2465"}, {"id": "ref-for-concept-range\u2461\u2466"}, {"id": "ref-for-concept-range\u2461\u2467"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['3fcc582f'] = {"dfnID": "3fcc582f", "url": "https://dom.spec.whatwg.org/#concept-shadow-root", "dfnText": "shadow root", "refSections": [{"refs": [{"id": "ref-for-concept-shadow-root"}], "title": "3.6. Navigating to a Text Fragment"}], "external": true};
window.dfnpanelData['8f378588'] = {"dfnID": "8f378588", "url": "https://dom.spec.whatwg.org/#concept-shadow-including-ancestor", "dfnText": "shadow-including ancestor", "refSections": [{"refs": [{"id": "ref-for-concept-shadow-including-ancestor"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['fd32e3c9'] = {"dfnID": "fd32e3c9", "url": "https://dom.spec.whatwg.org/#concept-shadow-including-descendant", "dfnText": "shadow-including descendant", "refSections": [{"refs": [{"id": "ref-for-concept-shadow-including-descendant"}, {"id": "ref-for-concept-shadow-including-descendant\u2460"}, {"id": "ref-for-concept-shadow-including-descendant\u2461"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['3d6a3d36'] = {"dfnID": "3d6a3d36", "url": "https://dom.spec.whatwg.org/#concept-shadow-including-inclusive-ancestor", "dfnText": "shadow-including inclusive ancestor", "refSections": [{"refs": [{"id": "ref-for-concept-shadow-including-inclusive-ancestor"}], "title": "3.6. Navigating to a Text Fragment"}], "external": true};
window.dfnpanelData['fefa5851'] = {"dfnID": "fefa5851", "url": "https://dom.spec.whatwg.org/#concept-shadow-including-tree-order", "dfnText": "shadow-including tree order", "refSections": [{"refs": [{"id": "ref-for-concept-shadow-including-tree-order"}, {"id": "ref-for-concept-shadow-including-tree-order\u2460"}, {"id": "ref-for-concept-shadow-including-tree-order\u2461"}, {"id": "ref-for-concept-shadow-including-tree-order\u2462"}, {"id": "ref-for-concept-shadow-including-tree-order\u2463"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['936c50ab'] = {"dfnID": "936c50ab", "url": "https://dom.spec.whatwg.org/#concept-range-start", "dfnText": "start", "refSections": [{"refs": [{"id": "ref-for-concept-range-start"}, {"id": "ref-for-concept-range-start\u2460"}, {"id": "ref-for-concept-range-start\u2461"}, {"id": "ref-for-concept-range-start\u2462"}, {"id": "ref-for-concept-range-start\u2463"}, {"id": "ref-for-concept-range-start\u2464"}, {"id": "ref-for-concept-range-start\u2465"}, {"id": "ref-for-concept-range-start\u2466"}, {"id": "ref-for-concept-range-start\u2467"}, {"id": "ref-for-concept-range-start\u2468"}, {"id": "ref-for-concept-range-start\u2460\u24ea"}, {"id": "ref-for-concept-range-start\u2460\u2460"}, {"id": "ref-for-concept-range-start\u2460\u2461"}, {"id": "ref-for-concept-range-start\u2460\u2462"}, {"id": "ref-for-concept-range-start\u2460\u2463"}, {"id": "ref-for-concept-range-start\u2460\u2464"}, {"id": "ref-for-concept-range-start\u2460\u2465"}, {"id": "ref-for-concept-range-start\u2460\u2466"}, {"id": "ref-for-concept-range-start\u2460\u2467"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['6c88f67e'] = {"dfnID": "6c88f67e", "url": "https://dom.spec.whatwg.org/#concept-range-start-node", "dfnText": "start node", "refSections": [{"refs": [{"id": "ref-for-concept-range-start-node"}], "title": "3.4.1. Invoking Text Directives"}, {"refs": [{"id": "ref-for-concept-range-start-node\u2460"}, {"id": "ref-for-concept-range-start-node\u2461"}, {"id": "ref-for-concept-range-start-node\u2462"}, {"id": "ref-for-concept-range-start-node\u2463"}, {"id": "ref-for-concept-range-start-node\u2464"}, {"id": "ref-for-concept-range-start-node\u2465"}, {"id": "ref-for-concept-range-start-node\u2466"}, {"id": "ref-for-concept-range-start-node\u2467"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['683b1507'] = {"dfnID": "683b1507", "url": "https://dom.spec.whatwg.org/#concept-range-start-offset", "dfnText": "start offset", "refSections": [{"refs": [{"id": "ref-for-concept-range-start-offset"}, {"id": "ref-for-concept-range-start-offset\u2460"}, {"id": "ref-for-concept-range-start-offset\u2461"}, {"id": "ref-for-concept-range-start-offset\u2462"}, {"id": "ref-for-concept-range-start-offset\u2463"}, {"id": "ref-for-concept-range-start-offset\u2464"}, {"id": "ref-for-concept-range-start-offset\u2465"}, {"id": "ref-for-concept-range-start-offset\u2466"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['c9f15d91'] = {"dfnID": "c9f15d91", "url": "https://dom.spec.whatwg.org/#concept-cd-substring", "dfnText": "substring data", "refSections": [{"refs": [{"id": "ref-for-concept-cd-substring"}, {"id": "ref-for-concept-cd-substring\u2460"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['347e8fe9'] = {"dfnID": "347e8fe9", "url": "https://dom.spec.whatwg.org/#concept-document-url", "dfnText": "url", "refSections": [{"refs": [{"id": "ref-for-concept-document-url"}], "title": "3.3.1. Extracting the fragment directive"}], "external": true};
window.dfnpanelData['55213b5b'] = {"dfnID": "55213b5b", "url": "https://fetch.spec.whatwg.org/#concept-request", "dfnText": "request", "refSections": [{"refs": [{"id": "ref-for-concept-request"}, {"id": "ref-for-concept-request\u2460"}, {"id": "ref-for-concept-request\u2461"}, {"id": "ref-for-concept-request\u2462"}], "title": "3.5.4. Restricting the Text Fragment"}], "external": true};
window.dfnpanelData['fe2a6718'] = {"dfnID": "fe2a6718", "url": "https://html.spec.whatwg.org/multipage/media.html#htmlaudioelement", "dfnText": "HTMLAudioElement", "refSections": [{"refs": [{"id": "ref-for-htmlaudioelement"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['10e25f42'] = {"dfnID": "10e25f42", "url": "https://html.spec.whatwg.org/multipage/iframe-embed-object.html#htmliframeelement", "dfnText": "HTMLIFrameElement", "refSections": [{"refs": [{"id": "ref-for-htmliframeelement"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['c5891539'] = {"dfnID": "c5891539", "url": "https://html.spec.whatwg.org/multipage/embedded-content.html#htmlimageelement", "dfnText": "HTMLImageElement", "refSections": [{"refs": [{"id": "ref-for-htmlimageelement"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['cc59b66b'] = {"dfnID": "cc59b66b", "url": "https://html.spec.whatwg.org/multipage/form-elements.html#htmlmeterelement", "dfnText": "HTMLMeterElement", "refSections": [{"refs": [{"id": "ref-for-htmlmeterelement"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['59ce5887'] = {"dfnID": "59ce5887", "url": "https://html.spec.whatwg.org/multipage/iframe-embed-object.html#htmlobjectelement", "dfnText": "HTMLObjectElement", "refSections": [{"refs": [{"id": "ref-for-htmlobjectelement"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['fcadc50c'] = {"dfnID": "fcadc50c", "url": "https://html.spec.whatwg.org/multipage/form-elements.html#htmlprogresselement", "dfnText": "HTMLProgressElement", "refSections": [{"refs": [{"id": "ref-for-htmlprogresselement"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['ec4838d8'] = {"dfnID": "ec4838d8", "url": "https://html.spec.whatwg.org/multipage/scripting.html#htmlscriptelement", "dfnText": "HTMLScriptElement", "refSections": [{"refs": [{"id": "ref-for-htmlscriptelement"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['aa8746c3'] = {"dfnID": "aa8746c3", "url": "https://html.spec.whatwg.org/multipage/semantics.html#htmlstyleelement", "dfnText": "HTMLStyleElement", "refSections": [{"refs": [{"id": "ref-for-htmlstyleelement"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['f57f330b'] = {"dfnID": "f57f330b", "url": "https://html.spec.whatwg.org/multipage/media.html#htmlvideoelement", "dfnText": "HTMLVideoElement", "refSections": [{"refs": [{"id": "ref-for-htmlvideoelement"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['78492a07'] = {"dfnID": "78492a07", "url": "https://html.spec.whatwg.org/multipage/nav-history-apis.html#hashchangeevent", "dfnText": "HashChangeEvent", "refSections": [{"refs": [{"id": "ref-for-hashchangeevent"}], "title": "3.3.1. Extracting the fragment directive"}], "external": true};
window.dfnpanelData['cc549724'] = {"dfnID": "cc549724", "url": "https://html.spec.whatwg.org/multipage/nav-history-apis.html#location", "dfnText": "Location", "refSections": [{"refs": [{"id": "ref-for-location"}], "title": "3.3.1. Extracting the fragment directive"}], "external": true};
window.dfnpanelData['35972864'] = {"dfnID": "35972864", "url": "https://html.spec.whatwg.org/multipage/document-sequences.html#nav-document", "dfnText": "active document", "refSections": [{"refs": [{"id": "ref-for-nav-document"}], "title": "3.3.1. Extracting the fragment directive"}, {"refs": [{"id": "ref-for-nav-document\u2460"}, {"id": "ref-for-nav-document\u2461"}], "title": "3.5.4. Restricting the Text Fragment"}], "external": true};
window.dfnpanelData['f8434dee'] = {"dfnID": "f8434dee", "url": "https://html.spec.whatwg.org/multipage/rendering.html#being-rendered", "dfnText": "being rendered", "refSections": [{"refs": [{"id": "ref-for-being-rendered"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['3b2ff63e'] = {"dfnID": "3b2ff63e", "url": "https://html.spec.whatwg.org/multipage/document-sequences.html#concept-document-bc", "dfnText": "browsing context", "refSections": [{"refs": [{"id": "ref-for-concept-document-bc"}], "title": "3.5.4. Restricting the Text Fragment"}], "external": true};
window.dfnpanelData['b0b49d3c'] = {"dfnID": "b0b49d3c", "url": "https://html.spec.whatwg.org/multipage/document-sequences.html#browsing-context-set", "dfnText": "browsing context set", "refSections": [{"refs": [{"id": "ref-for-browsing-context-set"}], "title": "3.5.4. Restricting the Text Fragment"}], "external": true};
window.dfnpanelData['d4dbbbf0'] = {"dfnID": "d4dbbbf0", "url": "https://html.spec.whatwg.org/multipage/dom.html#language", "dfnText": "language", "refSections": [{"refs": [{"id": "ref-for-language"}, {"id": "ref-for-language\u2460"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['b07164ad'] = {"dfnID": "b07164ad", "url": "https://html.spec.whatwg.org/multipage/form-elements.html#attr-select-multiple", "dfnText": "multiple", "refSections": [{"refs": [{"id": "ref-for-attr-select-multiple"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['2594e562'] = {"dfnID": "2594e562", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#navigate", "dfnText": "navigate", "refSections": [{"refs": [{"id": "ref-for-navigate"}], "title": "3.3.1. Extracting the fragment directive"}], "external": true};
window.dfnpanelData['8b87b428'] = {"dfnID": "8b87b428", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#restore-persisted-state", "dfnText": "restore persisted state", "refSections": [{"refs": [{"id": "ref-for-restore-persisted-state"}], "title": "3.5.5. Restricting Scroll on Load"}, {"refs": [{"id": "ref-for-restore-persisted-state\u2460"}], "title": "3.8. Document Policy Integration"}], "external": true};
window.dfnpanelData['7393da89'] = {"dfnID": "7393da89", "url": "https://html.spec.whatwg.org/multipage/browsers.html#same-origin", "dfnText": "same origin", "refSections": [{"refs": [{"id": "ref-for-same-origin"}], "title": "3.5.4. Restricting the Text Fragment"}], "external": true};
window.dfnpanelData['3f2e859c'] = {"dfnID": "3f2e859c", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#scroll-to-the-fragment-identifier", "dfnText": "scroll to the fragment", "refSections": [{"refs": [{"id": "ref-for-scroll-to-the-fragment-identifier"}, {"id": "ref-for-scroll-to-the-fragment-identifier\u2460"}], "title": "3.4.1. Invoking Text Directives"}, {"refs": [{"id": "ref-for-scroll-to-the-fragment-identifier\u2461"}], "title": "3.5.4. Restricting the Text Fragment"}, {"refs": [{"id": "ref-for-scroll-to-the-fragment-identifier\u2462"}], "title": "3.8. Document Policy Integration"}], "external": true};
window.dfnpanelData['85188fb3'] = {"dfnID": "85188fb3", "url": "https://html.spec.whatwg.org/multipage/form-elements.html#the-select-element", "dfnText": "select", "refSections": [{"refs": [{"id": "ref-for-the-select-element"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['c3ae9e6a'] = {"dfnID": "c3ae9e6a", "url": "https://html.spec.whatwg.org/multipage/parsing.html#serializes-as-void", "dfnText": "serializes as void", "refSections": [{"refs": [{"id": "ref-for-serializes-as-void"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['8a051c9f'] = {"dfnID": "8a051c9f", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#try-to-scroll-to-the-fragment", "dfnText": "try to scroll to the fragment", "refSections": [{"refs": [{"id": "44bd3acf0"}], "title": "3.4.1. Invoking Text Directives"}, {"refs": [{"id": "ref-for-try-to-scroll-to-the-fragment"}], "title": "3.5.4. Restricting the Text Fragment"}, {"refs": [{"id": "ref-for-try-to-scroll-to-the-fragment\u2460"}], "title": "3.7. Indicating The Text Match"}], "external": true};
window.dfnpanelData['5c1d019b'] = {"dfnID": "5c1d019b", "url": "https://html.spec.whatwg.org/multipage/browsing-the-web.html#update-document-for-history-step-application", "dfnText": "update document for history step application", "refSections": [{"refs": [{"id": "fb71d7890"}], "title": "3.3.2. Applying directives to a document"}, {"refs": [{"id": "ref-for-update-document-for-history-step-application"}], "title": "3.5.5. Restricting Scroll on Load"}], "external": true};
window.dfnpanelData['53275e46'] = {"dfnID": "53275e46", "url": "https://infra.spec.whatwg.org/#list-append", "dfnText": "append", "refSections": [{"refs": [{"id": "ref-for-list-append"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['2d5a2765'] = {"dfnID": "2d5a2765", "url": "https://infra.spec.whatwg.org/#ascii-string", "dfnText": "ascii string", "refSections": [{"refs": [{"id": "ref-for-ascii-string"}], "title": "3.3.1. Extracting the fragment directive"}, {"refs": [{"id": "ref-for-ascii-string\u2460"}], "title": "3.3.4. Fragment directive grammar"}, {"refs": [{"id": "ref-for-ascii-string\u2461"}], "title": "3.4. Text Directives"}, {"refs": [{"id": "ref-for-ascii-string\u2462"}, {"id": "ref-for-ascii-string\u2463"}, {"id": "ref-for-ascii-string\u2464"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['77b4c09a'] = {"dfnID": "77b4c09a", "url": "https://infra.spec.whatwg.org/#assert", "dfnText": "assert", "refSections": [{"refs": [{"id": "ref-for-assert"}], "title": "3.4. Text Directives"}, {"refs": [{"id": "ref-for-assert\u2460"}, {"id": "ref-for-assert\u2461"}, {"id": "ref-for-assert\u2462"}, {"id": "ref-for-assert\u2463"}, {"id": "ref-for-assert\u2464"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['7b0d918d'] = {"dfnID": "7b0d918d", "url": "https://infra.spec.whatwg.org/#iteration-break", "dfnText": "break", "refSections": [{"refs": [{"id": "ref-for-iteration-break"}, {"id": "ref-for-iteration-break\u2460"}, {"id": "ref-for-iteration-break\u2461"}, {"id": "ref-for-iteration-break\u2462"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['915aff5e'] = {"dfnID": "915aff5e", "url": "https://infra.spec.whatwg.org/#code-point", "dfnText": "code point", "refSections": [{"refs": [{"id": "ref-for-code-point"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['4ef39030'] = {"dfnID": "4ef39030", "url": "https://infra.spec.whatwg.org/#string-code-point-length", "dfnText": "code point length", "refSections": [{"refs": [{"id": "ref-for-string-code-point-length"}], "title": "3.3.1. Extracting the fragment directive"}], "external": true};
window.dfnpanelData['cfd05055'] = {"dfnID": "cfd05055", "url": "https://infra.spec.whatwg.org/#code-point-substring-by-positions", "dfnText": "code point substring by positions", "refSections": [{"refs": [{"id": "ref-for-code-point-substring-by-positions"}], "title": "3.3.1. Extracting the fragment directive"}], "external": true};
window.dfnpanelData['b8906bbb'] = {"dfnID": "b8906bbb", "url": "https://infra.spec.whatwg.org/#code-point-substring-to-the-end-of-the-string", "dfnText": "code point substring to the end of the string", "refSections": [{"refs": [{"id": "ref-for-code-point-substring-to-the-end-of-the-string"}], "title": "3.3.1. Extracting the fragment directive"}], "external": true};
window.dfnpanelData['4a3bf5fb'] = {"dfnID": "4a3bf5fb", "url": "https://infra.spec.whatwg.org/#string-concatenate", "dfnText": "concatenate", "refSections": [{"refs": [{"id": "ref-for-string-concatenate"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['f937b7b6'] = {"dfnID": "f937b7b6", "url": "https://infra.spec.whatwg.org/#iteration-continue", "dfnText": "continue", "refSections": [{"refs": [{"id": "ref-for-iteration-continue"}, {"id": "ref-for-iteration-continue\u2460"}, {"id": "ref-for-iteration-continue\u2461"}, {"id": "ref-for-iteration-continue\u2462"}, {"id": "ref-for-iteration-continue\u2463"}, {"id": "ref-for-iteration-continue\u2464"}, {"id": "ref-for-iteration-continue\u2465"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['f052b1ea'] = {"dfnID": "f052b1ea", "url": "https://infra.spec.whatwg.org/#html-namespace", "dfnText": "html namespace", "refSections": [{"refs": [{"id": "ref-for-html-namespace"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['860300d4'] = {"dfnID": "860300d4", "url": "https://infra.spec.whatwg.org/#implementation-defined", "dfnText": "implementation-defined", "refSections": [{"refs": [{"id": "ref-for-implementation-defined"}], "title": "3.4.1. Invoking Text Directives"}], "external": true};
window.dfnpanelData['0fa357c3'] = {"dfnID": "0fa357c3", "url": "https://infra.spec.whatwg.org/#string-length", "dfnText": "length", "refSections": [{"refs": [{"id": "ref-for-string-length"}, {"id": "ref-for-string-length\u2460"}, {"id": "ref-for-string-length\u2461"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['649608b9'] = {"dfnID": "649608b9", "url": "https://infra.spec.whatwg.org/#list", "dfnText": "list", "refSections": [{"refs": [{"id": "ref-for-list"}], "title": "3.4. Text Directives"}, {"refs": [{"id": "ref-for-list\u2460"}], "title": "3.4.1. Invoking Text Directives"}, {"refs": [{"id": "ref-for-list\u2461"}, {"id": "ref-for-list\u2462"}, {"id": "ref-for-list\u2463"}, {"id": "ref-for-list\u2464"}, {"id": "ref-for-list\u2465"}, {"id": "ref-for-list\u2466"}, {"id": "ref-for-list\u2467"}, {"id": "ref-for-list\u2468"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['75bee4d5'] = {"dfnID": "75bee4d5", "url": "https://infra.spec.whatwg.org/#string-position-variable", "dfnText": "position variable", "refSections": [{"refs": [{"id": "ref-for-string-position-variable"}], "title": "3.3.1. Extracting the fragment directive"}], "external": true};
window.dfnpanelData['99c988d6'] = {"dfnID": "99c988d6", "url": "https://infra.spec.whatwg.org/#list-remove", "dfnText": "remove", "refSections": [{"refs": [{"id": "ref-for-list-remove"}, {"id": "ref-for-list-remove\u2460"}], "title": "3.4. Text Directives"}], "external": true};
window.dfnpanelData['0204d188'] = {"dfnID": "0204d188", "url": "https://infra.spec.whatwg.org/#list-size", "dfnText": "size", "refSections": [{"refs": [{"id": "ref-for-list-size"}, {"id": "ref-for-list-size\u2460"}], "title": "3.4. Text Directives"}], "external": true};
window.dfnpanelData['0437147c'] = {"dfnID": "0437147c", "url": "https://infra.spec.whatwg.org/#split-on-commas", "dfnText": "split on commas", "refSections": [{"refs": [{"id": "ref-for-split-on-commas"}], "title": "3.4. Text Directives"}], "external": true};
window.dfnpanelData['7a3dbdb1'] = {"dfnID": "7a3dbdb1", "url": "https://infra.spec.whatwg.org/#strictly-split", "dfnText": "strictly split a string", "refSections": [{"refs": [{"id": "ref-for-strictly-split"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": true};
window.dfnpanelData['0698d556'] = {"dfnID": "0698d556", "url": "https://infra.spec.whatwg.org/#string", "dfnText": "string", "refSections": [{"refs": [{"id": "ref-for-string"}], "title": "3.6.1. Finding Ranges in a Document"}, {"refs": [{"id": "ref-for-string\u2460"}, {"id": "ref-for-string\u2461"}, {"id": "ref-for-string\u2462"}], "title": "3.6.2. Word Boundaries"}], "external": true};
window.dfnpanelData['984221ca'] = {"dfnID": "984221ca", "url": "https://infra.spec.whatwg.org/#struct", "dfnText": "struct", "refSections": [{"refs": [{"id": "ref-for-struct"}], "title": "3.4. Text Directives"}], "external": true};
window.dfnpanelData['ed948033'] = {"dfnID": "ed948033", "url": "https://url.spec.whatwg.org/#concept-url-fragment", "dfnText": "fragment", "refSections": [{"refs": [{"id": "ref-for-concept-url-fragment"}], "title": "3.3. The Fragment Directive"}, {"refs": [{"id": "ref-for-concept-url-fragment\u2460"}, {"id": "ref-for-concept-url-fragment\u2461"}], "title": "3.3.1. Extracting the fragment directive"}], "external": true};
window.dfnpanelData['8f69ce41'] = {"dfnID": "8f69ce41", "url": "https://url.spec.whatwg.org/#string-percent-decode", "dfnText": "percent-decode", "refSections": [{"refs": [{"id": "ref-for-string-percent-decode"}, {"id": "ref-for-string-percent-decode\u2460"}, {"id": "ref-for-string-percent-decode\u2461"}, {"id": "ref-for-string-percent-decode\u2462"}], "title": "3.4. Text Directives"}], "external": true};
window.dfnpanelData['dcffbccd'] = {"dfnID": "dcffbccd", "url": "https://url.spec.whatwg.org/#concept-url", "dfnText": "url", "refSections": [{"refs": [{"id": "ref-for-concept-url"}, {"id": "ref-for-concept-url\u2460"}, {"id": "ref-for-concept-url\u2461"}], "title": "3.3.1. Extracting the fragment directive"}], "external": true};
window.dfnpanelData['4bb788fe'] = {"dfnID": "4bb788fe", "url": "https://url.spec.whatwg.org/#url-code-points", "dfnText": "url code point", "refSections": [{"refs": [{"id": "ref-for-url-code-points"}, {"id": "ref-for-url-code-points\u2460"}], "title": "3.3.4. Fragment directive grammar"}], "external": true};
window.dfnpanelData['889e932f'] = {"dfnID": "889e932f", "url": "https://webidl.spec.whatwg.org/#Exposed", "dfnText": "Exposed", "refSections": [{"refs": [{"id": "ref-for-Exposed"}], "title": "3.9. Feature Detectability"}], "external": true};
window.dfnpanelData['a5c91173'] = {"dfnID": "a5c91173", "url": "https://webidl.spec.whatwg.org/#SameObject", "dfnText": "SameObject", "refSections": [{"refs": [{"id": "ref-for-SameObject"}], "title": "3.9. Feature Detectability"}], "external": true};
window.dfnpanelData['fragment-directive'] = {"dfnID": "fragment-directive", "url": "#fragment-directive", "dfnText": "fragment directive", "refSections": [{"refs": [{"id": "ref-for-fragment-directive"}], "title": "3.2. Syntax"}, {"refs": [{"id": "ref-for-fragment-directive\u2460"}, {"id": "ref-for-fragment-directive\u2461"}], "title": "3.3. The Fragment Directive"}, {"refs": [{"id": "ref-for-fragment-directive\u2462"}, {"id": "ref-for-fragment-directive\u2463"}, {"id": "ref-for-fragment-directive\u2464"}, {"id": "ref-for-fragment-directive\u2465"}], "title": "3.3.1. Extracting the fragment directive"}, {"refs": [{"id": "ref-for-fragment-directive\u2466"}], "title": "3.3.2. Applying directives to a document"}, {"refs": [{"id": "ref-for-fragment-directive\u2467"}, {"id": "ref-for-fragment-directive\u2468"}, {"id": "ref-for-fragment-directive\u2460\u24ea"}], "title": "3.7.1. URLs in UA features"}, {"refs": [{"id": "ref-for-fragment-directive\u2460\u2460"}], "title": "3.7.1.1. Location Bar"}, {"refs": [{"id": "ref-for-fragment-directive\u2460\u2461"}, {"id": "ref-for-fragment-directive\u2460\u2462"}], "title": "3.7.1.2. Bookmarks"}, {"refs": [{"id": "ref-for-fragment-directive\u2460\u2463"}], "title": "3.7.1.3. Sharing"}], "external": false};
window.dfnpanelData['fragment-directive-delimiter'] = {"dfnID": "fragment-directive-delimiter", "url": "#fragment-directive-delimiter", "dfnText": "fragment directive delimiter", "refSections": [{"refs": [{"id": "ref-for-fragment-directive-delimiter"}], "title": "3.3. The Fragment Directive"}, {"refs": [{"id": "ref-for-fragment-directive-delimiter\u2460"}, {"id": "ref-for-fragment-directive-delimiter\u2461"}, {"id": "ref-for-fragment-directive-delimiter\u2462"}, {"id": "ref-for-fragment-directive-delimiter\u2463"}], "title": "3.3.1. Extracting the fragment directive"}], "external": false};
window.dfnpanelData['directives'] = {"dfnID": "directives", "url": "#directives", "dfnText": "directives", "refSections": [{"refs": [{"id": "ref-for-directives"}], "title": "3.4. Text Directives"}], "external": false};
window.dfnpanelData['directive-state'] = {"dfnID": "directive-state", "url": "#directive-state", "dfnText": "directive state", "refSections": [{"refs": [{"id": "ref-for-directive-state"}, {"id": "ref-for-directive-state\u2460"}, {"id": "ref-for-directive-state\u2461"}, {"id": "ref-for-directive-state\u2462"}, {"id": "ref-for-directive-state\u2463"}, {"id": "ref-for-directive-state\u2464"}, {"id": "ref-for-directive-state\u2465"}, {"id": "ref-for-directive-state\u2466"}], "title": "3.3.1. Extracting the fragment directive"}], "external": false};
window.dfnpanelData['directive-state-value'] = {"dfnID": "directive-state-value", "url": "#directive-state-value", "dfnText": "value", "refSections": [{"refs": [{"id": "ref-for-directive-state-value"}, {"id": "ref-for-directive-state-value\u2460"}, {"id": "ref-for-directive-state-value\u2461"}, {"id": "ref-for-directive-state-value\u2462"}, {"id": "ref-for-directive-state-value\u2463"}], "title": "3.3.1. Extracting the fragment directive"}, {"refs": [{"id": "ref-for-directive-state-value\u2464"}], "title": "3.3.2. Applying directives to a document"}], "external": false};
window.dfnpanelData['she-directive-state'] = {"dfnID": "she-directive-state", "url": "#she-directive-state", "dfnText": "directive state", "refSections": [{"refs": [{"id": "ref-for-she-directive-state"}, {"id": "ref-for-she-directive-state\u2460"}, {"id": "ref-for-she-directive-state\u2461"}, {"id": "ref-for-she-directive-state\u2462"}, {"id": "ref-for-she-directive-state\u2463"}, {"id": "ref-for-she-directive-state\u2464"}, {"id": "ref-for-she-directive-state\u2465"}, {"id": "ref-for-she-directive-state\u2466"}], "title": "3.3.1. Extracting the fragment directive"}, {"refs": [{"id": "ref-for-she-directive-state\u2467"}, {"id": "ref-for-she-directive-state\u2468"}, {"id": "ref-for-she-directive-state\u2460\u24ea"}, {"id": "ref-for-she-directive-state\u2460\u2460"}], "title": "3.3.2. Applying directives to a document"}], "external": false};
window.dfnpanelData['remove-the-fragment-directive'] = {"dfnID": "remove-the-fragment-directive", "url": "#remove-the-fragment-directive", "dfnText": "remove the fragment directive", "refSections": [{"refs": [{"id": "ref-for-remove-the-fragment-directive"}, {"id": "ref-for-remove-the-fragment-directive\u2460"}, {"id": "ref-for-remove-the-fragment-directive\u2461"}, {"id": "ref-for-remove-the-fragment-directive\u2462"}], "title": "3.3.1. Extracting the fragment directive"}], "external": false};
window.dfnpanelData['document-uninvoked-directives'] = {"dfnID": "document-uninvoked-directives", "url": "#document-uninvoked-directives", "dfnText": "uninvoked directives", "refSections": [{"refs": [{"id": "ref-for-document-uninvoked-directives"}], "title": "3.3.2. Applying directives to a document"}, {"refs": [{"id": "ref-for-document-uninvoked-directives\u2460"}, {"id": "ref-for-document-uninvoked-directives\u2461"}, {"id": "ref-for-document-uninvoked-directives\u2462"}, {"id": "ref-for-document-uninvoked-directives\u2463"}, {"id": "ref-for-document-uninvoked-directives\u2464"}, {"id": "ref-for-document-uninvoked-directives\u2465"}, {"id": "ref-for-document-uninvoked-directives\u2466"}, {"id": "ref-for-document-uninvoked-directives\u2467"}, {"id": "ref-for-document-uninvoked-directives\u2468"}, {"id": "ref-for-document-uninvoked-directives\u2460\u24ea"}], "title": "3.4.1. Invoking Text Directives"}, {"refs": [{"id": "ref-for-document-uninvoked-directives\u2460\u2460"}], "title": "3.5.4. Restricting the Text Fragment"}], "external": false};
window.dfnpanelData['valid-fragment-directive'] = {"dfnID": "valid-fragment-directive", "url": "#valid-fragment-directive", "dfnText": "valid fragment directive", "refSections": [{"refs": [{"id": "ref-for-valid-fragment-directive"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['fragmentdirectiveproduction'] = {"dfnID": "fragmentdirectiveproduction", "url": "#fragmentdirectiveproduction", "dfnText": "FragmentDirective", "refSections": [{"refs": [{"id": "ref-for-fragmentdirectiveproduction"}, {"id": "ref-for-fragmentdirectiveproduction\u2460"}], "title": "3.3.4. Fragment directive grammar"}], "external": false};
window.dfnpanelData['unknowndirective'] = {"dfnID": "unknowndirective", "url": "#unknowndirective", "dfnText": "UnknownDirective", "refSections": [{"refs": [{"id": "ref-for-unknowndirective"}], "title": "3.3.4. Fragment directive grammar"}], "external": false};
window.dfnpanelData['characterstring'] = {"dfnID": "characterstring", "url": "#characterstring", "dfnText": "CharacterString", "refSections": [{"refs": [{"id": "ref-for-characterstring"}], "title": "3.3.4. Fragment directive grammar"}], "external": false};
window.dfnpanelData['explicitchar'] = {"dfnID": "explicitchar", "url": "#explicitchar", "dfnText": "ExplicitChar", "refSections": [{"refs": [{"id": "ref-for-explicitchar"}, {"id": "ref-for-explicitchar\u2460"}], "title": "3.3.4. Fragment directive grammar"}], "external": false};
window.dfnpanelData['textdirective'] = {"dfnID": "textdirective", "url": "#textdirective", "dfnText": "TextDirective", "refSections": [{"refs": [{"id": "ref-for-textdirective"}, {"id": "ref-for-textdirective\u2460"}], "title": "3.3.4. Fragment directive grammar"}, {"refs": [{"id": "ref-for-textdirective\u2461"}], "title": "3.4. Text Directives"}, {"refs": [{"id": "ref-for-textdirective\u2462"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['textdirectiveparameters'] = {"dfnID": "textdirectiveparameters", "url": "#textdirectiveparameters", "dfnText": "TextDirectiveParameters", "refSections": [{"refs": [{"id": "ref-for-textdirectiveparameters"}], "title": "3.3.4. Fragment directive grammar"}], "external": false};
window.dfnpanelData['textdirectiveprefix'] = {"dfnID": "textdirectiveprefix", "url": "#textdirectiveprefix", "dfnText": "TextDirectivePrefix", "refSections": [{"refs": [{"id": "ref-for-textdirectiveprefix"}], "title": "3.3.4. Fragment directive grammar"}], "external": false};
window.dfnpanelData['textdirectivesuffix'] = {"dfnID": "textdirectivesuffix", "url": "#textdirectivesuffix", "dfnText": "TextDirectiveSuffix", "refSections": [{"refs": [{"id": "ref-for-textdirectivesuffix"}], "title": "3.3.4. Fragment directive grammar"}], "external": false};
window.dfnpanelData['textdirectivestring'] = {"dfnID": "textdirectivestring", "url": "#textdirectivestring", "dfnText": "TextDirectiveString", "refSections": [{"refs": [{"id": "ref-for-textdirectivestring"}, {"id": "ref-for-textdirectivestring\u2460"}, {"id": "ref-for-textdirectivestring\u2461"}, {"id": "ref-for-textdirectivestring\u2462"}], "title": "3.3.4. Fragment directive grammar"}], "external": false};
window.dfnpanelData['textdirectiveexplicitchar'] = {"dfnID": "textdirectiveexplicitchar", "url": "#textdirectiveexplicitchar", "dfnText": "TextDirectiveExplicitChar", "refSections": [{"refs": [{"id": "ref-for-textdirectiveexplicitchar"}, {"id": "ref-for-textdirectiveexplicitchar\u2460"}], "title": "3.3.4. Fragment directive grammar"}], "external": false};
window.dfnpanelData['percentencodedbyte'] = {"dfnID": "percentencodedbyte", "url": "#percentencodedbyte", "dfnText": "PercentEncodedByte", "refSections": [{"refs": [{"id": "ref-for-percentencodedbyte"}, {"id": "ref-for-percentencodedbyte\u2460"}], "title": "3.3.4. Fragment directive grammar"}], "external": false};
window.dfnpanelData['text-directive'] = {"dfnID": "text-directive", "url": "#text-directive", "dfnText": "text directive", "refSections": [{"refs": [{"id": "ref-for-text-directive"}], "title": "3.2. Syntax"}, {"refs": [{"id": "ref-for-text-directive\u2460"}, {"id": "ref-for-text-directive\u2461"}], "title": "3.4. Text Directives"}, {"refs": [{"id": "ref-for-text-directive\u2462"}], "title": "3.4.1. Invoking Text Directives"}, {"refs": [{"id": "ref-for-text-directive\u2463"}, {"id": "ref-for-text-directive\u2464"}], "title": "3.5.1. Motivation"}, {"refs": [{"id": "ref-for-text-directive\u2465"}], "title": "3.5.3. Search Timing"}, {"refs": [{"id": "ref-for-text-directive\u2466"}], "title": "3.6. Navigating to a Text Fragment"}, {"refs": [{"id": "ref-for-text-directive\u2467"}], "title": "3.6.1. Finding Ranges in a Document"}, {"refs": [{"id": "ref-for-text-directive\u2468"}], "title": "4. Generating Text Fragment Directives"}, {"refs": [{"id": "ref-for-text-directive\u2460\u24ea"}, {"id": "ref-for-text-directive\u2460\u2460"}, {"id": "ref-for-text-directive\u2460\u2461"}], "title": "4.2. Use Context Only When Necessary"}, {"refs": [{"id": "ref-for-text-directive\u2460\u2462"}, {"id": "ref-for-text-directive\u2460\u2463"}], "title": "4.3. Determine If Fragment Id Is Needed"}], "external": false};
window.dfnpanelData['text-directive-start'] = {"dfnID": "text-directive-start", "url": "#text-directive-start", "dfnText": "start", "refSections": [{"refs": [{"id": "ref-for-text-directive-start"}, {"id": "ref-for-text-directive-start\u2460"}], "title": "3.4. Text Directives"}, {"refs": [{"id": "ref-for-text-directive-start\u2461"}, {"id": "ref-for-text-directive-start\u2462"}, {"id": "ref-for-text-directive-start\u2463"}, {"id": "ref-for-text-directive-start\u2464"}, {"id": "ref-for-text-directive-start\u2465"}, {"id": "ref-for-text-directive-start\u2466"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['text-directive-end'] = {"dfnID": "text-directive-end", "url": "#text-directive-end", "dfnText": "end", "refSections": [{"refs": [{"id": "ref-for-text-directive-end"}], "title": "3.4. Text Directives"}, {"refs": [{"id": "ref-for-text-directive-end\u2460"}, {"id": "ref-for-text-directive-end\u2461"}, {"id": "ref-for-text-directive-end\u2462"}, {"id": "ref-for-text-directive-end\u2463"}, {"id": "ref-for-text-directive-end\u2464"}, {"id": "ref-for-text-directive-end\u2465"}, {"id": "ref-for-text-directive-end\u2466"}, {"id": "ref-for-text-directive-end\u2467"}, {"id": "ref-for-text-directive-end\u2468"}, {"id": "ref-for-text-directive-end\u2460\u24ea"}, {"id": "ref-for-text-directive-end\u2460\u2460"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['text-directive-prefix'] = {"dfnID": "text-directive-prefix", "url": "#text-directive-prefix", "dfnText": "prefix", "refSections": [{"refs": [{"id": "ref-for-text-directive-prefix"}], "title": "3.4. Text Directives"}, {"refs": [{"id": "ref-for-text-directive-prefix\u2460"}, {"id": "ref-for-text-directive-prefix\u2461"}, {"id": "ref-for-text-directive-prefix\u2462"}, {"id": "ref-for-text-directive-prefix\u2463"}, {"id": "ref-for-text-directive-prefix\u2464"}, {"id": "ref-for-text-directive-prefix\u2465"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['text-directive-suffix'] = {"dfnID": "text-directive-suffix", "url": "#text-directive-suffix", "dfnText": "suffix", "refSections": [{"refs": [{"id": "ref-for-text-directive-suffix"}], "title": "3.4. Text Directives"}, {"refs": [{"id": "ref-for-text-directive-suffix\u2460"}, {"id": "ref-for-text-directive-suffix\u2461"}, {"id": "ref-for-text-directive-suffix\u2462"}, {"id": "ref-for-text-directive-suffix\u2463"}, {"id": "ref-for-text-directive-suffix\u2464"}, {"id": "ref-for-text-directive-suffix\u2465"}, {"id": "ref-for-text-directive-suffix\u2466"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['parse-a-text-directive'] = {"dfnID": "parse-a-text-directive", "url": "#parse-a-text-directive", "dfnText": "parse a text directive", "refSections": [{"refs": [{"id": "ref-for-parse-a-text-directive"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['request-text-directive-user-activation'] = {"dfnID": "request-text-directive-user-activation", "url": "#request-text-directive-user-activation", "dfnText": "text directive user activation", "refSections": [{"refs": [{"id": "ref-for-request-text-directive-user-activation"}, {"id": "ref-for-request-text-directive-user-activation\u2460"}, {"id": "ref-for-request-text-directive-user-activation\u2461"}, {"id": "ref-for-request-text-directive-user-activation\u2462"}, {"id": "ref-for-request-text-directive-user-activation\u2463"}], "title": "3.5.4. Restricting the Text Fragment"}], "external": false};
window.dfnpanelData['document-text-directive-user-activation'] = {"dfnID": "document-text-directive-user-activation", "url": "#document-text-directive-user-activation", "dfnText": "text directive user activation", "refSections": [{"refs": [{"id": "ref-for-document-text-directive-user-activation"}, {"id": "ref-for-document-text-directive-user-activation\u2460"}, {"id": "ref-for-document-text-directive-user-activation\u2461"}, {"id": "ref-for-document-text-directive-user-activation\u2462"}, {"id": "ref-for-document-text-directive-user-activation\u2463"}, {"id": "ref-for-document-text-directive-user-activation\u2464"}, {"id": "ref-for-document-text-directive-user-activation\u2465"}, {"id": "ref-for-document-text-directive-user-activation\u2466"}, {"id": "ref-for-document-text-directive-user-activation\u2467"}, {"id": "ref-for-document-text-directive-user-activation\u2468"}, {"id": "ref-for-document-text-directive-user-activation\u2460\u24ea"}, {"id": "ref-for-document-text-directive-user-activation\u2460\u2460"}, {"id": "ref-for-document-text-directive-user-activation\u2460\u2461"}], "title": "3.5.4. Restricting the Text Fragment"}], "external": false};
window.dfnpanelData['document-allow-text-fragment-scroll'] = {"dfnID": "document-allow-text-fragment-scroll", "url": "#document-allow-text-fragment-scroll", "dfnText": "allow text fragment scroll", "refSections": [{"refs": [{"id": "ref-for-document-allow-text-fragment-scroll"}], "title": "3.4.1. Invoking Text Directives"}, {"refs": [{"id": "ref-for-document-allow-text-fragment-scroll\u2460"}, {"id": "ref-for-document-allow-text-fragment-scroll\u2461"}, {"id": "ref-for-document-allow-text-fragment-scroll\u2462"}, {"id": "ref-for-document-allow-text-fragment-scroll\u2463"}, {"id": "ref-for-document-allow-text-fragment-scroll\u2464"}, {"id": "ref-for-document-allow-text-fragment-scroll\u2465"}, {"id": "ref-for-document-allow-text-fragment-scroll\u2466"}, {"id": "ref-for-document-allow-text-fragment-scroll\u2467"}, {"id": "ref-for-document-allow-text-fragment-scroll\u2468"}, {"id": "ref-for-document-allow-text-fragment-scroll\u2460\u24ea"}], "title": "3.5.4. Restricting the Text Fragment"}], "external": false};
window.dfnpanelData['user-involvement'] = {"dfnID": "user-involvement", "url": "#user-involvement", "dfnText": "user involvement", "refSections": [{"refs": [{"id": "ref-for-user-involvement"}, {"id": "ref-for-user-involvement\u2460"}, {"id": "ref-for-user-involvement\u2461"}, {"id": "ref-for-user-involvement\u2462"}], "title": "3.5.4. Restricting the Text Fragment"}], "external": false};
window.dfnpanelData['first-common-ancestor'] = {"dfnID": "first-common-ancestor", "url": "#first-common-ancestor", "dfnText": "first common ancestor", "refSections": [{"refs": [{"id": "ref-for-first-common-ancestor"}], "title": "3.4.1. Invoking Text Directives"}], "external": false};
window.dfnpanelData['shadow-including-parent'] = {"dfnID": "shadow-including-parent", "url": "#shadow-including-parent", "dfnText": "shadow-including parent", "refSections": [{"refs": [{"id": "ref-for-shadow-including-parent"}], "title": "3.6. Navigating to a Text Fragment"}], "external": false};
window.dfnpanelData['invoke-text-directives'] = {"dfnID": "invoke-text-directives", "url": "#invoke-text-directives", "dfnText": "invoke text directives", "refSections": [{"refs": [{"id": "ref-for-invoke-text-directives"}], "title": "3.4.1. Invoking Text Directives"}, {"refs": [{"id": "ref-for-invoke-text-directives\u2460"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['find-a-range-from-a-text-directive'] = {"dfnID": "find-a-range-from-a-text-directive", "url": "#find-a-range-from-a-text-directive", "dfnText": "find a range from a text directive", "refSections": [{"refs": [{"id": "ref-for-find-a-range-from-a-text-directive"}], "title": "3.5.3. Search Timing"}, {"refs": [{"id": "ref-for-find-a-range-from-a-text-directive\u2460"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['next-non-whitespace-position'] = {"dfnID": "next-non-whitespace-position", "url": "#next-non-whitespace-position", "dfnText": "next\nnon-whitespace position", "refSections": [{"refs": [{"id": "ref-for-next-non-whitespace-position"}, {"id": "ref-for-next-non-whitespace-position\u2460"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['find-a-string-in-range'] = {"dfnID": "find-a-string-in-range", "url": "#find-a-string-in-range", "dfnText": "find a string in range", "refSections": [{"refs": [{"id": "ref-for-find-a-string-in-range"}, {"id": "ref-for-find-a-string-in-range\u2460"}, {"id": "ref-for-find-a-string-in-range\u2461"}, {"id": "ref-for-find-a-string-in-range\u2462"}, {"id": "ref-for-find-a-string-in-range\u2463"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['search-invisible'] = {"dfnID": "search-invisible", "url": "#search-invisible", "dfnText": "search invisible", "refSections": [{"refs": [{"id": "ref-for-search-invisible"}, {"id": "ref-for-search-invisible\u2460"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['non-searchable-subtree'] = {"dfnID": "non-searchable-subtree", "url": "#non-searchable-subtree", "dfnText": "non-searchable subtree", "refSections": [{"refs": [{"id": "ref-for-non-searchable-subtree"}, {"id": "ref-for-non-searchable-subtree\u2460"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['visible-text-node'] = {"dfnID": "visible-text-node", "url": "#visible-text-node", "dfnText": "visible text node", "refSections": [{"refs": [{"id": "ref-for-visible-text-node"}, {"id": "ref-for-visible-text-node\u2460"}, {"id": "ref-for-visible-text-node\u2461"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['has-block-level-display'] = {"dfnID": "has-block-level-display", "url": "#has-block-level-display", "dfnText": "has block-level display", "refSections": [{"refs": [{"id": "ref-for-has-block-level-display"}, {"id": "ref-for-has-block-level-display\u2460"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['nearest-block-ancestor'] = {"dfnID": "nearest-block-ancestor", "url": "#nearest-block-ancestor", "dfnText": "nearest block ancestor", "refSections": [{"refs": [{"id": "ref-for-nearest-block-ancestor"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['find-a-range-from-a-node-list'] = {"dfnID": "find-a-range-from-a-node-list", "url": "#find-a-range-from-a-node-list", "dfnText": "find a range from a node list", "refSections": [{"refs": [{"id": "ref-for-find-a-range-from-a-node-list"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['get-boundary-point-at-index'] = {"dfnID": "get-boundary-point-at-index", "url": "#get-boundary-point-at-index", "dfnText": "get boundary point at index", "refSections": [{"refs": [{"id": "ref-for-get-boundary-point-at-index"}, {"id": "ref-for-get-boundary-point-at-index\u2460"}], "title": "3.6.1. Finding Ranges in a Document"}], "external": false};
window.dfnpanelData['word-boundary'] = {"dfnID": "word-boundary", "url": "#word-boundary", "dfnText": "word boundary", "refSections": [{"refs": [{"id": "ref-for-word-boundary"}], "title": "3.6.1. Finding Ranges in a Document"}, {"refs": [{"id": "ref-for-word-boundary\u2460"}], "title": "3.6.2. Word Boundaries"}], "external": false};
window.dfnpanelData['locale'] = {"dfnID": "locale", "url": "#locale", "dfnText": "locale", "refSections": [{"refs": [{"id": "ref-for-locale"}, {"id": "ref-for-locale\u2460"}], "title": "3.6.2. Word Boundaries"}], "external": false};
window.dfnpanelData['word-bounded'] = {"dfnID": "word-bounded", "url": "#word-bounded", "dfnText": "word bounded", "refSections": [{"refs": [{"id": "ref-for-word-bounded"}], "title": "3.6.2. Word Boundaries"}], "external": false};
window.dfnpanelData['is-at-a-word-boundary'] = {"dfnID": "is-at-a-word-boundary", "url": "#is-at-a-word-boundary", "dfnText": "is at a word boundary", "refSections": [{"refs": [{"id": "ref-for-is-at-a-word-boundary"}, {"id": "ref-for-is-at-a-word-boundary\u2460"}], "title": "3.6.1. Finding Ranges in a Document"}, {"refs": [{"id": "ref-for-is-at-a-word-boundary\u2461"}, {"id": "ref-for-is-at-a-word-boundary\u2462"}], "title": "3.6.2. Word Boundaries"}], "external": false};
window.dfnpanelData['fragmentdirective'] = {"dfnID": "fragmentdirective", "url": "#fragmentdirective", "dfnText": "FragmentDirective", "refSections": [{"refs": [{"id": "ref-for-fragmentdirective"}], "title": "3.9. Feature Detectability"}], "external": false};
</script>
<script>/* Boilerplate: script-dom-helper */
function query(sel) { return document.querySelector(sel); }

function queryAll(sel) { return [...document.querySelectorAll(sel)]; }

function iter(obj) {
	if(!obj) return [];
	var it = obj[Symbol.iterator];
	if(it) return it;
	return Object.entries(obj);
}

function mk(tagname, attrs, ...children) {
	const el = document.createElement(tagname);
	for(const [k,v] of iter(attrs)) {
		if(k.slice(0,3) == "_on") {
			const eventName = k.slice(3);
			el.addEventListener(eventName, v);
		} else if(k[0] == "_") {
			// property, not attribute
			el[k.slice(1)] = v;
		} else {
			if(v === false || v == null) {
        continue;
      } else if(v === true) {
        el.setAttribute(k, "");
        continue;
      } else {
  			el.setAttribute(k, v);
      }
		}
	}
	append(el, children);
	return el;
}

/* Create shortcuts for every known HTML element */
[
  "a",
  "abbr",
  "acronym",
  "address",
  "applet",
  "area",
  "article",
  "aside",
  "audio",
  "b",
  "base",
  "basefont",
  "bdo",
  "big",
  "blockquote",
  "body",
  "br",
  "button",
  "canvas",
  "caption",
  "center",
  "cite",
  "code",
  "col",
  "colgroup",
  "datalist",
  "dd",
  "del",
  "details",
  "dfn",
  "dialog",
  "div",
  "dl",
  "dt",
  "em",
  "embed",
  "fieldset",
  "figcaption",
  "figure",
  "font",
  "footer",
  "form",
  "frame",
  "frameset",
  "head",
  "header",
  "h1",
  "h2",
  "h3",
  "h4",
  "h5",
  "h6",
  "hr",
  "html",
  "i",
  "iframe",
  "img",
  "input",
  "ins",
  "kbd",
  "label",
  "legend",
  "li",
  "link",
  "main",
  "map",
  "mark",
  "meta",
  "meter",
  "nav",
  "nobr",
  "noscript",
  "object",
  "ol",
  "optgroup",
  "option",
  "output",
  "p",
  "param",
  "pre",
  "progress",
  "q",
  "s",
  "samp",
  "script",
  "section",
  "select",
  "small",
  "source",
  "span",
  "strike",
  "strong",
  "style",
  "sub",
  "summary",
  "sup",
  "table",
  "tbody",
  "td",
  "template",
  "textarea",
  "tfoot",
  "th",
  "thead",
  "time",
  "title",
  "tr",
  "u",
  "ul",
  "var",
  "video",
  "wbr",
  "xmp",
].forEach(tagname=>{
	mk[tagname] = (...args) => mk(tagname, ...args);
});

function* nodesFromChildList(children) {
	for(const child of children.flat(Infinity)) {
		if(child instanceof Node) {
			yield child;
		} else {
			yield new Text(child);
		}
	}
}
function append(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		if(el instanceof Node) el.appendChild(child);
		else el.push(child);
	}
	return el;
}

function insertAfter(el, ...children) {
	for(const child of nodesFromChildList(children)) {
		el.parentNode.insertBefore(child, el.nextSibling);
	}
	return el;
}

function clearContents(el) {
	el.innerHTML = "";
	return el;
}

function parseHTML(markup) {
	if(markup.toLowerCase().trim().indexOf('<!doctype') === 0) {
		const doc = document.implementation.createHTMLDocument("");
		doc.documentElement.innerHTML = markup;
		return doc;
	} else {
		const el = mk.template({});
		el.innerHTML = markup;
		return el.content;
	}
}
</script>
<script>/* Boilerplate: script-var-click-highlighting */
/*
Color-choosing design:

Colors are ordered by goodness.
Each color has a usage count (initially zero).
Each variable has a last-used color.

* If the var has a last-used color, and that color's usage is 0,
    return that color.
* Otherwise, return the lowest-indexed color with the lowest usage.
    Increment the color's usage and set it as the last-used color
    for that var.
* On unclicking, decrement usage of the color.
*/
"use strict";
{
    document.addEventListener("click", e=>{
        if(e.target.nodeName == "VAR") {
            highlightSameAlgoVars(e.target);
        }
    });
    const indexCounts = new Map();
    const indexNames = new Map();
    function highlightSameAlgoVars(v) {
        // Find the algorithm container.
        let algoContainer = null;
        let searchEl = v;
        while(algoContainer == null && searchEl != document.body) {
            searchEl = searchEl.parentNode;
            if(searchEl.hasAttribute("data-algorithm")) {
                algoContainer = searchEl;
            }
        }

        // Not highlighting document-global vars,
        // too likely to be unrelated.
        if(algoContainer == null) return;

        const algoName = algoContainer.getAttribute("data-algorithm");
        const varName = getVarName(v);
        const addClass = !v.classList.contains("selected");
        let highlightClass = null;
        if(addClass) {
            const index = chooseHighlightIndex(algoName, varName);
            indexCounts.get(algoName)[index] += 1;
            indexNames.set(algoName+"///"+varName, index);
            highlightClass = nameFromIndex(index);
        } else {
            const index = previousHighlightIndex(algoName, varName);
            indexCounts.get(algoName)[index] -= 1;
            highlightClass = nameFromIndex(index);
        }

        // Find all same-name vars, and toggle their class appropriately.
        for(const el of algoContainer.querySelectorAll("var")) {
            if(getVarName(el) == varName) {
                el.classList.toggle("selected", addClass);
                el.classList.toggle(highlightClass, addClass);
            }
        }
    }
    function getVarName(el) {
        return el.textContent.replace(/(\s|\xa0)+/, " ").trim();
    }
    function chooseHighlightIndex(algoName, varName) {
        let indexes = null;
        if(indexCounts.has(algoName)) {
            indexes = indexCounts.get(algoName);
        } else {
            // 7 classes right now
            indexes = [0,0,0,0,0,0,0];
            indexCounts.set(algoName, indexes);
        }

        // If the element was recently unclicked,
        // *and* that color is still unclaimed,
        // give it back the same color.
        const lastIndex = previousHighlightIndex(algoName, varName);
        if(indexes[lastIndex] === 0) return lastIndex;

        // Find the earliest index with the lowest count.
        const minCount = Math.min.apply(null, indexes);
        let index = null;
        for(var i = 0; i < indexes.length; i++) {
            if(indexes[i] == minCount) {
                return i;
            }
        }
    }
    function previousHighlightIndex(algoName, varName) {
        return indexNames.get(algoName+"///"+varName);
    }
    function nameFromIndex(index) {
        return "selected" + index;
    }
}
</script>
<script>/* Boilerplate: script-wpt */
let wptPath = "/scroll-to-text-fragment/";
"use strict";

document.addEventListener("DOMContentLoaded", async ()=>{
    if(wptPath == "/") return;

    const runsUrl = "https://wpt.fyi/api/runs?label=master&label=stable&max-count=1&product=chrome&product=firefox&product=safari&product=edge";
    const runs = await (await fetch(runsUrl)).json();

    const testResults = await (await fetch("https://wpt.fyi/api/search", {
        method:"POST",
        headers:{
            "Content-Type":"application/json",
        },
        body: JSON.stringify({
            "run_ids": runs.map(x=>x.id),
            "query": {"path": wptPath},
        })
    })).json();

    const browsers = runs.map(x=>({name:x.browser_name, version:x.browser_version, passes:0, total: 0}));
    const resultsFromPath = new Map(testResults.results.map(result=>{
        const testPath = result.test;
        const passes = result.legacy_status.map(x=>[x.passes, x.total]);
        return [testPath, passes];
    }));
    const seenTests = new Set();
    document.querySelectorAll(".wpt-name").forEach(nameEl=>{
        const passData = resultsFromPath.get("/" + nameEl.getAttribute("title"));
        if(!passData) {
            console.log("Couldn't find test in results:", nameEl);
            return
        }
        const numTests = passData[0][1];
        if(numTests > 1) {
            nameEl.insertAdjacentElement("beforeend",
                el("small", {}, ` (${numTests} tests)`));
        }
        if(passData == undefined) return;
        const resultsEl = el("span",{"class":"wpt-results"},
            ...passData.map((p,i) => el("span",
            {
                "title": `${browsers[i].name} ${p[0]}/${p[1]}`,
                "class": "wpt-result",
                "style": `background: conic-gradient(forestgreen ${p[0]/p[1]*360}deg, darkred 0deg);`,
            })),
        );
        nameEl.insertAdjacentElement("afterend", resultsEl);

        // Only update the summary pass/total count if we haven't seen this
        // test before, to support authors listing the same test multiple times
        // in a spec.
        if (!seenTests.has(nameEl.getAttribute("title"))) {
            seenTests.add(nameEl.getAttribute("title"));
            passData.forEach((p,i) => {
                browsers[i].passes += p[0];
                browsers[i].total += p[1];
            });
        }
    });
    const overview = document.querySelector(".wpt-overview");
    if(overview) {
        overview.appendChild(el('ul',{}, ...browsers.map(formatWptResult)));
        document.head.appendChild(el('style', {},
            `.wpt-overview ul { display: flex; flex-flow: row wrap; gap: .2em; justify-content: start; list-style: none; padding: 0; margin: 0;}
             .wpt-overview li { padding: .25em 1em; color: black; text-align: center; }
             .wpt-overview img { height: 1.5em; height: max(1.5em, 32px); background: transparent; }
             .wpt-overview .browser { font-weight: bold; }
             .wpt-overview .passes-none { background: #e57373; }
             .wpt-overview .passes-hardly { background: #ffb74d; }
             .wpt-overview .passes-a-few { background: #ffd54f; }
             .wpt-overview .passes-half { background: #fff176; }
             .wpt-overview .passes-lots { background: #dce775; }
             .wpt-overview .passes-most { background: #aed581; }
             .wpt-overview .passes-all { background: #81c784; }`));
    }
});
function el(name, attrs, ...content) {
    const x = document.createElement(name);
    for(const [k,v] of Object.entries(attrs)) {
        x.setAttribute(k, v);
    }
    for(let child of content) {
        if(typeof child == "string") child = document.createTextNode(child);
        try {
        x.appendChild(child);
        } catch(e) { console.log({x, child}); }
    }
    return x;
}
function formatWptResult({name, version, passes, total}) {
    const passRate = passes/total;
    let passClass = "";
    if(passRate == 0)      passClass = "passes-none";
    else if(passRate < .2) passClass = "passes-hardly";
    else if(passRate < .4) passClass = "passes-a-few";
    else if(passRate < .6) passClass = "passes-half";
    else if(passRate < .8) passClass = "passes-lots";
    else if(passRate < 1)  passClass = "passes-most";
    else                   passClass = "passes-all";

    name = name[0].toUpperCase() + name.slice(1);
    const shortVersion = /^\d+/.exec(version);
    const icon = []

    if(name == "Chrome") icon.push(el('img', {alt:"", src:"https://wpt.fyi/static/chrome_64x64.png"}));
    if(name == "Edge") icon.push(el('img', {alt:"", src:"https://wpt.fyi/static/edge_64x64.png"}));
    if(name == "Safari") icon.push(el('img', {alt:"", src:"https://wpt.fyi/static/safari_64x64.png"}));
    if(name == "Firefox") icon.push(el('img', {alt:"", src:"https://wpt.fyi/static/firefox_64x64.png"}));

    return el('li', {"class":passClass},
        el('nobr', {'class':'browser'}, ...icon, ` ${name} ${shortVersion}`),
        el('br', {}),
        el('nobr', {'class':'pass-rate'}, `${passes}/${total}`)
    );
}
</script>